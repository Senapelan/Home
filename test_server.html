<!DOCTYPE html>
<html lang="id">
<head>
    <!-- Open Graph utama -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://senapelan.github.io/Home/publik/updater-informasi/updatev2.0.html">
    <meta property="og:title" content="Senapelan Satu Pintu - Layanan Digital Kecamatan & Kelurahan">
    <meta property="og:description" content="Informasi Real-time Kegiatan Kecamatan Senapelan dan Seluruh Kelurahan">
    <meta property="og:site_name" content="Senapelan Satu Pintu">
    
    <!-- Gambar preview -->
    <meta property="og:image" content="https://senapelan.github.io/Home/data/foto/updatelogo.png">
    <meta property="og:image:secure_url" content="https://senapelan.github.io/Home/data/foto/updatelogo.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="1200">
    
    <!-- Twitter / X -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Senapelan Satu Pintu - Informasi Kegiatan Real-time">
    <meta name="twitter:description" content="Update kegiatan Kecamatan Senapelan dan 6 Kelurahan">
    <meta name="twitter:image" content="https://senapelan.github.io/Home/data/foto/updatelogo.png">
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5">
    <title>Senapelan Update · Kegiatan & Acara</title>

    <!-- FAVICON -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://senapelan.github.io/Home/data/foto/favico/favico.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* ========== RESET & VARIABLES ========== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #0f2b3d;
            --primary-light: #1e4a6b;
            --accent: #e11d48;
            --accent-light: #fb7185;
            --success: #10b981;
            --success-dark: #059669;
            --warning: #f59e0b;
            --warning-dark: #d97706;
            --gray: #64748b;
            --gray-light: #f1f5f9;
            --gray-dark: #334155;
            --border-radius: 28px;
            --border-radius-sm: 18px;
            --shadow: 0 15px 35px -12px rgba(0,20,30,0.12);
            --shadow-hover: 0 24px 44px -14px rgba(0,55,80,0.18);
        }

        body {
            background: linear-gradient(145deg, #f6f9fc 0%, #edf2f7 100%);
            font-family: 'Inter', sans-serif;
            padding: 32px 24px;
            min-height: 100vh;
            color: #1e293b;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
        }

        /* ========== HEADER SECTION ========== */
        .header {
            margin-bottom: 40px;
            background: white;
            border-radius: var(--border-radius);
            padding: 28px 32px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255,255,255,0.6);
        }

        .header h1 {
            font-size: 2.2rem;
            font-weight: 800;
            background: linear-gradient(145deg, var(--primary), var(--primary-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            border-left: 8px solid var(--accent);
            padding-left: 24px;
            line-height: 1.2;
            letter-spacing: -0.5px;
        }

        .subhead {
            display: flex;
            justify-content: space-between;
            margin-left: 32px;
            margin-top: 16px;
            color: #4b5e6b;
            flex-wrap: wrap;
            gap: 16px;
        }

        .live-badge {
            background: var(--success);
            color: white;
            padding: 8px 20px;
            border-radius: 60px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(16,185,129,0.25);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.9; transform: scale(0.98); }
            100% { opacity: 1; }
        }

        .last-update {
            font-size: 0.85rem;
            color: var(--gray);
            margin-left: 32px;
            margin-top: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.5);
            padding: 8px 16px;
            border-radius: 60px;
            width: fit-content;
        }

        /* ========== FILTER & CONTROLS ========== */
        .filter-section {
            background: white;
            border-radius: 60px;
            padding: 20px 28px;
            margin-bottom: 32px;
            box-shadow: var(--shadow);
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }

        .filter-group {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 16px;
        }

        .filter-label {
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }

        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .filter-btn {
            padding: 8px 20px;
            border-radius: 60px;
            border: 1px solid #e2e8f0;
            background: white;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--gray-dark);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-btn:hover {
            background: var(--gray-light);
            border-color: var(--gray);
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .filter-btn.active img {
            border: 2px solid white;
        }

        .filter-btn img {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            object-fit: cover;
        }

        .entry-control {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--gray-light);
            padding: 4px;
            border-radius: 60px;
        }

        .entry-select {
            padding: 10px 20px;
            border-radius: 60px;
            border: 1px solid #e2e8f0;
            background: white;
            font-weight: 600;
            color: var(--primary);
            cursor: pointer;
            outline: none;
        }

        /* ========== STATUS BADGES ========== */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 18px;
            border-radius: 60px;
            font-weight: 700;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-berlangsung {
            background: var(--success);
            color: white;
            box-shadow: 0 4px 12px rgba(16,185,129,0.3);
        }

        .status-akan-datang {
            background: var(--warning);
            color: white;
            box-shadow: 0 4px 12px rgba(245,158,11,0.3);
        }

        .status-selesai {
            background: var(--gray);
            color: white;
            box-shadow: 0 4px 12px rgba(100,116,139,0.3);
        }

        .countdown-timer {
            background: rgba(0,0,0,0.15);
            padding: 4px 12px;
            border-radius: 60px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-left: 8px;
        }

        /* ========== CARDS GRID ========== */
        .section-title {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 40px 0 24px 0;
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(225,29,72,0.2);
        }

        .section-title h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .section-title span {
            background: var(--accent);
            color: white;
            padding: 4px 16px;
            border-radius: 60px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .news-feed {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 100%;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.6);
            transition: all 0.25s ease;
            position: relative;
        }

        .card.berlangsung {
            border-left: 8px solid var(--success);
            background: linear-gradient(to right, rgba(16,185,129,0.02), white);
        }

        .card.akan-datang {
            border-left: 8px solid var(--warning);
            background: linear-gradient(to right, rgba(245,158,11,0.02), white);
        }

        .card.selesai {
            opacity: 0.9;
            background: #f8fafc;
            border-left: 8px solid var(--gray);
        }

        .card:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }

        .status-ribbon {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
        }

        .card-preview {
            display: flex;
            align-items: center;
            padding: 20px 24px;
            gap: 20px;
            cursor: pointer;
        }

        .thumbnail {
            width: 90px;
            height: 90px;
            flex-shrink: 0;
            background: var(--gray-light);
            border-radius: var(--border-radius-sm);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 16px rgba(0,0,0,0.04);
        }

        .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-content {
            flex: 1;
        }

        .news-badge {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .instansi-badge {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--primary);
            background: rgba(15,43,61,0.08);
            padding: 6px 16px;
            border-radius: 60px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .judul-preview {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .excerpt-text {
            font-size: 0.9rem;
            color: var(--gray-dark);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--gray-light);
            padding: 6px 14px;
            border-radius: 60px;
            width: fit-content;
            max-width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .excerpt-text i {
            color: var(--accent);
            font-size: 0.8rem;
        }

        .meta-sumber {
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 0.8rem;
            color: #4f6f7f;
        }

        .arrow-toggle {
            width: 48px;
            height: 48px;
            background: var(--gray-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            color: var(--primary);
        }

        .card.expanded .arrow-toggle {
            transform: rotate(180deg);
            background: var(--primary);
            color: white;
        }

        .card-detail {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: all 0.45s cubic-bezier(0.23, 1, 0.32, 1);
            background: white;
        }

        .card.expanded .card-detail {
            max-height: 2000px;
            opacity: 1;
            padding: 24px 28px 32px;
            border-top: 1px solid rgba(168,192,207,0.2);
        }

        .isi-konten {
            font-size: 1rem;
            line-height: 1.65;
            color: #1f3a4b;
            background: var(--gray-light);
            padding: 24px;
            border-radius: 20px;
            margin-bottom: 24px;
            white-space: pre-line;
        }

        .foto-konten {
            margin: 24px 0;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .foto-konten img {
            width: 100%;
            max-height: 500px;
            object-fit: contain;
            background: #f1f5f9;
        }

        .info-section {
            background: var(--gray-light);
            border-radius: 20px;
            padding: 20px 24px;
            margin-bottom: 20px;
        }

        .info-row {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 16px;
        }

        .info-row:last-child {
            margin-bottom: 0;
        }

        .info-icon {
            width: 28px;
            color: var(--accent);
            flex-shrink: 0;
        }

        .info-label {
            font-size: 0.75rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .alamat-text {
            font-weight: 600;
            color: var(--primary);
            font-size: 1rem;
        }

        .time-display {
            display: flex;
            align-items: baseline;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 24px;
        }

        .date-badge, .time-badge {
            padding: 10px 20px;
            border-radius: 100px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        }

        .date-badge {
            color: var(--primary);
        }

        .time-badge {
            background: #f1f9ff;
            color: #0369a1;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-top: 24px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            padding: 14px 28px;
            border-radius: 60px;
            font-weight: 700;
            font-size: 0.95rem;
            text-decoration: none;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }

        .btn i {
            font-size: 1rem;
        }

        .btn-pdf {
            background: var(--primary);
            color: white;
            box-shadow: 0 8px 18px rgba(15,43,61,0.2);
        }

        .btn-pdf:hover {
            background: var(--primary-light);
            transform: scale(0.98);
        }

        .btn-map {
            background: var(--accent);
            color: white;
            box-shadow: 0 8px 18px rgba(225,29,72,0.2);
        }

        .btn-map:hover {
            background: #be123c;
            transform: scale(0.98);
        }

        .pagination-info {
            margin-top: 40px;
            text-align: center;
            color: var(--gray);
            font-size: 0.9rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            background: white;
            padding: 16px 24px;
            border-radius: 60px;
            box-shadow: var(--shadow);
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            background: white;
            border-radius: 60px;
            color: var(--gray);
            box-shadow: var(--shadow);
        }

        footer {
            margin-top: 60px;
            text-align: center;
            color: #7c8f99;
            padding-top: 30px;
            border-top: 1px solid rgba(0,0,0,0.04);
        }

        @media (max-width: 768px) {
            body { padding: 20px 16px; }
            .header h1 { font-size: 1.6rem; }
            .header { padding: 20px; }
            .subhead { margin-left: 16px; }
            .filter-section { border-radius: 24px; padding: 20px; }
            .card-preview { flex-direction: column; align-items: flex-start; }
            .thumbnail { width: 100%; height: 160px; }
            .excerpt-text { white-space: normal; width: 100%; }
            .button-group { flex-direction: column; }
            .btn { justify-content: center; }
            .status-ribbon { position: static; margin-bottom: 16px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1>UPDATE KEGIATAN<br>SENAPELAN & 6 KELURAHAN</h1>
            <div class="subhead">
                <span><i class="fas fa-map-pin" style="color:#e11d48;"></i> Sumber: Senapelan Satu Pintu</span>
                <span class="live-badge"><i class="fas fa-circle"></i> LIVE UPDATE</span>
            </div>
            <div class="last-update" id="lastUpdate">
                <i class="fas fa-sync-alt"></i> Menyambung ke server...
            </div>
        </div>

        <!-- FILTER SECTION -->
        <div class="filter-section">
            <div class="filter-group">
                <span class="filter-label"><i class="fas fa-filter"></i> Filter Instansi:</span>
                <div class="filter-buttons" id="filterButtons">
                    <button class="filter-btn active" data-filter="all"><i class="fas fa-building"></i> Semua</button>
                    <button class="filter-btn" data-filter="Kecamatan Senapelan"><img src="https://senapelan.github.io/Home/data/foto/imgkegiatan/senapelan.png" alt=""> Senapelan</button>
                    <button class="filter-btn" data-filter="Kelurahan Kampung Bandar"><img src="https://senapelan.github.io/Home/data/foto/imgkegiatan/kampungbandar.png" alt=""> Kampung Bandar</button>
                    <button class="filter-btn" data-filter="Kelurahan Kampung Baru"><img src="https://senapelan.github.io/Home/data/foto/imgkegiatan/kampungbaru.png" alt=""> Kampung Baru</button>
                    <button class="filter-btn" data-filter="Kelurahan Kampung Dalam"><img src="https://senapelan.github.io/Home/data/foto/imgkegiatan/kampungdalam.png" alt=""> Kampung Dalam</button>
                    <button class="filter-btn" data-filter="Kelurahan Padang Bulan"><img src="https://senapelan.github.io/Home/data/foto/imgkegiatan/padangbulan.png" alt=""> Padang Bulan</button>
                    <button class="filter-btn" data-filter="Kelurahan Padang Terubuk"><img src="https://senapelan.github.io/Home/data/foto/imgkegiatan/padangterubuk.png" alt=""> Padang Terubuk</button>
                    <button class="filter-btn" data-filter="Kelurahan Sago"><img src="https://senapelan.github.io/Home/data/foto/imgkegiatan/sago.png" alt=""> Sago</button>
                </div>
            </div>
            <div class="entry-control">
                <i class="fas fa-list-ul" style="color: var(--gray);"></i>
                <select id="entrySelect" class="entry-select">
                    <option value="100" selected>100 Card</option>
                    <option value="500">500 Card</option>
                    <option value="1000">1000 Card</option>
                </select>
            </div>
        </div>

        <!-- NEWS FEED -->
        <div id="newsFeed" class="news-feed">
            <div class="loading">
                <i class="fas fa-spinner fa-pulse fa-2x" style="color: var(--primary);"></i>
                <p style="margin-top: 16px; color: var(--primary);">Memuat data terbaru...</p>
            </div>
        </div>
        
        <!-- PAGINATION INFO -->
        <div id="paginationInfo" class="pagination-info"></div>

        <footer>
            <i class="fas fa-bolt"></i> Update setiap 5 detik · Senapelan Satu Pintu · v2.1
        </footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
    // ===========================================
    // KONFIGURASI APPS SCRIPT
    // ===========================================
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzYnfxLi8ViBeYRQmRvEYn2fiDYJHbV5zCDGpJ5YPzNB7ez8dE9G-BIS6jzCZ61CmHMGQ/exec';
    
    // ===========================================
    // DEFAULT THUMBNAILS UNTUK CARD TERTUTUP
    // ===========================================
    const DEFAULT_THUMBNAILS = {
        'Kecamatan Senapelan': 'https://senapelan.github.io/Home/data/foto/imgkegiatan/senapelan.png',
        'Kelurahan Kampung Bandar': 'https://senapelan.github.io/Home/data/foto/imgkegiatan/kampungbandar.png',
        'Kelurahan Kampung Baru': 'https://senapelan.github.io/Home/data/foto/imgkegiatan/kampungbaru.png',
        'Kelurahan Kampung Dalam': 'https://senapelan.github.io/Home/data/foto/imgkegiatan/kampungdalam.png',
        'Kelurahan Padang Bulan': 'https://senapelan.github.io/Home/data/foto/imgkegiatan/padangbulan.png',
        'Kelurahan Padang Terubuk': 'https://senapelan.github.io/Home/data/foto/imgkegiatan/padangterubuk.png',
        'Kelurahan Sago': 'https://senapelan.github.io/Home/data/foto/imgkegiatan/sago.png'
    };
    
    // ===========================================
    // FOTO DEFAULT UNTUK KONTEN (JIKA TIDAK ADA LINK)
    // ===========================================
    const FALLBACK_IMAGE = 'https://senapelan.github.io/Home/data/foto/updatelogo.png';

    // ===========================================
    // STATE MANAGEMENT
    // ===========================================
    let expandedCardId = null;
    let retryCount = 0;
    const MAX_RETRY = 3;
    const STORAGE_KEY = 'senapelan_expanded_card_v2';
    let allData = [];
    let currentFilter = 'all';
    let currentEntry = 100;
    
    // ===========================================
    // STORAGE FUNCTIONS
    // ===========================================
    function saveExpandedCard(cardId) {
        try {
            if (cardId) {
                localStorage.setItem(STORAGE_KEY, cardId);
                expandedCardId = cardId;
            } else {
                localStorage.removeItem(STORAGE_KEY);
                expandedCardId = null;
            }
        } catch (e) { console.log('Storage error:', e); }
    }
    
    function getSavedExpandedCard() {
        try { return localStorage.getItem(STORAGE_KEY); } catch { return null; }
    }

    // ===========================================
    // STATUS & COUNTDOWN FUNCTIONS
    // ===========================================
    function getStatusAcara(tglMulai, waktuMulai, tglSelesai, waktuSelesai) {
        if (!tglMulai || !waktuMulai) return 'selesai';
        
        try {
            const sekarang = new Date();
            const [tglMulaiObj, tglSelesaiObj] = parseDates(tglMulai, waktuMulai, tglSelesai, waktuSelesai);
            
            if (!tglMulaiObj) return 'selesai';
            
            if (tglSelesaiObj && sekarang > tglSelesaiObj) return 'selesai';
            if (sekarang >= tglMulaiObj && (!tglSelesaiObj || sekarang <= tglSelesaiObj)) return 'berlangsung';
            if (sekarang < tglMulaiObj) return 'akan-datang';
            
            return 'selesai';
        } catch (e) {
            console.log('Error get status:', e);
            return 'selesai';
        }
    }

    function parseDates(tglMulai, waktuMulai, tglSelesai, waktuSelesai) {
        try {
            let tanggalMulai = parseDateString(tglMulai);
            let jamMulai = parseTimeString(waktuMulai);
            let tanggalSelesai = tglSelesai ? parseDateString(tglSelesai) : null;
            let jamSelesai = waktuSelesai ? parseTimeString(waktuSelesai) : null;
            
            if (!tanggalMulai) return [null, null];
            
            const tglMulaiObj = new Date(tanggalMulai);
            tglMulaiObj.setHours(jamMulai.jam, jamMulai.menit, 0);
            
            let tglSelesaiObj = null;
            if (tanggalSelesai && jamSelesai) {
                tglSelesaiObj = new Date(tanggalSelesai);
                tglSelesaiObj.setHours(jamSelesai.jam, jamSelesai.menit, 0);
            }
            
            return [tglMulaiObj, tglSelesaiObj];
        } catch {
            return [null, null];
        }
    }

    function parseDateString(dateStr) {
        if (!dateStr) return null;
        if (dateStr.includes('/')) {
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                const bulan = parseInt(parts[0]) - 1;
                const hari = parseInt(parts[1]);
                let tahun = parseInt(parts[2]);
                if (tahun < 100) tahun += 2000;
                return `${tahun}-${(bulan+1).toString().padStart(2, '0')}-${hari.toString().padStart(2, '0')}`;
            }
        }
        return dateStr;
    }

    function parseTimeString(timeStr) {
        let jam = 0, menit = 0;
        if (!timeStr) return { jam, menit };
        
        if (timeStr.includes('AM') || timeStr.includes('PM')) {
            const match = timeStr.match(/(\d{1,2}):(\d{2}):\d{2}\s*(AM|PM)/i);
            if (match) {
                jam = parseInt(match[1]);
                menit = parseInt(match[2]);
                const ampm = match[3].toUpperCase();
                if (ampm === 'PM' && jam !== 12) jam += 12;
                if (ampm === 'AM' && jam === 12) jam = 0;
            }
        } else {
            const match = timeStr.match(/(\d{1,2}):(\d{2})/);
            if (match) {
                jam = parseInt(match[1]);
                menit = parseInt(match[2]);
                if (jam > 23) jam -= 24;
            }
        }
        return { jam, menit };
    }

    function getCountdownText(tglMulai, waktuMulai) {
        try {
            const [tglMulaiObj] = parseDates(tglMulai, waktuMulai, null, null);
            if (!tglMulaiObj) return '';
            
            const sekarang = new Date();
            const diff = tglMulaiObj - sekarang;
            
            if (diff <= 0) return '';
            
            const hari = Math.floor(diff / (1000 * 60 * 60 * 24));
            const jam = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const menit = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (hari > 0) return `<span class="countdown-timer"><i class="fas fa-hourglass-half"></i> ${hari} hari ${jam} jam</span>`;
            if (jam > 0) return `<span class="countdown-timer"><i class="fas fa-hourglass-half"></i> ${jam} jam ${menit} menit</span>`;
            if (menit > 0) return `<span class="countdown-timer"><i class="fas fa-hourglass-half"></i> ${menit} menit</span>`;
            return '';
        } catch {
            return '';
        }
    }

    // ===========================================
    // FORMAT FUNCTIONS
    // ===========================================
    function formatTanggalIndonesia(dateString) {
        if (!dateString) return null;
        try {
            if (dateString.includes('/')) {
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    const bulan = parseInt(parts[0]);
                    const hari = parseInt(parts[1]);
                    let tahun = parseInt(parts[2]);
                    if (tahun < 100) tahun += 2000;
                    
                    const namaBulan = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                        'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
                    
                    if (bulan >= 1 && bulan <= 12) {
                        return `${hari} ${namaBulan[bulan-1]} ${tahun}`;
                    }
                }
            }
        } catch {}
        return dateString;
    }

    function formatWaktuIndonesia(waktuString) {
        if (!waktuString) return null;
        try {
            waktuString = waktuString.trim();
            
            if (waktuString.includes('AM') || waktuString.includes('PM')) {
                const match = waktuString.match(/(\d{1,2}):(\d{2}):\d{2}\s*(AM|PM)/i);
                if (match) {
                    let jam = parseInt(match[1]);
                    const menit = match[2];
                    const ampm = match[3].toUpperCase();
                    if (ampm === 'PM' && jam !== 12) jam += 12;
                    if (ampm === 'AM' && jam === 12) jam = 0;
                    return `${jam.toString().padStart(2, '0')}.${menit} WIB`;
                }
            }
            
            if (waktuString.includes('1899') || waktuString.includes('T')) {
                const match = waktuString.match(/T(\d{2}):(\d{2})/);
                if (match) {
                    let jam = parseInt(match[1]);
                    const menit = match[2];
                    if (jam > 23) jam = jam - 24;
                    return `${jam.toString().padStart(2, '0')}.${menit} WIB`;
                }
            }
            
            const match = waktuString.match(/(\d{1,2}):(\d{2})/);
            if (match) {
                let jam = parseInt(match[1]);
                const menit = match[2];
                if (jam > 23) jam = jam - 24;
                return `${jam.toString().padStart(2, '0')}.${menit} WIB`;
            }
        } catch (e) {}
        return waktuString;
    }

    function getExcerptText(text, maxLength = 50) {
        if (!text) return 'Tidak ada keterangan';
        text = text.replace(/\n/g, ' ').trim();
        if (text.length > maxLength) {
            return text.substring(0, maxLength) + '...';
        }
        return text;
    }

    // ===========================================
    // GET THUMBNAIL URL - UNTUK CARD TERTUTUP
    // ===========================================
    function getThumbnailUrl(instansi) {
        return DEFAULT_THUMBNAILS[instansi] || 'https://senapelan.github.io/Home/data/foto/updatelogo.png';
    }

    // ===========================================
    // GET FOTO KONTEN - JIKA ADA LINK SPREADSHEET
    // ===========================================
    function getFotoKontenUrl(fotoUrl) {
        if (!fotoUrl || fotoUrl.trim() === '') return null;
        
        try {
            // Google Drive link
            if (fotoUrl.includes('open?id=')) {
                const fileId = fotoUrl.split('open?id=')[1].split('&')[0];
                return `https://drive.google.com/uc?export=view&id=${fileId}`;
            } else if (fotoUrl.includes('file/d/')) {
                const match = fotoUrl.match(/\/d\/(.*?)(\/|$)/);
                if (match) {
                    return `https://drive.google.com/uc?export=view&id=${match[1]}`;
                }
            }
        } catch (e) {
            console.log('Error parsing foto URL:', e);
        }
        return fotoUrl;
    }

    // ===========================================
    // PDF GENERATOR - FOTO KONTEN TERCETAK
    // ===========================================
    window.printToPDF = async function(cardElement, judul, instansi) {
        try {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            // Clone card dengan semua konten termasuk foto
            const cloneCard = cardElement.cloneNode(true);
            cloneCard.style.width = '800px';
            cloneCard.style.position = 'fixed';
            cloneCard.style.left = '-9999px';
            cloneCard.style.top = '0';
            cloneCard.style.background = 'white';
            cloneCard.style.borderRadius = '16px';
            cloneCard.style.padding = '30px';
            cloneCard.style.boxShadow = 'none';
            cloneCard.style.maxHeight = 'none';
            cloneCard.style.overflow = 'visible';
            
            // Hapus tombol cetak agar tidak double
            cloneCard.querySelectorAll('.btn-pdf').forEach(el => el.remove());
            
            // Pastikan semua gambar terload
            const images = cloneCard.querySelectorAll('img');
            await Promise.all(Array.from(images).map(img => {
                if (img.complete) return Promise.resolve();
                return new Promise(resolve => {
                    img.onload = resolve;
                    img.onerror = resolve;
                });
            }));
            
            document.body.appendChild(cloneCard);
            
            const canvas = await html2canvas(cloneCard, {
                scale: 2,
                backgroundColor: '#ffffff',
                logging: false,
                allowTaint: true,
                useCORS: true
            });
            
            document.body.removeChild(cloneCard);
            
            const imgData = canvas.toDataURL('image/png');
            const imgWidth = 210;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            
            pdf.addImage(imgData, 'PNG', 0, 10, imgWidth, imgHeight);
            
            // Format nama file
            const date = new Date();
            const dateStr = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
            pdf.save(`Kegiatan-${instansi}-${dateStr}.pdf`);
            
        } catch (error) {
            console.error('PDF Error:', error);
            alert('Gagal mencetak PDF. Silakan coba lagi.');
        }
    };

    // ===========================================
    // SORT & FILTER DATA - FIXED!
    // ===========================================
    function sortAndFilterData(data, filter, limit) {
        if (!data || data.length === 0) return [];
        
        // Filter instansi - PERBAIKAN!
        let filtered = [];
        if (filter === 'all') {
            filtered = [...data];
        } else {
            filtered = data.filter(item => {
                // Pastikan instansi tidak undefined/null dan cocok persis
                return item.instansi && item.instansi.trim() === filter;
            });
        }
        
        // Kategorikan status
        const berlangsung = [];
        const akanDatang = [];
        const selesai = [];
        
        filtered.forEach(item => {
            const status = getStatusAcara(item.tglMulai, item.waktuMulai, item.tglSelesai, item.waktuSelesai);
            item.status = status;
            
            if (status === 'berlangsung') berlangsung.push(item);
            else if (status === 'akan-datang') akanDatang.push(item);
            else selesai.push(item);
        });
        
        // Sort masing-masing kategori
        berlangsung.sort((a, b) => {
            const [aMulai] = parseDates(a.tglMulai, a.waktuMulai);
            const [bMulai] = parseDates(b.tglMulai, b.waktuMulai);
            return aMulai - bMulai;
        });
        
        akanDatang.sort((a, b) => {
            const [aMulai] = parseDates(a.tglMulai, a.waktuMulai);
            const [bMulai] = parseDates(b.tglMulai, b.waktuMulai);
            return aMulai - bMulai;
        });
        
        selesai.sort((a, b) => {
            const dateA = new Date(a.timestamp);
            const dateB = new Date(b.timestamp);
            return dateB - dateA;
        });
        
        // Gabungkan dengan limit
        let result = [...berlangsung, ...akanDatang, ...selesai];
        return result.slice(0, limit);
    }

    // ===========================================
    // TOGGLE CARD - PASTIKAN TIDAK TUTUP SENDIRI
    // ===========================================
    window.toggleCard = function(cardId) {
        const card = document.querySelector(`[data-card-id="${cardId}"]`);
        if (card) {
            if (card.classList.contains('expanded')) {
                card.classList.remove('expanded');
                saveExpandedCard(null);
            } else {
                document.querySelectorAll('.card').forEach(c => c.classList.remove('expanded'));
                card.classList.add('expanded');
                saveExpandedCard(cardId);
            }
        }
    };

    // ===========================================
    // RENDER CARDS
    // ===========================================
    function renderCards(rows) {
        const feed = document.getElementById('newsFeed');
        const paginationInfo = document.getElementById('paginationInfo');
        
        if (!rows || rows.length === 0) {
            feed.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-calendar-times" style="font-size: 48px; color: var(--gray);"></i>
                    <h3 style="margin-top: 20px; color: var(--primary);">Tidak Ada Kegiatan</h3>
                    <p style="margin-top: 12px; color: var(--gray);">Tidak ditemukan kegiatan untuk filter yang dipilih</p>
                </div>
            `;
            paginationInfo.innerHTML = '<span><i class="fas fa-info-circle"></i> Tidak ada data ditampilkan</span>';
            return;
        }

        // Kategorikan untuk section
        const berlangsung = rows.filter(r => r.status === 'berlangsung');
        const akanDatang = rows.filter(r => r.status === 'akan-datang');
        const selesai = rows.filter(r => r.status === 'selesai');

        let html = '';

        // Section Acara Berlangsung
        if (berlangsung.length > 0) {
            html += `<div class="section-title">
                        <h2><i class="fas fa-play-circle" style="color: var(--success);"></i> Sedang Berlangsung</h2>
                        <span>${berlangsung.length} Acara</span>
                    </div>`;
            
            berlangsung.forEach((row, index) => {
                html += renderSingleCard(row, index, 'berlangsung');
            });
        }

        // Section Acara Akan Datang
        if (akanDatang.length > 0) {
            html += `<div class="section-title">
                        <h2><i class="fas fa-clock" style="color: var(--warning);"></i> Akan Datang</h2>
                        <span>${akanDatang.length} Acara</span>
                    </div>`;
            
            akanDatang.forEach((row, index) => {
                html += renderSingleCard(row, index, 'akan-datang');
            });
        }

        // Section Acara Selesai
        if (selesai.length > 0) {
            html += `<div class="section-title">
                        <h2><i class="fas fa-check-circle" style="color: var(--gray);"></i> Acara Selesai</h2>
                        <span>${selesai.length} Acara</span>
                    </div>`;
            
            selesai.forEach((row, index) => {
                html += renderSingleCard(row, index, 'selesai');
            });
        }

        feed.innerHTML = html;
        
        // Restore expanded card - PASTIKAN TIDAK TUTUP SENDIRI
        const savedCardId = getSavedExpandedCard();
        if (savedCardId) {
            const expandedCard = document.querySelector(`[data-card-id="${savedCardId}"]`);
            if (expandedCard) {
                expandedCard.classList.add('expanded');
                expandedCardId = savedCardId;
            } else {
                saveExpandedCard(null);
            }
        }

        // Update pagination info
        paginationInfo.innerHTML = `
            <span><i class="fas fa-calendar-check"></i> Menampilkan ${rows.length} kegiatan</span>
            <span><i class="fas fa-circle" style="color: var(--success);"></i> ${berlangsung.length} Berlangsung</span>
            <span><i class="fas fa-circle" style="color: var(--warning);"></i> ${akanDatang.length} Akan Datang</span>
            <span><i class="fas fa-circle" style="color: var(--gray);"></i> ${selesai.length} Selesai</span>
        `;
    }

    function renderSingleCard(row, index, statusClass) {
        const timestamp = row.timestamp || Date.now().toString();
        const instansi = row.instansi || 'INSTANSI';
        const tglMulai = row.tglMulai || '';
        const waktuMulai = row.waktuMulai || '';
        const tglSelesai = row.tglSelesai || '';
        const waktuSelesai = row.waktuSelesai || '';
        const lokasi = row.lokasi || 'Lokasi tidak tersedia';
        const linkMap = row.linkMap || '';
        let isiKonten = row.isiKonten || 'Tidak ada keterangan';
        const fotoUrl = row.fotoUrl || '';
        
        // ID unik dan konsisten
        const cardId = `card-${instansi.replace(/\s/g, '')}-${timestamp}-${index}`;
        
        // THUMBNAIL - PAKAI FOTO DEFAULT INSTANSI
        const thumbnailUrl = getThumbnailUrl(instansi);
        
        // FOTO KONTEN - PAKAI FALLBACK JIKA TIDAK ADA
        const fotoKontenUrl = getFotoKontenUrl(fotoUrl);
        
        const excerpt = getExcerptText(isiKonten);
        const countdown = getCountdownText(tglMulai, waktuMulai);
        
        // Status Badge
        let statusBadge = '';
        if (statusClass === 'berlangsung') {
            statusBadge = '<span class="status-badge status-berlangsung"><i class="fas fa-play"></i> Sedang Berlangsung</span>';
        } else if (statusClass === 'akan-datang') {
            statusBadge = `<span class="status-badge status-akan-datang"><i class="fas fa-hourglass-half"></i> Akan Datang ${countdown}</span>`;
        } else {
            statusBadge = '<span class="status-badge status-selesai"><i class="fas fa-check-circle"></i> Acara Selesai</span>';
        }

        // Format Waktu
        const waktuAcaraHTML = formatDurasiAcara(tglMulai, waktuMulai, tglSelesai, waktuSelesai);
        
        // Link Map Check
        const punyaLinkMap = linkMap && linkMap.trim() !== '' && 
            (linkMap.includes('google.com/maps') || linkMap.includes('goo.gl/maps') || linkMap.includes('maps.app.goo.gl'));

        return `<div class="card ${statusClass}" data-card-id="${cardId}">
                    <div class="status-ribbon">
                        ${statusBadge}
                    </div>
                    <div class="card-preview" onclick="toggleCard('${cardId}')">
                        <div class="thumbnail">
                            <img src="${thumbnailUrl}" loading="lazy" onerror="this.src='${FALLBACK_IMAGE}'">
                        </div>
                        <div class="preview-content">
                            <div class="news-badge">
                                <span class="instansi-badge"><i class="fas fa-building"></i> ${instansi}</span>
                            </div>
                            <div class="judul-preview">
                                <i class="fas fa-pen-square" style="color: var(--accent);"></i> Update dari ${instansi}
                            </div>
                            <div class="excerpt-text">
                                <i class="fas fa-quote-right"></i> ${excerpt}
                            </div>
                            <div class="meta-sumber">
                                <span><i class="far fa-calendar-alt"></i> ${formatTanggalIndonesia(tglMulai) || tglMulai}</span>
                                <span><i class="far fa-clock"></i> ${formatWaktuIndonesia(waktuMulai) || waktuMulai}</span>
                            </div>
                        </div>
                        <div class="arrow-toggle">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>
                    <div class="card-detail">
                        <div class="detail-inner">
                            <div class="isi-konten">${isiKonten.replace(/\n/g, '<br>')}</div>
                            
                            <!-- FOTO KONTEN - HANYA TAMPIL JIKA ADA LINK, JIKA TIDAK ADA TIDAK TAMPIL -->
                            ${fotoKontenUrl ? `
                            <div class="foto-konten">
                                <img src="${fotoKontenUrl}" loading="lazy" onerror="this.src='${FALLBACK_IMAGE}'" style="width: 100%;">
                            </div>
                            ` : ''}
                            
                            <div class="info-section">
                                <div class="info-row">
                                    <div class="info-icon">
                                        <i class="fas fa-map-marker-alt"></i>
                                    </div>
                                    <div class="info-content">
                                        <div class="info-label">ALAMAT LOKASI</div>
                                        <div class="alamat-text">${lokasi}</div>
                                    </div>
                                </div>
                                ${punyaLinkMap ? `
                                <div class="info-row">
                                    <div class="info-icon">
                                        <i class="fas fa-link"></i>
                                    </div>
                                    <div class="info-content">
                                        <div class="info-label">LINK MAPS</div>
                                        <div><a href="${linkMap}" target="_blank" style="color: var(--accent);">${linkMap.substring(0, 50)}...</a></div>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            
                            ${waktuAcaraHTML}
                            
                            <div class="button-group">
                                <button onclick="printToPDF(this.closest('.card'), '${instansi.replace(/'/g, "\\'")}', '${instansi.replace(/'/g, "\\'")}')" class="btn btn-pdf">
                                    <i class="fas fa-file-pdf"></i> Cetak/Print PDF
                                </button>
                                ${punyaLinkMap ? `
                                <a href="${linkMap}" target="_blank" class="btn btn-map">
                                    <i class="fas fa-map-marked-alt"></i> Buka Google Maps
                                </a>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>`;
    }

    function formatDurasiAcara(tglMulai, waktuMulai, tglSelesai, waktuSelesai) {
        const tanggalMulai = formatTanggalIndonesia(tglMulai);
        const jamMulai = formatWaktuIndonesia(waktuMulai);
        const tanggalSelesai = formatTanggalIndonesia(tglSelesai);
        const jamSelesai = formatWaktuIndonesia(waktuSelesai);
        
        if (tglMulai === tglSelesai && jamMulai && jamSelesai) {
            return `
                <div class="time-display">
                    <span class="date-badge">
                        <i class="far fa-calendar-alt"></i> ${tanggalMulai || tglMulai}
                    </span>
                    <span class="time-badge">
                        <i class="far fa-clock"></i> ${jamMulai.replace('WIB', '')} — ${jamSelesai}
                    </span>
                </div>
            `;
        } else if (tanggalMulai && jamMulai && tanggalSelesai && jamSelesai) {
            return `
                <div class="time-display">
                    <span class="date-badge">
                        <i class="far fa-calendar-alt"></i> ${tanggalMulai} ${jamMulai}
                    </span>
                    <span style="color: #94a3b8;"><i class="fas fa-arrow-right"></i></span>
                    <span class="date-badge">
                        <i class="far fa-calendar-alt"></i> ${tanggalSelesai} ${jamSelesai}
                    </span>
                </div>
            `;
        }
        return `
            <div class="time-display">
                <span class="date-badge">
                    <i class="far fa-calendar-alt"></i> ${tanggalMulai || tglMulai || '?'} ${jamMulai || waktuMulai || ''}
                </span>
            </div>
        `;
    }

    // ===========================================
    // FETCH DATA
    // ===========================================
    function fetchData() {
        const callbackName = 'handleData_' + Date.now();
        
        window[callbackName] = function(response) {
            const script = document.getElementById('jsonp-script');
            if (script) script.remove();
            retryCount = 0;
            
            if (response && response.success === true) {
                allData = response.data || [];
                console.log('Data loaded:', allData.length, 'items');
                
                // Filter dan limit
                const filteredData = sortAndFilterData(allData, currentFilter, currentEntry);
                renderCards(filteredData);
                
                document.getElementById('lastUpdate').innerHTML = 
                    `<i class="fas fa-check-circle" style="color: var(--success);"></i> Terakhir update: ${new Date().toLocaleTimeString('id-ID')} · Total ${allData.length} kegiatan`;
            } else {
                showError(response?.error || 'Format data tidak valid');
            }
            
            setTimeout(() => delete window[callbackName], 100);
        };
        
        const script = document.createElement('script');
        script.id = 'jsonp-script';
        script.src = `${APPS_SCRIPT_URL}?callback=${callbackName}&t=${Date.now()}`;
        
        script.onerror = function() {
            retryCount++;
            if (retryCount <= MAX_RETRY) {
                console.log(`Retry ${retryCount}/${MAX_RETRY}...`);
                setTimeout(fetchData, 2000);
            } else {
                showError('Tidak dapat terhubung ke server');
            }
            delete window[callbackName];
            document.getElementById('jsonp-script')?.remove();
        };
        
        document.head.appendChild(script);
    }

    function showError(message) {
        document.getElementById('newsFeed').innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: var(--warning);"></i>
                <h3 style="margin-top: 20px;">Gagal mengambil data</h3>
                <p style="margin-top: 12px;">${message || 'Periksa koneksi dan URL Apps Script'}</p>
            </div>
        `;
        document.getElementById('lastUpdate').innerHTML = 
            `<i class="fas fa-exclamation-circle" style="color: var(--accent);"></i> Gagal sinkron · ${new Date().toLocaleTimeString('id-ID')}`;
    }

    // ===========================================
    // EVENT LISTENERS
    // ===========================================
    function initEventListeners() {
        // Filter buttons - FIXED!
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Update active class
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // Get filter value
                const filter = this.dataset.filter;
                currentFilter = filter;
                
                console.log('Filter clicked:', filter);
                
                // Apply filter
                if (allData && allData.length > 0) {
                    const filteredData = sortAndFilterData(allData, currentFilter, currentEntry);
                    renderCards(filteredData);
                }
            });
        });
        
        // Entry select
        document.getElementById('entrySelect').addEventListener('change', function() {
            currentEntry = parseInt(this.value);
            console.log('Entry changed:', currentEntry);
            
            if (allData && allData.length > 0) {
                const filteredData = sortAndFilterData(allData, currentFilter, currentEntry);
                renderCards(filteredData);
            }
        });
    }

    // ===========================================
    // INITIALIZATION
    // ===========================================
    window.addEventListener('load', function() {
        initEventListeners();
        fetchData();
        
        // Auto refresh setiap 5 DETIK (sesuai permintaan)
        setInterval(() => {
            console.log('Auto-refresh...');
            fetchData();
        }, 5000); // 5000ms = 5 detik
    });
    </script>
</body>
</html>
