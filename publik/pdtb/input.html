<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Data Keluarga - Sistem Penduduk</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        :root {
            --primary-blue: #1e3a8a;
            --secondary-blue: #3b82f6;
            --light-blue: #eff6ff;
        }
        
        body {
            background: linear-gradient(135deg, #f8fafc 0%, #f0f9ff 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        
        .header-section {
            background: linear-gradient(135deg, var(--primary-blue) 0%, #2563eb 100%);
            color: white;
            padding: 2rem 0;
            border-radius: 0 0 25px 25px;
            box-shadow: 0 6px 25px rgba(30, 58, 138, 0.2);
        }
        
        .card-main {
            border: none;
            border-radius: 18px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.1);
            background: white;
            margin-bottom: 25px;
        }
        
        .member-card {
            border: 1px solid #dee2e6;
            border-radius: 10px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .member-card:hover {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }
        
        .spinner-custom {
            width: 50px;
            height: 50px;
            border: 5px solid #e0f2fe;
            border-top: 5px solid var(--secondary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .btn-add-member {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
        }
        
        .btn-add-member:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }
        
        .btn-remove-member {
            background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
        }
        
        .member-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
            color: white;
            border-radius: 50%;
            font-weight: bold;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-custom"></div>
        <div class="ms-3">Memproses...</div>
    </div>

    <!-- Header -->
    <div class="header-section">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-2">
                        <i class="bi bi-pencil-square me-3"></i>Edit Data Keluarga
                    </h1>
                    <p class="mb-0 opacity-75">Perbarui data keluarga yang sudah terdaftar</p>
                </div>
                <div class="text-end">
                    <button class="btn btn-outline-light" onclick="window.location.href='index.html'">
                        <i class="bi bi-arrow-left me-2"></i>Kembali
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mt-4 mb-5">
        <div class="alert alert-info mb-4">
            <i class="bi bi-info-circle-fill me-2"></i>
            <strong>Mode Edit:</strong> Anda dapat mengubah data keluarga, menambah atau menghapus anggota keluarga.
        </div>

        <div id="editContainer">
            <!-- Data akan di-load dari database -->
            <div class="text-center py-5">
                <div class="spinner-border text-primary mb-3"></div>
                <p>Memuat data keluarga...</p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/id.js"></script>
    <script>
        // Configuration
        const CONFIG = {
            WEB_APP_URL: 'https://script.google.com/macros/s/AKfycbw9tqN1y5EW7MmN0WqjRhQhtvWAfAHbt1p1rYYAZ5qe9aJZjfZXvVsopiGNJArhE1QdZQ/exec'
        };

        // Global Variables
        let familyData = null;
        let membersData = [];
        let nextMemberId = 1;

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            const noKK = localStorage.getItem('editKK');
            
            if (!noKK) {
                alert('Tidak ada data KK untuk diedit. Kembali ke halaman utama.');
                window.location.href = 'index.html';
                return;
            }
            
            await loadFamilyData(noKK);
        });

        // Load family data
        async function loadFamilyData(noKK) {
            showLoading();
            
            try {
                const response = await fetch(`${CONFIG.WEB_APP_URL}?action=getFamily&noKK=${encodeURIComponent(noKK)}`);
                const result = await response.json();
                
                if (result.success) {
                    familyData = result.family;
                    membersData = result.members;
                    nextMemberId = membersData.length + 1;
                    renderEditForm();
                } else {
                    alert('Gagal memuat data: ' + (result.error || 'Data tidak ditemukan'));
                    window.location.href = 'index.html';
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Terjadi kesalahan saat memuat data: ' + error.message);
                window.location.href = 'index.html';
            } finally {
                hideLoading();
            }
        }

        // Render edit form
        function renderEditForm() {
            const container = document.getElementById('editContainer');
            
            container.innerHTML = `
                <div class="card card-main">
                    <div class="card-header bg-light">
                        <h4 class="mb-0">
                            <i class="bi bi-house-door me-2"></i>
                            Edit Data Keluarga - ${familyData.noKK}
                        </h4>
                        <p class="text-muted mb-0 mt-2">
                            ${familyData.alamat}, RT ${familyData.rt}/RW ${familyData.rw}
                        </p>
                    </div>
                    
                    <div class="card-body">
                        <!-- Family Info -->
                        <div class="mb-4">
                            <h5 class="mb-3">
                                <i class="bi bi-geo-alt me-2"></i>Informasi Alamat Keluarga
                            </h5>
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label class="form-label">Alamat Lengkap <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" 
                                           id="alamat" value="${familyData.alamat}" required>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">RT <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" 
                                           id="rt" value="${familyData.rt}" maxlength="3" required>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">RW <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" 
                                           id="rw" value="${familyData.rw}" maxlength="3" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Kelurahan <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" 
                                           id="kelurahan" value="${familyData.kelurahan}" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Kecamatan <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" 
                                           id="kecamatan" value="${familyData.kecamatan}" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Kota/Kabupaten <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" 
                                           id="kotaKabupaten" value="${familyData.kotaKabupaten}" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Provinsi <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" 
                                           id="provinsi" value="${familyData.provinsi}" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Kode Pos <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" 
                                           id="kodePos" value="${familyData.kodePos}" maxlength="5" required>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Members Info -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">
                                    <i class="bi bi-people me-2"></i>Anggota Keluarga
                                </h5>
                                <button class="btn btn-add-member" onclick="addNewMember()">
                                    <i class="bi bi-person-plus me-2"></i>Tambah Anggota
                                </button>
                            </div>
                            <div class="alert alert-warning mb-3">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>Urutan Pengisian:</strong> 1. Kepala Keluarga → 2. Isteri → 3. Anak → 4. Orang Tua → 5. Menantu → 6. Family Lain
                            </div>
                            <div id="membersContainer">
                                ${renderMembers()}
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-between mt-4">
                            <button class="btn btn-secondary" onclick="window.location.href='index.html'">
                                <i class="bi bi-x-circle me-2"></i>Batal
                            </button>
                            <button class="btn btn-primary" onclick="saveChanges()">
                                <i class="bi bi-save me-2"></i>Simpan Perubahan
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Initialize date pickers
            initializeDatePickers();
        }

        // Render members
        function renderMembers() {
            let html = '';
            
            // Existing members
            membersData.forEach((member, index) => {
                html += renderMemberCard(member, index + 1, false);
            });
            
            return html;
        }

        // Render single member card
        function renderMemberCard(memberData, memberNumber, isNew = false) {
            const isKepalaKeluarga = memberData.statusHubungan === 'Kepala Keluarga';
            const canDelete = !isKepalaKeluarga && memberNumber > 1;
            
            return `
                <div class="member-card" id="memberCard${memberNumber}">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="member-number">${memberNumber}</span>
                                <strong>Anggota ${memberNumber}</strong>
                                <span class="badge bg-primary ms-2">${memberData.statusHubungan}</span>
                            </div>
                            <div>
                                ${canDelete ? `
                                    <button class="btn btn-remove-member btn-sm" onclick="removeMember(${memberNumber})">
                                        <i class="bi bi-trash me-1"></i>Hapus
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Status Hubungan <span class="text-danger">*</span></label>
                                <select class="form-select" id="hubungan${memberNumber}" 
                                        onchange="checkKepalaKeluarga(${memberNumber})" ${isKepalaKeluarga ? 'disabled' : ''}>
                                    <option value="Kepala Keluarga" ${memberData.statusHubungan === 'Kepala Keluarga' ? 'selected' : ''}>
                                        Kepala Keluarga
                                    </option>
                                    <option value="Isteri" ${memberData.statusHubungan === 'Isteri' ? 'selected' : ''}>Isteri</option>
                                    <option value="Anak" ${memberData.statusHubungan === 'Anak' ? 'selected' : ''}>Anak</option>
                                    <option value="Orang Tua" ${memberData.statusHubungan === 'Orang Tua' ? 'selected' : ''}>Orang Tua</option>
                                    <option value="Menantu" ${memberData.statusHubungan === 'Menantu' ? 'selected' : ''}>Menantu</option>
                                    <option value="Family Lain" ${memberData.statusHubungan === 'Family Lain' ? 'selected' : ''}>Family Lain</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Status Anggota</label>
                                <select class="form-select" id="statusAnggota${memberNumber}">
                                    <option value="Hidup" ${memberData.statusAnggota === 'Hidup' ? 'selected' : ''}>Hidup</option>
                                    <option value="Meninggal" ${memberData.statusAnggota === 'Meninggal' ? 'selected' : ''}>Meninggal</option>
                                    <option value="Pindah" ${memberData.statusAnggota === 'Pindah' ? 'selected' : ''}>Pindah</option>
                                    <option value="Pisah KK" ${memberData.statusAnggota === 'Pisah KK' ? 'selected' : ''}>Pisah KK</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label class="form-label">Nama Lengkap <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" 
                                       id="nama${memberNumber}" value="${memberData.namaLengkap || ''}" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Jenis Kelamin <span class="text-danger">*</span></label>
                                <select class="form-select" id="gender${memberNumber}" required>
                                    <option value="">Pilih...</option>
                                    <option value="Laki-laki" ${memberData.jenisKelamin === 'Laki-laki' ? 'selected' : ''}>Laki-laki</option>
                                    <option value="Perempuan" ${memberData.jenisKelamin === 'Perempuan' ? 'selected' : ''}>Perempuan</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">NIK <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" 
                                       id="nik${memberNumber}" value="${memberData.nik || ''}" maxlength="16" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Tempat Lahir</label>
                                <input type="text" class="form-control" 
                                       id="tempatLahir${memberNumber}" value="${memberData.tempatLahir || ''}">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Tanggal Lahir</label>
                                <input type="text" class="form-control date-picker" 
                                       id="tanggalLahir${memberNumber}" value="${memberData.tanggalLahir || ''}">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Agama</label>
                                <select class="form-select" id="agama${memberNumber}">
                                    <option value="">Pilih...</option>
                                    <option value="Islam" ${memberData.agama === 'Islam' ? 'selected' : ''}>Islam</option>
                                    <option value="Kristen" ${memberData.agama === 'Kristen' ? 'selected' : ''}>Kristen</option>
                                    <option value="Katolik" ${memberData.agama === 'Katolik' ? 'selected' : ''}>Katolik</option>
                                    <option value="Hindu" ${memberData.agama === 'Hindu' ? 'selected' : ''}>Hindu</option>
                                    <option value="Buddha" ${memberData.agama === 'Buddha' ? 'selected' : ''}>Buddha</option>
                                    <option value="Konghucu" ${memberData.agama === 'Konghucu' ? 'selected' : ''}>Konghucu</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Pendidikan</label>
                                <select class="form-select" id="pendidikan${memberNumber}">
                                    <option value="">Pilih...</option>
                                    <option value="Tidak Sekolah" ${memberData.pendidikan === 'Tidak Sekolah' ? 'selected' : ''}>Tidak Sekolah</option>
                                    <option value="SD" ${memberData.pendidikan === 'SD' ? 'selected' : ''}>SD</option>
                                    <option value="SMP" ${memberData.pendidikan === 'SMP' ? 'selected' : ''}>SMP</option>
                                    <option value="SMA" ${memberData.pendidikan === 'SMA' ? 'selected' : ''}>SMA</option>
                                    <option value="D1/D2/D3" ${memberData.pendidikan === 'D1/D2/D3' ? 'selected' : ''}>D1/D2/D3</option>
                                    <option value="S1" ${memberData.pendidikan === 'S1' ? 'selected' : ''}>S1</option>
                                    <option value="S2/S3" ${memberData.pendidikan === 'S2/S3' ? 'selected' : ''}>S2/S3</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Pekerjaan</label>
                                <input type="text" class="form-control" 
                                       id="pekerjaan${memberNumber}" value="${memberData.pekerjaan || ''}">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Gol. Darah</label>
                                <select class="form-select" id="golDarah${memberNumber}">
                                    <option value="">Pilih...</option>
                                    <option value="A" ${memberData.golDarah === 'A' ? 'selected' : ''}>A</option>
                                    <option value="B" ${memberData.golDarah === 'B' ? 'selected' : ''}>B</option>
                                    <option value="AB" ${memberData.golDarah === 'AB' ? 'selected' : ''}>AB</option>
                                    <option value="O" ${memberData.golDarah === 'O' ? 'selected' : ''}>O</option>
                                    <option value="Tidak Tahu" ${memberData.golDarah === 'Tidak Tahu' ? 'selected' : ''}>Tidak Tahu</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Add new member
        function addNewMember() {
            if (membersData.length >= 10) {
                alert('Maksimal 10 anggota per keluarga');
                return;
            }
            
            const newMember = {
                statusHubungan: 'Anak',
                statusAnggota: 'Hidup',
                namaLengkap: '',
                nik: '',
                jenisKelamin: '',
                tempatLahir: '',
                tanggalLahir: '',
                agama: '',
                pendidikan: '',
                pekerjaan: '',
                golDarah: '',
                statusPerkawinan: '',
                tanggalPerkawinan: '',
                kewarganegaraan: 'Warga Negara Indonesia',
                noPaspor: '',
                nokitap: '',
                namaAyah: '',
                namaIbu: '',
                statusKekayaan: '',
                statusLPS: '',
                statusKesehatan: ''
            };
            
            membersData.push(newMember);
            const memberNumber = membersData.length;
            
            const membersContainer = document.getElementById('membersContainer');
            membersContainer.insertAdjacentHTML('beforeend', renderMemberCard(newMember, memberNumber, true));
            
            // Reinitialize date picker for new member
            initializeDatePickers();
        }

        // Remove member
        function removeMember(memberNumber) {
            if (!confirm(`Hapus anggota ${memberNumber}?`)) {
                return;
            }
            
            // Find and remove the member
            const index = memberNumber - 1;
            if (index >= 0 && index < membersData.length) {
                // Check if this is Kepala Keluarga
                if (membersData[index].statusHubungan === 'Kepala Keluarga') {
                    alert('Kepala Keluarga tidak dapat dihapus!');
                    return;
                }
                
                membersData.splice(index, 1);
                
                // Remove the card from DOM
                const card = document.getElementById(`memberCard${memberNumber}`);
                if (card) {
                    card.remove();
                }
                
                // Re-render all members with updated numbers
                renumberMembers();
            }
        }

        // Renumber members after deletion
        function renumberMembers() {
            const membersContainer = document.getElementById('membersContainer');
            membersContainer.innerHTML = '';
            
            membersData.forEach((member, index) => {
                const memberNumber = index + 1;
                membersContainer.insertAdjacentHTML('beforeend', renderMemberCard(member, memberNumber));
            });
            
            // Reinitialize date pickers
            initializeDatePickers();
        }

        // Check if Kepala Keluarga already exists
        function checkKepalaKeluarga(currentMemberNumber) {
            const hubungan = document.getElementById(`hubungan${currentMemberNumber}`).value;
            
            if (hubungan === 'Kepala Keluarga') {
                // Check if another member is already Kepala Keluarga
                for (let i = 1; i <= membersData.length; i++) {
                    if (i !== currentMemberNumber) {
                        const otherHubungan = document.getElementById(`hubungan${i}`);
                        if (otherHubungan && otherHubungan.value === 'Kepala Keluarga') {
                            alert('Sudah ada Kepala Keluarga! Hanya boleh ada satu Kepala Keluarga.');
                            document.getElementById(`hubungan${currentMemberNumber}`).value = 'Isteri';
                            break;
                        }
                    }
                }
            }
        }

        // Initialize date pickers
        function initializeDatePickers() {
            flatpickr(".date-picker", {
                dateFormat: "Y-m-d",
                locale: "id",
                maxDate: "today"
            });
        }

        // Save changes
        async function saveChanges() {
            if (!validateForm()) {
                return;
            }
            
            if (!confirm('Apakah Anda yakin ingin menyimpan perubahan?')) {
                return;
            }
            
            showLoading();
            
            try {
                // Collect updated data
                const updatedFamily = {
                    noKK: familyData.noKK,
                    alamat: document.getElementById('alamat').value.trim(),
                    rt: document.getElementById('rt').value.trim(),
                    rw: document.getElementById('rw').value.trim(),
                    kelurahan: document.getElementById('kelurahan').value.trim(),
                    kecamatan: document.getElementById('kecamatan').value.trim(),
                    kotaKabupaten: document.getElementById('kotaKabupaten').value.trim(),
                    provinsi: document.getElementById('provinsi').value.trim(),
                    kodePos: document.getElementById('kodePos').value.trim(),
                    namaPetugas: familyData.namaPetugas,
                    sumberData: familyData.sumberData || '',
                    catatan: ''
                };
                
                const updatedMembers = [];
                
                for (let i = 1; i <= membersData.length; i++) {
                    const member = {
                        statusHubungan: document.getElementById(`hubungan${i}`).value,
                        statusAnggota: document.getElementById(`statusAnggota${i}`).value,
                        namaLengkap: document.getElementById(`nama${i}`).value.trim(),
                        nik: document.getElementById(`nik${i}`).value.trim(),
                        jenisKelamin: document.getElementById(`gender${i}`).value,
                        tempatLahir: document.getElementById(`tempatLahir${i}`).value.trim(),
                        tanggalLahir: document.getElementById(`tanggalLahir${i}`).value,
                        agama: document.getElementById(`agama${i}`).value,
                        pendidikan: document.getElementById(`pendidikan${i}`).value,
                        pekerjaan: document.getElementById(`pekerjaan${i}`).value.trim(),
                        golDarah: document.getElementById(`golDarah${i}`).value,
                        statusPerkawinan: membersData[i-1]?.statusPerkawinan || '',
                        tanggalPerkawinan: membersData[i-1]?.tanggalPerkawinan || '',
                        kewarganegaraan: membersData[i-1]?.kewarganegaraan || 'Warga Negara Indonesia',
                        noPaspor: membersData[i-1]?.noPaspor || '',
                        nokitap: membersData[i-1]?.nokitap || '',
                        namaAyah: membersData[i-1]?.namaAyah || '',
                        namaIbu: membersData[i-1]?.namaIbu || '',
                        statusKekayaan: membersData[i-1]?.statusKekayaan || '',
                        statusLPS: membersData[i-1]?.statusLPS || '',
                        statusKesehatan: membersData[i-1]?.statusKesehatan || '',
                        sumberData: familyData.sumberData || ''
                    };
                    updatedMembers.push(member);
                }
                
                const submitData = {
                    familyData: updatedFamily,
                    anggota: updatedMembers
                };
                
                // Send update request
                const dataStr = encodeURIComponent(JSON.stringify(submitData));
                const url = `${CONFIG.WEB_APP_URL}?action=updateFamily&data=${dataStr}`;
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    alert('Data berhasil diperbarui!');
                    window.location.href = 'index.html';
                } else {
                    alert('Gagal memperbarui data: ' + (result.error || 'Unknown error'));
                }
                
            } catch (error) {
                console.error('Error:', error);
                alert('Terjadi kesalahan: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Validate form
        function validateForm() {
            // Validate family data
            const requiredFields = [
                {id: 'alamat', name: 'Alamat'},
                {id: 'rt', name: 'RT'},
                {id: 'rw', name: 'RW'},
                {id: 'kelurahan', name: 'Kelurahan'},
                {id: 'kecamatan', name: 'Kecamatan'},
                {id: 'kotaKabupaten', name: 'Kota/Kabupaten'},
                {id: 'provinsi', name: 'Provinsi'},
                {id: 'kodePos', name: 'Kode Pos'}
            ];
            
            for (const field of requiredFields) {
                const element = document.getElementById(field.id);
                if (!element.value.trim()) {
                    alert(`Field "${field.name}" harus diisi`);
                    element.focus();
                    return false;
                }
            }
            
            // Validate RT/RW format
            const rt = document.getElementById('rt').value.trim();
            const rw = document.getElementById('rw').value.trim();
            if (!/^\d{3}$/.test(rt)) {
                alert('RT harus 3 digit angka (contoh: 001)');
                return false;
            }
            if (!/^\d{3}$/.test(rw)) {
                alert('RW harus 3 digit angka (contoh: 002)');
                return false;
            }
            
            // Validate Kode Pos
            const kodePos = document.getElementById('kodePos').value.trim();
            if (!/^\d{5}$/.test(kodePos)) {
                alert('Kode Pos harus 5 digit angka');
                return false;
            }
            
            // Validate members data
            let hasKepalaKeluarga = false;
            
            for (let i = 1; i <= membersData.length; i++) {
                const nama = document.getElementById(`nama${i}`).value.trim();
                const nik = document.getElementById(`nik${i}`).value.trim();
                const gender = document.getElementById(`gender${i}`).value;
                const hubungan = document.getElementById(`hubungan${i}`).value;
                
                if (!nama) {
                    alert(`Anggota ${i}: Nama Lengkap harus diisi`);
                    return false;
                }
                
                if (!nik || nik.length !== 16) {
                    alert(`Anggota ${i}: NIK harus 16 digit`);
                    return false;
                }
                
                if (!gender) {
                    alert(`Anggota ${i}: Jenis Kelamin harus dipilih`);
                    return false;
                }
                
                if (!hubungan) {
                    alert(`Anggota ${i}: Status Hubungan harus dipilih`);
                    return false;
                }
                
                if (hubungan === 'Kepala Keluarga') {
                    if (hasKepalaKeluarga) {
                        alert('Hanya boleh ada satu Kepala Keluarga!');
                        return false;
                    }
                    hasKepalaKeluarga = true;
                    
                    // Kepala Keluarga harus laki-laki
                    if (gender !== 'Laki-laki') {
                        alert('Kepala Keluarga harus Laki-laki');
                        return false;
                    }
                }
            }
            
            if (!hasKepalaKeluarga) {
                alert('Harus ada Kepala Keluarga');
                return false;
            }
            
            return true;
        }

        // Loading functions
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
    </script>
</body>
</html>
