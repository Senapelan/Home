<!DOCTYPE html>
<html lang="id">
<head>
    <!-- Open Graph utama -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://senapelan.github.io/Home/publik/updater-informasi/updatev2.1.html">
    <meta property="og:title" content="Senapelan Satu Pintu - berkomitmen memberikan pelayanan cepat, transparan, dan modern berbasis digital.">
    <meta property="og:description" content="UPDATE INFORMASI KEGIATAN">
    <meta property="og:site_name" content="Kecamata-Kelurahan">
    
    <!-- Gambar preview -->
    <meta property="og:image" content="https://senapelan.github.io/Home/data/foto/updatelogo.png">
    <meta property="og:image:secure_url" content="https://senapelan.github.io/Home/data/foto/updatelogo.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="1200">
    
    <!-- Twitter / X -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Senapelan Satu Pintu - berkomitmen memberikan pelayanan cepat, transparan, dan modern berbasis digital.">
    <meta name="twitter:description" content="UPDATE INFORMASI KEGIATAN">
    <meta name="twitter:image" content="https://senapelan.github.io/Home/data/foto/updatelogo.png">
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Informasi Senapelan Â· Live Activity</title>

    <!-- FAVICON -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://senapelan.github.io/Home/data/foto/favico/favico.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* [SAME STYLES - Premium] */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(145deg, #f6f9fc 0%, #edf2f7 100%);
            font-family: 'Inter', sans-serif;
            padding: 32px 24px;
            min-height: 100vh;
            color: #1e293b;
        }
        .container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
        }
        .header {
            margin-bottom: 40px;
        }
        .header h1 {
            font-size: 2.2rem;
            font-weight: 700;
            background: linear-gradient(145deg, #0f2b3d, #1e4a6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            border-left: 8px solid #e11d48;
            padding-left: 24px;
            line-height: 1.2;
        }
        .subhead {
            display: flex;
            justify-content: space-between;
            margin-left: 32px;
            margin-top: 8px;
            color: #4b5e6b;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding-bottom: 16px;
        }
        .live-badge {
            background: #10b981;
            color: white;
            padding: 6px 14px;
            border-radius: 60px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .last-update {
            font-size: 0.8rem;
            color: #64748b;
            margin-left: 32px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* ===== STATS CARD ===== */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 32px;
            margin-top: 20px;
        }
        .stat-card {
            background: white;
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 10px 25px -10px rgba(0,0,0,0.05);
            border: 1px solid rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .stat-info h3 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 4px;
            color: #0f2b3d;
        }
        .stat-info p {
            color: #64748b;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
        }
        .stat-card.berlangsung .stat-icon {
            background: #d1fae5;
            color: #059669;
        }
        .stat-card.datang .stat-icon {
            background: #dbeafe;
            color: #2563eb;
        }
        .stat-card.selesai .stat-icon {
            background: #f1f5f9;
            color: #64748b;
        }
        .stat-card.total .stat-icon {
            background: #fef3c7;
            color: #d97706;
        }
        
        /* ===== FILTER SECTION ===== */
        .filter-section {
            background: white;
            border-radius: 28px;
            padding: 24px;
            margin-bottom: 32px;
            box-shadow: 0 10px 30px -15px rgba(0,0,0,0.05);
            border: 1px solid rgba(255,255,255,0.6);
        }
        .filter-title {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }
        .filter-title i {
            color: #e11d48;
            font-size: 1.2rem;
        }
        .filter-title h4 {
            font-weight: 600;
            color: #1e293b;
        }
        .filter-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: flex-end;
        }
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        .filter-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #64748b;
            margin-bottom: 6px;
            font-weight: 600;
        }
        .filter-select {
            width: 100%;
            padding: 14px 18px;
            border-radius: 60px;
            border: 1px solid #e2e8f0;
            background: white;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            color: #1e293b;
            cursor: pointer;
            transition: all 0.2s;
        }
        .filter-select:hover {
            border-color: #94a3b8;
        }
        .filter-select:focus {
            outline: none;
            border-color: #e11d48;
            box-shadow: 0 0 0 3px rgba(225,29,72,0.1);
        }
        .filter-buttons {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .btn-filter {
            padding: 14px 28px;
            border-radius: 60px;
            border: none;
            background: #e11d48;
            color: white;
            font-weight: 600;
            font-size: 0.95rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-filter:hover {
            background: #be123c;
            transform: scale(0.98);
        }
        .btn-reset {
            padding: 14px 28px;
            border-radius: 60px;
            border: 1px solid #e2e8f0;
            background: white;
            color: #475569;
            font-weight: 600;
            font-size: 0.95rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-reset:hover {
            background: #f8fafc;
            border-color: #94a3b8;
        }
        
        /* ===== ENTRY SELECTOR ===== */
        .entry-selector {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }
        .entry-control {
            display: flex;
            align-items: center;
            gap: 16px;
            background: white;
            padding: 8px 16px 8px 20px;
            border-radius: 60px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.02);
        }
        .entry-control span {
            color: #475569;
            font-size: 0.9rem;
        }
        .entry-select {
            padding: 10px 18px;
            border-radius: 40px;
            border: 1px solid #e2e8f0;
            background: white;
            font-weight: 500;
            color: #0f2b3d;
            cursor: pointer;
        }
        .active-filter-badge {
            background: #f1f5f9;
            padding: 8px 20px;
            border-radius: 60px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: #475569;
        }
        
        /* ===== SECTION LABELS ===== */
        .section-label {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 32px 0 20px 0;
        }
        .section-label h2 {
            font-size: 1.4rem;
            font-weight: 700;
            color: #0f2b3d;
        }
        .section-badge {
            background: #e11d48;
            color: white;
            padding: 6px 16px;
            border-radius: 60px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        /* ===== COUNTDOWN BADGE ===== */
        .countdown-badge {
            background: linear-gradient(145deg, #2563eb, #1e40af);
            color: white;
            padding: 6px 16px;
            border-radius: 60px;
            font-size: 0.75rem;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            letter-spacing: 0.5px;
            box-shadow: 0 6px 14px rgba(37,99,235,0.25);
            margin-left: 12px;
        }
        .ongoing-badge {
            background: linear-gradient(145deg, #059669, #047857);
            color: white;
            padding: 6px 16px;
            border-radius: 60px;
            font-size: 0.75rem;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            letter-spacing: 0.5px;
            box-shadow: 0 6px 14px rgba(5,150,105,0.25);
            margin-left: 12px;
        }
        
        /* ===== CARD STYLES ===== */
        .news-feed {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .card {
            background: white;
            border-radius: 28px;
            box-shadow: 0 15px 35px -12px rgba(0,20,30,0.12);
            width: 100%;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.6);
            transition: all 0.25s ease;
            position: relative;
        }
        .card.akan-datang {
            border-left: 8px solid #2563eb;
            background: linear-gradient(to right, #ffffff, #fef9e7);
        }
        .card.berlangsung {
            border-left: 8px solid #059669;
            background: linear-gradient(to right, #ffffff, #f0fdf9);
        }
        .card.selesai {
            opacity: 0.85;
            background: #f8fafc;
            border-left: 8px solid #94a3b8;
        }
        .card:hover {
            box-shadow: 0 24px 44px -14px rgba(0,55,80,0.18);
            transform: translateY(-2px);
        }
        .status-label {
            position: absolute;
            top: 16px;
            right: 22px;
            color: white;
            padding: 6px 18px;
            border-radius: 60px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-label.selesai {
            background: #64748b;
        }
        .status-label.berlangsung {
            background: #059669;
        }
        .status-label.datang {
            background: #2563eb;
        }
        .card-preview {
            display: flex;
            align-items: center;
            padding: 16px 22px;
            gap: 18px;
            cursor: pointer;
        }
        .thumbnail {
            width: 70px;
            height: 70px;
            flex-shrink: 0;
            background: #f1f5f9;
            border-radius: 18px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            box-shadow: 0 6px 14px rgba(0,0,0,0.04);
        }
        .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .preview-content {
            flex: 1;
        }
        .news-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
            flex-wrap: wrap;
        }
        .badge-new {
            background: #e11d48;
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 60px;
            text-transform: uppercase;
            box-shadow: 0 4px 12px rgba(225,29,72,0.25);
        }
        .instansi-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #547087;
            background: rgba(84,112,135,0.08);
            padding: 4px 12px;
            border-radius: 60px;
        }
        .judul-berita {
            font-size: 1.12rem;
            font-weight: 650;
            color: #0a1c2a;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        .preview-excerpt {
            font-size: 0.85rem;
            color: #4f6f7f;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 4px;
        }
        .preview-excerpt i {
            color: #94a3b8;
            font-size: 0.7rem;
        }
        .meta-sumber {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 0.8rem;
            color: #4f6f7f;
        }
        .sumber-text {
            background: rgba(20,100,120,0.05);
            padding: 4px 12px;
            border-radius: 50px;
        }
        .arrow-toggle {
            width: 42px;
            height: 42px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 16px rgba(0,0,0,0.03);
            transition: all 0.2s;
        }
        .card.expanded .arrow-toggle {
            transform: rotate(180deg);
            background: #f1f9ff;
            color: #0a4b6e;
        }
        .card-detail {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: all 0.45s cubic-bezier(0.23, 1, 0.32, 1);
            background: rgba(249,252,255,0.7);
        }
        .card.expanded .card-detail {
            max-height: 1200px;
            opacity: 1;
            padding: 22px 24px 28px;
            border-top: 1px solid rgba(168,192,207,0.2);
        }
        .isi-konten {
            font-size: 1rem;
            line-height: 1.65;
            color: #1f3a4b;
            background: white;
            padding: 20px;
            border-radius: 20px;
            border: 1px solid rgba(84,110,122,0.08);
            white-space: pre-line;
            margin-bottom: 20px;
        }
        
        /* ===== FOTO DI DALAM DETAIL ===== */
        .detail-foto {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(84,110,122,0.08);
        }
        .detail-foto-title {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        .detail-foto-title i {
            color: #e11d48;
            font-size: 1.2rem;
        }
        .detail-foto-title span {
            font-weight: 600;
            color: #0f2b3d;
        }
        .detail-foto-img {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
        }
        
        .info-section {
            background: white;
            border-radius: 20px;
            padding: 16px 20px;
            margin-bottom: 12px;
            border: 1px solid rgba(0,0,0,0.02);
        }
        .info-row {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
        }
        .info-row:last-child {
            margin-bottom: 0;
        }
        .info-icon {
            width: 24px;
            color: #e11d48;
            flex-shrink: 0;
        }
        .info-content {
            flex: 1;
            line-height: 1.5;
        }
        .info-label {
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }
        .alamat-text {
            font-weight: 600;
            color: #0f2b3d;
        }
        .time-display {
            display: flex;
            align-items: baseline;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }
        .date-badge {
            background: white;
            padding: 8px 18px;
            border-radius: 100px;
            font-weight: 600;
            color: #0f2b3d;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .time-badge {
            background: #f1f9ff;
            padding: 8px 18px;
            border-radius: 100px;
            font-weight: 600;
            color: #0369a1;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 20px;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 24px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 0.9rem;
            text-decoration: none;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
        .btn i {
            font-size: 1rem;
        }
        .btn-print {
            background: #0a4b6e;
            color: white;
            box-shadow: 0 8px 18px rgba(10,75,110,0.2);
        }
        .btn-print:hover {
            background: #0e5f88;
            transform: scale(0.98);
        }
        .btn-map {
            background: #e11d48;
            color: white;
            box-shadow: 0 8px 18px rgba(225,29,72,0.2);
        }
        .btn-map:hover {
            background: #be123c;
            transform: scale(0.98);
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: rgba(255,255,255,0.5);
            border-radius: 60px;
            color: #4e6a79;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #1e4a6b;
        }
        footer {
            margin-top: 50px;
            text-align: center;
            color: #7c8f99;
            padding-top: 30px;
            border-top: 1px solid rgba(0,0,0,0.04);
        }
        
        /* ===== PRINT STYLES ===== */
        @media print {
            body, .container, .card, .card-detail {
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            .header, .filter-section, .stats-container, .entry-selector, 
            .arrow-toggle, .btn-print, .last-update, footer, .status-label,
            .section-label, .live-badge {
                display: none !important;
            }
            .card {
                break-inside: avoid;
                page-break-inside: avoid;
                border: 1px solid #ddd !important;
                box-shadow: none !important;
                margin-bottom: 20px !important;
            }
            .card-detail {
                max-height: none !important;
                opacity: 1 !important;
                padding: 22px 24px !important;
            }
            .detail-foto-img {
                max-height: 300px !important;
            }
        }
        
        @media (max-width: 550px) {
            body { padding: 20px 16px; }
            .header h1 { font-size: 1.6rem; }
            .judul-berita { white-space: normal; }
            .button-group { flex-direction: column; }
            .btn { justify-content: center; }
            .time-display { flex-direction: column; }
            .status-label { position: static; margin-bottom: 8px; display: inline-block; }
            .stats-container { grid-template-columns: 1fr; }
            .filter-grid { flex-direction: column; }
            .filter-buttons { width: 100%; }
            .btn-filter, .btn-reset { flex: 1; }
            .entry-selector { flex-direction: column; align-items: stretch; }
            .entry-control { justify-content: space-between; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>UPDATE INFORMASI KEGIATAN<br>KECAMATAN DAN KELURAHAN DI SENAPELAN</h1>
            <div class="subhead">
                <span><i class="fas fa-map-pin" style="color:#e11d48;"></i> Sumber: Admin - Senapelan Satu Pintu</span>
                <span class="live-badge"><i class="fas fa-circle"></i> Live Activity</span>
            </div>
            <div class="last-update" id="lastUpdate">
                <i class="fas fa-sync-alt"></i> Menyambung ke server...
            </div>
        </div>

        <!-- STATS CARD -->
        <div class="stats-container" id="statsContainer">
            <div class="stat-card berlangsung">
                <div class="stat-info">
                    <h3 id="statBerlangsung">0</h3>
                    <p>Sedang Berlangsung</p>
                </div>
                <div class="stat-icon">
                    <i class="fas fa-play-circle"></i>
                </div>
            </div>
            <div class="stat-card datang">
                <div class="stat-info">
                    <h3 id="statDatang">0</h3>
                    <p>Akan Datang</p>
                </div>
                <div class="stat-icon">
                    <i class="fas fa-calendar-plus"></i>
                </div>
            </div>
            <div class="stat-card selesai">
                <div class="stat-info">
                    <h3 id="statSelesai">0</h3>
                    <p>Telah Selesai</p>
                </div>
                <div class="stat-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
            </div>
            <div class="stat-card total">
                <div class="stat-info">
                    <h3 id="statTotal">0</h3>
                    <p>Total Kegiatan</p>
                </div>
                <div class="stat-icon">
                    <i class="fas fa-clipboard-list"></i>
                </div>
            </div>
        </div>

        <!-- FILTER SECTION -->
        <div class="filter-section">
            <div class="filter-title">
                <i class="fas fa-sliders-h"></i>
                <h4>Filter Kegiatan</h4>
            </div>
            <div class="filter-grid">
                <div class="filter-group">
                    <div class="filter-label"><i class="fas fa-building"></i> Pilih Instansi</div>
                    <select id="filterInstansi" class="filter-select">
                        <option value="SEMUA">Semua Instansi</option>
                        <option value="KECAMATAN SENAPELAN">Kecamatan Senapelan</option>
                        <option value="KELURAHAN KAMPUNG BANDAR">Kelurahan Kampung Bandar</option>
                        <option value="KELURAHAN KAMPUNG BARU">Kelurahan Kampung Baru</option>
                        <option value="KELURAHAN KAMPUNG DALAM">Kelurahan Kampung Dalam</option>
                        <option value="KELURAHAN PADANG BULAN">Kelurahan Padang Bulan</option>
                        <option value="KELURAHAN PADANG TERUBUK">Kelurahan Padang Terubuk</option>
                        <option value="KELURAHAN SAGO">Kelurahan Sago</option>
                    </select>
                </div>
                <div class="filter-group">
                    <div class="filter-label"><i class="fas fa-tag"></i> Status Kegiatan</div>
                    <select id="filterStatus" class="filter-select">
                        <option value="SEMUA">Semua Status</option>
                        <option value="BERLANGSUNG">Sedang Berlangsung</option>
                        <option value="DATANG">Akan Datang</option>
                        <option value="SELESAI">Telah Selesai</option>
                    </select>
                </div>
                <div class="filter-buttons">
                    <button id="applyFilterBtn" class="btn-filter">
                        <i class="fas fa-check"></i> Terapkan Filter
                    </button>
                    <button id="resetFilterBtn" class="btn-reset">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                </div>
            </div>
            <div id="activeFilterBadge" class="active-filter-badge" style="margin-top: 16px; display: none;">
                <i class="fas fa-filter"></i> Filter aktif: <span id="filterText"></span>
                <button id="clearFilterBadge" style="background: none; border: none; color: #e11d48; margin-left: 8px; cursor: pointer;">
                    <i class="fas fa-times-circle"></i>
                </button>
            </div>
        </div>

        <!-- ENTRY SELECTOR -->
        <div class="entry-selector">
            <div class="entry-control">
                <span><i class="fas fa-eye"></i> Tampilkan</span>
                <select id="entryLimit" class="entry-select">
                    <option value="100">100 Card</option>
                    <option value="500">500 Card</option>
                    <option value="1000">1000 Card</option>
                    <option value="0">Semua Card</option>
                </select>
            </div>
            <div id="showingInfo" style="color: #475569; font-size: 0.9rem;">
                <i class="fas fa-info-circle"></i> Menampilkan 0 kegiatan
            </div>
        </div>

        <!-- SECTION: SEDANG BERLANGSUNG & AKAN DATANG -->
        <div id="highlightSection">
            <div class="section-label">
                <i class="fas fa-fire" style="color: #e11d48;"></i>
                <h2>ðŸ”¥ Sedang Berlangsung & Akan Datang</h2>
                <span class="section-badge" id="highlightCount">0</span>
            </div>
            <div id="highlightFeed" class="news-feed"></div>
        </div>

        <!-- SECTION: SEMUA KEGIATAN -->
        <div class="section-label" style="margin-top: 40px;">
            <i class="fas fa-list-ul" style="color: #0a4b6e;"></i>
            <h2>ðŸ“‹ Semua Kegiatan</h2>
            <span class="section-badge" id="allEventsCount">0</span>
        </div>
        <div id="newsFeed" class="news-feed"></div>
        
        <footer>
            <i class="fas fa-bolt"></i> Update Setiap 5 detik - SENAPELAN SATU PINTU
        </footer>
    </div>

    <script>
    // ===========================================
    // KONFIGURASI APPS SCRIPT
    // ===========================================
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzYnfxLi8ViBeYRQmRvEYn2fiDYJHbV5zCDGpJ5YPzNB7ez8dE9G-BIS6jzCZ61CmHMGQ/exec';
    
    let expandedCardId = null;
    let retryCount = 0;
    const MAX_RETRY = 3;
    const STORAGE_KEY = 'senapelan_expanded_card_v2_fix';
    let allData = [];
    let filteredData = [];
    let currentFilter = {
        instansi: 'SEMUA',
        status: 'SEMUA'
    };
    let currentLimit = 100;
    
    // ===========================================
    // DEFAULT FOTO PER INSTANSI
    // ===========================================
    const DEFAULT_FOTO = {
        'KECAMATAN SENAPELAN': 'https://senapelan.github.io/Home/data/foto/imgkegiatan/senapelan.png',
        'KELURAHAN KAMPUNG BANDAR': 'https://senapelan.github.io/Home/data/foto/imgkegiatan/kampungbandar.png',
        'KELURAHAN KAMPUNG BARU': 'https://senapelan.github.io/Home/data/foto/imgkegiatan/kampungbaru.png',
        'KELURAHAN KAMPUNG DALAM': 'https://senapelan.github.io/Home/data/foto/imgkegiatan/kampungdalam.png',
        'KELURAHAN PADANG BULAN': 'https://senapelan.github.io/Home/data/foto/imgkegiatan/padangbulan.png',
        'KELURAHAN PADANG TERUBUK': 'https://senapelan.github.io/Home/data/foto/imgkegiatan/padangterubuk.png',
        'KELURAHAN SAGO': 'https://senapelan.github.io/Home/data/foto/imgkegiatan/sago.png'
    };
    
    // ===========================================
    // STATE MANAGEMENT - FIX TIDAK TUTUP SENDIRI!
    // ===========================================
    function saveExpandedCard(cardId) {
        try {
            if (cardId) {
                localStorage.setItem(STORAGE_KEY, cardId);
                console.log('Card tersimpan:', cardId);
            } else {
                localStorage.removeItem(STORAGE_KEY);
                console.log('Card dihapus dari storage');
            }
            expandedCardId = cardId;
        } catch (e) {
            console.log('Storage error:', e);
        }
    }
    
    function getSavedExpandedCard() {
        try {
            return localStorage.getItem(STORAGE_KEY);
        } catch (e) {
            return null;
        }
    }
    
    // ===========================================
    // RESTORE EXPANDED CARD - PASTIKAN TETAP BUKA!
    // ===========================================
    function restoreExpandedCard() {
        const savedCardId = getSavedExpandedCard();
        if (!savedCardId) return;
        
        console.log('Mencoba restore card:', savedCardId);
        
        // Coba di highlight section
        let card = document.querySelector(`#highlightFeed [data-card-id="${savedCardId}"]`);
        
        // Coba di all section
        if (!card) {
            card = document.querySelector(`#newsFeed [data-card-id="${savedCardId}"]`);
        }
        
        if (card) {
            // Hapus expanded dari semua card dulu
            document.querySelectorAll('.card').forEach(c => c.classList.remove('expanded'));
            
            // Tambah expanded ke card yang disimpan
            card.classList.add('expanded');
            expandedCardId = savedCardId;
            console.log('âœ… Card berhasil direstore:', savedCardId);
            
            // Scroll ke card (opsional, biar user lihat)
            setTimeout(() => {
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
        } else {
            console.log('âŒ Card tidak ditemukan di DOM:', savedCardId);
            // Jangan hapus dari storage, mungkin akan muncul di fetch berikutnya
        }
    }
    
    // ===========================================
    // CEK STATUS ACARA (SELESAI, BERLANGSUNG, DATANG)
    // ===========================================
    function getEventStatus(tglMulai, waktuMulai, tglSelesai, waktuSelesai) {
        try {
            const sekarang = new Date();
            
            let dateMulai = parseDate(tglMulai, waktuMulai);
            let dateSelesai = parseDate(tglSelesai, waktuSelesai);
            
            if (!dateMulai || !dateSelesai) return 'TIDAK_DIKETAHUI';
            
            if (sekarang > dateSelesai) {
                return 'SELESAI';
            } else if (sekarang >= dateMulai && sekarang <= dateSelesai) {
                return 'BERLANGSUNG';
            } else {
                return 'DATANG';
            }
        } catch (e) {
            console.log('Error status:', e);
            return 'TIDAK_DIKETAHUI';
        }
    }
    
    function parseDate(tgl, waktu) {
        if (!tgl || !waktu) return null;
        
        try {
            let tanggalStr = tgl;
            if (tgl.includes('/')) {
                const parts = tgl.split('/');
                if (parts.length === 3) {
                    const bulan = parseInt(parts[0]) - 1;
                    const hari = parseInt(parts[1]);
                    let tahun = parseInt(parts[2]);
                    if (tahun < 100) tahun += 2000;
                    tanggalStr = `${tahun}-${bulan+1}-${hari}`;
                }
            }
            
            let jam = 0, menit = 0;
            if (waktu.includes('AM') || waktu.includes('PM')) {
                const match = waktu.match(/(\d{1,2}):(\d{2}):\d{2}\s*(AM|PM)/i);
                if (match) {
                    jam = parseInt(match[1]);
                    menit = parseInt(match[2]);
                    const ampm = match[3].toUpperCase();
                    if (ampm === 'PM' && jam !== 12) jam += 12;
                    if (ampm === 'AM' && jam === 12) jam = 0;
                }
            } else if (waktu.includes('T')) {
                const match = waktu.match(/T(\d{2}):(\d{2})/);
                if (match) {
                    jam = parseInt(match[1]);
                    menit = parseInt(match[2]);
                    if (jam > 23) jam -= 24;
                }
            } else {
                const match = waktu.match(/(\d{1,2}):(\d{2})/);
                if (match) {
                    jam = parseInt(match[1]);
                    menit = parseInt(match[2]);
                    if (jam > 23) jam -= 24;
                }
            }
            
            const date = new Date(tanggalStr);
            if (!isNaN(date.getTime())) {
                date.setHours(jam, menit, 0);
                return date;
            }
        } catch (e) {}
        return null;
    }
    
    // ===========================================
    // HITUNG MUNDUR
    // ===========================================
    function getCountdownText(tglMulai, waktuMulai) {
        const dateMulai = parseDate(tglMulai, waktuMulai);
        if (!dateMulai) return '';
        
        const sekarang = new Date();
        const diffMs = dateMulai - sekarang;
        
        if (diffMs <= 0) return '';
        
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
        
        if (diffDays > 0) {
            return `<span class="countdown-badge"><i class="fas fa-hourglass-half"></i> ${diffDays} Hari ${diffHours} Jam</span>`;
        } else if (diffHours > 0) {
            return `<span class="countdown-badge"><i class="fas fa-hourglass-half"></i> ${diffHours} Jam ${diffMinutes} Menit</span>`;
        } else {
            return `<span class="countdown-badge"><i class="fas fa-hourglass-start"></i> ${diffMinutes} Menit</span>`;
        }
    }
    
    // ===========================================
    // AMBIL EXCERPT DARI ISI KONTEN
    // ===========================================
    function getExcerpt(text, maxLength = 60) {
        if (!text) return '';
        text = text.replace(/<[^>]*>/g, '');
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }
    
    // ===========================================
    // GET DEFAULT FOTO
    // ===========================================
    function getDefaultFoto(instansi) {
        const key = instansi.toUpperCase().trim();
        if (DEFAULT_FOTO[key]) {
            return DEFAULT_FOTO[key];
        }
        return 'https://senapelan.github.io/Home/data/foto/imgkegiatan/senapelan.png';
    }
    
    // ===========================================
    // FORMAT WAKTU
    // ===========================================
    function formatTanggalIndonesia(dateString) {
        if (!dateString) return null;
        try {
            const cleanDate = dateString.split(' ')[0];
            const parts = cleanDate.split('/');
            if (parts.length === 3) {
                const bulan = parseInt(parts[0]);
                const hari = parseInt(parts[1]);
                const tahun = parseInt(parts[2]);
                const namaBulan = [
                    'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                    'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
                ];
                if (bulan >= 1 && bulan <= 12) {
                    return `${hari} ${namaBulan[bulan-1]} ${tahun}`;
                }
            }
        } catch {}
        return null;
    }
    
    function formatWaktuIndonesia(waktuString) {
        if (!waktuString) return null;
        try {
            waktuString = waktuString.trim();
            
            if (waktuString.includes('AM') || waktuString.includes('PM')) {
                const match = waktuString.match(/(\d{1,2}):(\d{2}):\d{2}\s*(AM|PM)/i);
                if (match) {
                    let jam = parseInt(match[1]);
                    const menit = match[2];
                    const ampm = match[3].toUpperCase();
                    
                    if (ampm === 'PM' && jam !== 12) jam += 12;
                    if (ampm === 'AM' && jam === 12) jam = 0;
                    
                    return `${jam.toString().padStart(2, '0')}.${menit} WIB`;
                }
            }
            
            if (waktuString.includes('1899') || waktuString.includes('T')) {
                const match = waktuString.match(/T(\d{2}):(\d{2})/);
                if (match) {
                    let jam = parseInt(match[1]);
                    const menit = match[2];
                    if (jam > 23) jam = jam - 24;
                    return `${jam.toString().padStart(2, '0')}.${menit} WIB`;
                }
            }
            
            const match = waktuString.match(/(\d{1,2}):(\d{2})/);
            if (match) {
                let jam = parseInt(match[1]);
                const menit = match[2];
                if (jam > 23) jam = jam - 24;
                return `${jam.toString().padStart(2, '0')}.${menit} WIB`;
            }
            
        } catch (e) {}
        return null;
    }
    
    function formatDurasiAcara(tglMulai, waktuMulai, tglSelesai, waktuSelesai) {
        const tanggalMulai = formatTanggalIndonesia(tglMulai);
        const jamMulai = formatWaktuIndonesia(waktuMulai);
        const tanggalSelesai = formatTanggalIndonesia(tglSelesai);
        const jamSelesai = formatWaktuIndonesia(waktuSelesai);
        
        if (tglMulai === tglSelesai && jamMulai && jamSelesai) {
            return `
                <div class="time-display">
                    <span class="date-badge">
                        <i class="far fa-calendar-alt"></i> ${tanggalMulai || tglMulai}
                    </span>
                    <span class="time-badge">
                        <i class="far fa-clock"></i> ${jamMulai.replace('WIB', '')} â€” ${jamSelesai}
                    </span>
                </div>
            `;
        } else if (tanggalMulai && jamMulai && tanggalSelesai && jamSelesai) {
            return `
                <div class="time-display">
                    <span class="date-badge">
                        <i class="far fa-calendar-alt"></i> ${tanggalMulai} ${jamMulai}
                    </span>
                    <span style="color: #94a3b8;"><i class="fas fa-arrow-right"></i></span>
                    <span class="date-badge">
                        <i class="far fa-calendar-alt"></i> ${tanggalSelesai} ${jamSelesai}
                    </span>
                </div>
            `;
        }
        return `
            <div class="time-display">
                <span class="date-badge">
                    <i class="far fa-calendar-alt"></i> ${tglMulai || '?'} ${waktuMulai || ''}
                </span>
            </div>
        `;
    }
    
    // ===========================================
    // CEK LINK GOOGLE MAPS
    // ===========================================
    function isGoogleMapsLink(text) {
        if (!text) return false;
        const mapPatterns = [
            'google.com/maps',
            'goo.gl/maps',
            'maps.app.goo.gl',
            'google.co.id/maps',
            'maps.google.com'
        ];
        return mapPatterns.some(pattern => text.includes(pattern));
    }
    
    // ===========================================
    // CEK POSTINGAN BARU (24 JAM)
    // ===========================================
    function isLessThan24Hours(timestamp) {
        if (!timestamp) return false;
        try {
            const postDate = new Date(timestamp);
            if (isNaN(postDate.getTime())) return false;
            const now = new Date();
            return (now - postDate) / (1000 * 60 * 60) < 24;
        } catch {
            return false;
        }
    }
    
    // ===========================================
    // PRINT CARD KE PDF
    // ===========================================
    window.printCard = function(cardId) {
        const card = document.querySelector(`[data-card-id="${cardId}"]`);
        if (!card) return;
        
        const printContent = card.cloneNode(true);
        
        const printBtn = printContent.querySelector('.btn-print');
        if (printBtn) printBtn.remove();
        
        const style = document.createElement('style');
        style.innerHTML = `
            @page { size: A4; margin: 1cm; }
            body { font-family: 'Inter', sans-serif; padding: 20px; background: white; }
            .card { 
                border: 1px solid #ddd; 
                border-radius: 28px; 
                padding: 24px; 
                max-width: 800px; 
                margin: 0 auto; 
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            }
            .thumbnail { display: none; }
            .arrow-toggle { display: none; }
            .status-label { display: inline-block; position: static; margin-bottom: 16px; }
            .card-detail { max-height: none; opacity: 1; padding: 0; border: none; }
            .detail-foto-img { max-width: 100%; height: auto; }
            .btn-map { display: inline-block; background: #e11d48; color: white; padding: 8px 16px; border-radius: 40px; text-decoration: none; }
        `;
        
        printContent.appendChild(style);
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
                <head>
                    <title>Cetak Kegiatan</title>
                    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
                </head>
                <body>
                    ${printContent.outerHTML}
                    <div style="text-align: center; margin-top: 20px; color: #666;">
                        Dicetak dari Senapelan Satu Pintu Â· ${new Date().toLocaleDateString('id-ID')}
                    </div>
                    <script>
                        window.onload = function() { window.print(); window.onafterprint = function() { window.close(); } }
                    <\/script>
                </body>
            </html>
        `);
        printWindow.document.close();
    };
    
    // ===========================================
    // TOGGLE CARD - FIX TIDAK TUTUP SENDIRI!
    // ===========================================
    window.toggleCard = function(cardId) {
        const card = document.querySelector(`[data-card-id="${cardId}"]`);
        if (card) {
            if (card.classList.contains('expanded')) {
                card.classList.remove('expanded');
                saveExpandedCard(null);
                console.log('Card ditutup:', cardId);
            } else {
                // Tutup semua card lain
                document.querySelectorAll('.card').forEach(c => {
                    if (c !== card) {
                        c.classList.remove('expanded');
                    }
                });
                
                // Buka card ini
                card.classList.add('expanded');
                saveExpandedCard(cardId);
                console.log('Card dibuka & disimpan:', cardId);
            }
        }
    };
    
    // ===========================================
    // FILTER FUNCTIONS
    // ===========================================
    function applyFilter() {
        const instansi = document.getElementById('filterInstansi').value;
        const status = document.getElementById('filterStatus').value;
        
        currentFilter = { instansi, status };
        
        filteredData = allData.filter(item => {
            if (instansi !== 'SEMUA') {
                const itemInstansi = (item.instansi || '').toUpperCase().trim();
                const filterInstansi = instansi.toUpperCase().trim();
                if (itemInstansi !== filterInstansi) return false;
            }
            
            if (status !== 'SEMUA') {
                const itemStatus = getEventStatus(item.tglMulai, item.waktuMulai, item.tglSelesai, item.waktuSelesai);
                if (status === 'BERLANGSUNG' && itemStatus !== 'BERLANGSUNG') return false;
                if (status === 'DATANG' && itemStatus !== 'DATANG') return false;
                if (status === 'SELESAI' && itemStatus !== 'SELESAI') return false;
            }
            
            return true;
        });
        
        updateFilterBadge();
        renderAll();
        
        // RESTORE CARD SETELAH FILTER
        setTimeout(() => {
            restoreExpandedCard();
        }, 300);
    }
    
    function resetFilter() {
        document.getElementById('filterInstansi').value = 'SEMUA';
        document.getElementById('filterStatus').value = 'SEMUA';
        currentFilter = { instansi: 'SEMUA', status: 'SEMUA' };
        filteredData = [...allData];
        document.getElementById('activeFilterBadge').style.display = 'none';
        renderAll();
        
        // RESTORE CARD SETELAH RESET
        setTimeout(() => {
            restoreExpandedCard();
        }, 300);
    }
    
    function updateFilterBadge() {
        const badge = document.getElementById('activeFilterBadge');
        const filterText = document.getElementById('filterText');
        
        if (currentFilter.instansi === 'SEMUA' && currentFilter.status === 'SEMUA') {
            badge.style.display = 'none';
            return;
        }
        
        let text = [];
        if (currentFilter.instansi !== 'SEMUA') {
            text.push(currentFilter.instansi);
        }
        if (currentFilter.status !== 'SEMUA') {
            let statusText = '';
            if (currentFilter.status === 'BERLANGSUNG') statusText = 'Sedang Berlangsung';
            else if (currentFilter.status === 'DATANG') statusText = 'Akan Datang';
            else if (currentFilter.status === 'SELESAI') statusText = 'Telah Selesai';
            text.push(statusText);
        }
        
        filterText.innerHTML = text.join(' Â· ');
        badge.style.display = 'flex';
    }
    
    // ===========================================
    // RENDER ALL CARDS
    // ===========================================
    function renderAll() {
        const stats = calculateStats(filteredData);
        updateStats(stats);
        
        const berlangsung = filteredData.filter(item => 
            getEventStatus(item.tglMulai, item.waktuMulai, item.tglSelesai, item.waktuSelesai) === 'BERLANGSUNG'
        );
        const datang = filteredData.filter(item => 
            getEventStatus(item.tglMulai, item.waktuMulai, item.tglSelesai, item.waktuSelesai) === 'DATANG'
        );
        
        const highlightData = [...berlangsung, ...datang];
        
        highlightData.sort((a, b) => {
            const statusA = getEventStatus(a.tglMulai, a.waktuMulai, a.tglSelesai, a.waktuSelesai);
            const statusB = getEventStatus(b.tglMulai, b.waktuMulai, b.tglSelesai, b.waktuSelesai);
            
            if (statusA === 'BERLANGSUNG' && statusB !== 'BERLANGSUNG') return -1;
            if (statusA !== 'BERLANGSUNG' && statusB === 'BERLANGSUNG') return 1;
            
            const dateA = parseDate(a.tglMulai, a.waktuMulai) || new Date();
            const dateB = parseDate(b.tglMulai, b.waktuMulai) || new Date();
            return dateA - dateB;
        });
        
        const allEventsData = [...filteredData];
        
        allEventsData.sort((a, b) => {
            const dateA = new Date(a.timestamp);
            const dateB = new Date(b.timestamp);
            return dateB - dateA;
        });
        
        const limit = currentLimit === 0 ? allEventsData.length : currentLimit;
        const limitedAllEvents = allEventsData.slice(0, limit);
        
        // RENDER HIGHLIGHT
        document.getElementById('highlightFeed').innerHTML = renderCards(highlightData, 'highlight');
        
        // RENDER ALL
        document.getElementById('newsFeed').innerHTML = renderCards(limitedAllEvents, 'all');
        
        document.getElementById('highlightCount').innerHTML = highlightData.length;
        document.getElementById('allEventsCount').innerHTML = limitedAllEvents.length;
        document.getElementById('showingInfo').innerHTML = `<i class="fas fa-info-circle"></i> Menampilkan ${limitedAllEvents.length} dari ${filteredData.length} kegiatan (Filter: ${currentFilter.instansi} Â· ${currentFilter.status})`;
    }
    
    function calculateStats(data) {
        let berlangsung = 0, datang = 0, selesai = 0;
        
        data.forEach(item => {
            const status = getEventStatus(item.tglMulai, item.waktuMulai, item.tglSelesai, item.waktuSelesai);
            if (status === 'BERLANGSUNG') berlangsung++;
            else if (status === 'DATANG') datang++;
            else if (status === 'SELESAI') selesai++;
        });
        
        return { berlangsung, datang, selesai, total: data.length };
    }
    
    function updateStats(stats) {
        document.getElementById('statBerlangsung').innerHTML = stats.berlangsung;
        document.getElementById('statDatang').innerHTML = stats.datang;
        document.getElementById('statSelesai').innerHTML = stats.selesai;
        document.getElementById('statTotal').innerHTML = stats.total;
    }
    
    // ===========================================
    // RENDER CARDS
    // ===========================================
    function renderCards(rows, section = 'all') {
        if (!rows || rows.length === 0) {
            return `
                <div class="empty-state">
                    <i class="fas fa-calendar-times" style="font-size: 42px; opacity: 0.5;"></i>
                    <h3 style="margin-top: 16px;">Tidak ada kegiatan</h3>
                    <p style="margin-top: 8px;">Belum ada kegiatan dengan status ini</p>
                </div>
            `;
        }
        
        let html = '';
        
        rows.forEach((row, index) => {
            const timestamp = row.timestamp || '';
            const instansi = row.instansi || 'INSTANSI';
            const tglMulai = row.tglMulai || '';
            const waktuMulai = row.waktuMulai || '';
            const tglSelesai = row.tglSelesai || '';
            const waktuSelesai = row.waktuSelesai || '';
            const lokasi = row.lokasi || 'Lokasi tidak tersedia';
            const linkMap = row.linkMap || '';
            let isiKonten = row.isiKonten || 'Tidak ada keterangan';
            const fotoUrl = row.fotoUrl || '';
            
            const status = getEventStatus(tglMulai, waktuMulai, tglSelesai, waktuSelesai);
            const selesai = (status === 'SELESAI');
            const berlangsung = (status === 'BERLANGSUNG');
            const datang = (status === 'DATANG');
            
            // ID UNIK - PASTIKAN KONSISTEN
            const cardId = `card-${section}-${index}-${timestamp.replace(/[^0-9]/g, '').slice(-6)}-${instansi.replace(/\s+/g, '').slice(0,5)}`;
            
            const defaultFoto = getDefaultFoto(instansi);
            const excerpt = getExcerpt(isiKonten, 60);
            const punyaLinkMap = linkMap && linkMap.trim() !== '' && isGoogleMapsLink(linkMap);
            const isNew = isLessThan24Hours(timestamp);
            const newBadge = isNew ? '<span class="badge-new"><i class="fas fa-bolt"></i>BARU</span>' : '';
            
            let tanggalPosting = '';
            try {
                const date = new Date(timestamp);
                if (!isNaN(date.getTime())) {
                    tanggalPosting = date.toLocaleDateString('id-ID', {
                        day: 'numeric', month: 'numeric', year: 'numeric'
                    });
                }
            } catch {}
            
            const waktuAcaraHTML = formatDurasiAcara(tglMulai, waktuMulai, tglSelesai, waktuSelesai);
            const countdownHTML = datang ? getCountdownText(tglMulai, waktuMulai) : '';
            
            let statusLabel = '';
            if (selesai) {
                statusLabel = '<span class="status-label selesai"><i class="fas fa-check-circle"></i> Acara Telah Selesai</span>';
            } else if (berlangsung) {
                statusLabel = '<span class="status-label berlangsung"><i class="fas fa-play-circle"></i> Sedang Berlangsung</span>';
            } else if (datang) {
                statusLabel = `<span class="status-label datang"><i class="fas fa-calendar-alt"></i> Akan Datang</span>`;
            }
            
            let cardClass = 'card';
            if (selesai) cardClass += ' selesai';
            else if (berlangsung) cardClass += ' berlangsung';
            else if (datang) cardClass += ' akan-datang';
            
            const thumbnailHtml = `<div class="thumbnail"><img src="${defaultFoto}" loading="lazy" onerror="this.parentElement.innerHTML='<i class=\\'fas fa-building\\' style=\\'font-size: 32px; color: #94a3b8;\\'></i>'"></div>`;
            
            html += `<div class="${cardClass}" data-card-id="${cardId}">
                ${statusLabel}
                <div class="card-preview" onclick="toggleCard('${cardId}')">
                    ${thumbnailHtml}
                    <div class="preview-content">
                        <div class="news-badge">
                            ${newBadge}
                            <span class="instansi-label"><i class="fas fa-building"></i> ${instansi}</span>
                            ${countdownHTML}
                        </div>
                        <div class="judul-berita">
                            <i class="fas fa-pen-square"></i> Update dari ${instansi}
                        </div>
                        <div class="preview-excerpt">
                            <i class="fas fa-quote-right"></i> ${excerpt}
                        </div>
                        <div class="meta-sumber">
                            <span class="sumber-text"><i class="fas fa-tag"></i> Sumber: ${instansi}</span>
                            <span><i class="far fa-clock"></i> ${tanggalPosting || ''}</span>
                        </div>
                    </div>
                    <div class="arrow-toggle">
                        <i class="fas fa-chevron-down"></i>
                    </div>
                </div>
                <div class="card-detail">
                    <div class="detail-inner">
                        <div class="isi-konten">${isiKonten.replace(/\n/g, '<br>')}</div>`;
            
            if (fotoUrl) {
                let fileId = '';
                if (fotoUrl.includes('open?id=')) {
                    fileId = fotoUrl.split('open?id=')[1].split('&')[0];
                } else if (fotoUrl.includes('file/d/')) {
                    const match = fotoUrl.match(/\/d\/(.*?)(\/|$)/);
                    if (match) fileId = match[1];
                }
                if (fileId) {
                    html += `
                        <div class="detail-foto">
                            <div class="detail-foto-title">
                                <i class="fas fa-camera"></i>
                                <span>Dokumentasi Kegiatan</span>
                            </div>
                            <img src="https://drive.google.com/thumbnail?id=${fileId}&sz=w800-h800" class="detail-foto-img" loading="lazy" onerror="this.style.display='none'; this.parentElement.innerHTML+='<p style=\\'color: #64748b; padding: 20px; text-align: center;\\'><i class=\\'fas fa-image-slash\\'></i> Foto tidak dapat ditampilkan</p>'">
                        </div>
                    `;
                }
            }
            
            html += `
                        <div class="info-section">
                            <div class="info-row">
                                <div class="info-icon">
                                    <i class="fas fa-map-marker-alt"></i>
                                </div>
                                <div class="info-content">
                                    <div class="info-label">ALAMAT LOKASI</div>
                                    <div class="alamat-text">${lokasi}</div>
                                </div>
                            </div>
                        </div>
                        
                        ${waktuAcaraHTML}
                        
                        <div class="button-group">
                            <button onclick="printCard('${cardId}')" class="btn btn-print">
                                <i class="fas fa-print"></i> Cetak/Print Card
                            </button>`;
            
            if (punyaLinkMap) {
                html += `<a href="${linkMap}" target="_blank" class="btn btn-map">
                            <i class="fas fa-map-marked-alt"></i> Buka Google Maps
                        </a>`;
            }
            
            html += `</div></div></div></div>`;
        });
        
        return html;
    }
    
    // ===========================================
    // FETCH DATA
    // ===========================================
    function fetchData() {
        const callbackName = 'handleData_' + Date.now();
        
        window[callbackName] = function(response) {
            const script = document.getElementById('jsonp-script');
            if (script) script.remove();
            retryCount = 0;
            
            if (response && response.success === true) {
                if (response.data && response.data.length > 0) {
                    allData = response.data;
                    filteredData = [...allData];
                    
                    applyFilter();
                    
                    document.getElementById('lastUpdate').innerHTML = 
                        `<i class="fas fa-check-circle" style="color:#10b981;"></i> Terakhir update: ${new Date().toLocaleTimeString('id-ID')} Â· ${allData.length} berita tersedia`;
                    
                    // RESTORE CARD SETELAH DATA DITERIMA
                    setTimeout(() => {
                        restoreExpandedCard();
                    }, 500);
                    
                } else {
                    allData = [];
                    filteredData = [];
                    renderAll();
                    document.getElementById('newsFeed').innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-newspaper" style="font-size: 42px; opacity: 0.5;"></i>
                            <h3 style="margin-top: 16px;">Belum ada informasi</h3>
                            <p style="margin-top: 8px;">Data akan muncul setelah ada pengisian form</p>
                        </div>
                    `;
                    document.getElementById('lastUpdate').innerHTML = 
                        `<i class="fas fa-info-circle" style="color:#64748b;"></i> Belum ada data Â· ${new Date().toLocaleTimeString('id-ID')}`;
                }
            } else {
                showError(response?.error || 'Format data tidak valid');
            }
            
            setTimeout(() => delete window[callbackName], 100);
        };
        
        const script = document.createElement('script');
        script.id = 'jsonp-script';
        script.src = `${APPS_SCRIPT_URL}?callback=${callbackName}&t=${Date.now()}`;
        
        script.onerror = function() {
            retryCount++;
            if (retryCount <= MAX_RETRY) {
                console.log(`Retry ${retryCount}/${MAX_RETRY}...`);
                setTimeout(fetchData, 2000);
            } else {
                showError('Tidak dapat terhubung ke server. Periksa URL Apps Script.');
            }
            delete window[callbackName];
            document.getElementById('jsonp-script')?.remove();
        };
        
        document.head.appendChild(script);
    }
    
    function showError(message) {
        document.getElementById('newsFeed').innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle" style="font-size: 36px; color: #b45309;"></i>
                <h3 style="margin-top: 16px;">Gagal mengambil data</h3>
                <p style="margin-top: 8px;">Mencoba menyambung kembali...</p>
                <p style="margin-top: 16px; font-size: 0.8rem; color: #64748b;">${message || 'Pastikan URL Apps Script sudah benar'}</p>
            </div>
        `;
        document.getElementById('lastUpdate').innerHTML = 
            `<i class="fas fa-exclamation-circle" style="color:#e11d48;"></i> Gagal sinkron Â· ${new Date().toLocaleTimeString('id-ID')}`;
    }
    
    // ===========================================
    // INITIALIZATION
    // ===========================================
    window.addEventListener('load', function() {
        console.log('ðŸš€ Aplikasi dimulai');
        
        document.getElementById('applyFilterBtn').addEventListener('click', applyFilter);
        document.getElementById('resetFilterBtn').addEventListener('click', resetFilter);
        document.getElementById('clearFilterBadge').addEventListener('click', resetFilter);
        
        document.getElementById('entryLimit').addEventListener('change', function(e) {
            currentLimit = parseInt(e.target.value);
            renderAll();
            
            // RESTORE CARD SETELAH GANTI LIMIT
            setTimeout(() => {
                restoreExpandedCard();
            }, 300);
        });
        
        // Langsung coba restore dari storage saat load
        const savedCardId = getSavedExpandedCard();
        if (savedCardId) {
            console.log('ðŸ“¦ Ditemukan card tersimpan di localStorage:', savedCardId);
            expandedCardId = savedCardId;
        }
        
        // Fetch data pertama
        fetchData();
        
        // Auto refresh setiap 10 detik - TAPI JANGAN HAPUS EXPANDED CARD!
        setInterval(() => {
            console.log('ðŸ”„ Auto refresh...');
            fetchData();
            // JANGAN panggil restoreExpandedCard di sini karena sudah dipanggil di fetchData
        }, 10000);
    });
    
    // ===========================================
    // PASTIKAN CARD TETAP TERBUKA SAAT MUTASI DOM
    // ===========================================
    // Observer untuk mendeteksi perubahan DOM dan merestore card
    const observer = new MutationObserver(function(mutations) {
        // Jika ada card yang hilang atau berubah
        if (expandedCardId) {
            // Tunggu sebentar biar DOM selesai berubah
            setTimeout(() => {
                const card = document.querySelector(`[data-card-id="${expandedCardId}"]`);
                if (card && !card.classList.contains('expanded')) {
                    console.log('ðŸ”„ Memulihkan card yang terbuka:', expandedCardId);
                    card.classList.add('expanded');
                }
            }, 200);
        }
    });
    
    // Observasi perubahan di newsFeed dan highlightFeed
    window.addEventListener('load', function() {
        const newsFeed = document.getElementById('newsFeed');
        const highlightFeed = document.getElementById('highlightFeed');
        
        if (newsFeed) {
            observer.observe(newsFeed, { childList: true, subtree: true });
        }
        if (highlightFeed) {
            observer.observe(highlightFeed, { childList: true, subtree: true });
        }
    });
    </script>
</body>
</html>
