<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Form Input Data KK</title>

<style>
:root{
  --primary:#2563eb;
  --secondary:#0f172a;
  --bg:#f8fafc;
  --card:#ffffff;
  --border:#e5e7eb;
  --muted:#64748b;
}
*{box-sizing:border-box;font-family:Inter,system-ui,sans-serif}
body{background:var(--bg);margin:0;padding:20px;color:#0f172a;}
.container{max-width:1100px;margin:auto;}
h1{margin-bottom:16px;}
.kk-check{background:var(--card);border:1px solid var(--border);padding:16px;border-radius:12px;display:flex;gap:12px;align-items:center;}
.kk-check input{flex:1;padding:12px;font-size:16px;}
button{padding:12px 16px;border:none;border-radius:10px;cursor:pointer;font-weight:600;}
.btn-primary{background:var(--primary);color:white}
.btn-secondary{background:#e5e7eb}
.btn-danger{background:#dc2626;color:white}
.info-kk{margin-top:16px;padding:16px;background:var(--card);border:1px solid var(--border);border-radius:12px;display:none;}
.cards{margin-top:16px;}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;margin-bottom:12px;overflow:hidden;}
.card-header{padding:14px 16px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;background:#f1f5f9;}
.card-body{padding:16px;display:none;}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;}
label{font-size:13px;color:var(--muted);}
input,select{width:100%;padding:10px;margin-top:4px;}
.actions{margin-top:20px;display:flex;gap:12px;flex-wrap:wrap;}
</style>
</head>
<body>

<div class="container">
<h1>ðŸ“‹ Form Input Data Kartu Keluarga</h1>

<div class="kk-check">
  <input type="text" id="noKK" placeholder="Masukkan Nomor KK">
  <button class="btn-primary" onclick="cekKK()">Cek Data</button>
</div>

<div class="info-kk" id="infoKK">
  <strong>Info Keluarga</strong><br>
  No KK: <span id="infoNoKK"></span><br>
  Kode Keluarga: <span id="infoKode">Auto</span>
</div>

<!-- FORM DATA KELUARGA -->
<div class="info-kk" id="formKeluarga">
  <strong>Data Keluarga</strong>
  <div class="grid" style="margin-top:10px">
    <div><label>Alamat</label><input id="alamat"></div>
    <div><label>RT</label><input id="rt"></div>
    <div><label>RW</label><input id="rw"></div>
    <div><label>Kelurahan</label><input id="kelurahan" value="Padang Terubuk"></div>
    <div><label>Kecamatan</label><input id="kecamatan" value="Senapelan"></div>
    <div><label>Kota/Kabupaten</label><input id="kota" value="Pekanbaru"></div>
    <div><label>Provinsi</label><input id="provinsi" value="Riau"></div>
  </div>
</div>

<div class="cards" id="cards"></div>

<div class="actions">
  <button class="btn-secondary" onclick="tambahAnggota()">+ Tambah Anggota</button>
  <button class="btn-primary" onclick="enableEdit()">Edit Data</button>
  <button class="btn-primary" onclick="simpanData()">Update Data</button>
  <button class="btn-danger" onclick="resetForm()">Batal / Reset</button>
</div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz26Oc1BcaIOlViRwIrjh6xF0PPhQ_qkJRPPMy8X-8sq8cSK11ixBEQkvul_17KAd1L/exec";
const maxAnggota = 10;

async function cekKK(){
  const kk = noKK.value.trim();
  if(!kk) return alert("No KK wajib diisi");

  const res = await fetch(WEB_APP_URL,{method:"POST",body:JSON.stringify({action:"cekKK",no_kk:kk})});
  const data = await res.json();

  infoKK.style.display = "block";
  formKeluarga.style.display = "block";
  infoNoKK.innerText = kk;
  infoKode.innerText = data.status;
  cards.innerHTML = "";

  if(data.keluarga){
    alamat.value = data.keluarga.alamat || "";
    rt.value = data.keluarga.rt || "";
    rw.value = data.keluarga.rw || "";
    kelurahan.value = data.keluarga.kelurahan || "";
    kecamatan.value = data.keluarga.kecamatan || "";
    kota.value = data.keluarga.kota || "";
    provinsi.value = data.keluarga.provinsi || "";
  }

  if(data.status === "BARU"){
    tambahAnggota();
  }

  if(data.status === "ADA"){
    data.anggota.forEach(row=>{
      tambahAnggota();
      const inputs = document.querySelectorAll(".card:last-child input, .card:last-child select");
      inputs[0].value=row[10]||"";
      inputs[1].value=row[11]||"";
    });
  }
}

async function simpanData(){
  const cardsEl = document.querySelectorAll('.card');
  let anggota=[];
  cardsEl.forEach(card=>{
    const i=card.querySelectorAll('input,select');
    anggota.push({nama:i[0].value,nik:i[1].value});
  });

  const payload={
    action:"simpanKK",
    no_kk:noKK.value,
    alamat:alamat.value,
    rt:rt.value,
    rw:rw.value,
    kelurahan:kelurahan.value,
    kecamatan:kecamatan.value,
    kota:kota.value,
    provinsi:provinsi.value,
    anggota:anggota,
    petugas:"Admin Kelurahan"
  };

  const res=await fetch(WEB_APP_URL,{method:"POST",body:JSON.stringify(payload)});
  const json=await res.json();
  alert("Berhasil simpan data\nKode: "+json.kode_keluarga);
}

function tambahAnggota(){
  const card=document.createElement("div");
  card.className="card";
  card.innerHTML=`<div class="card-header" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='block'?'none':'block'">Anggota</div>
  <div class="card-body" style="display:block">
    <div class="grid">
      <div><label>Nama</label><input></div>
      <div><label>NIK</label><input></div>
    </div>
  </div>`;
  cards.appendChild(card);
}

function enableEdit(){}
function resetForm(){}
</script>

</body>
</html>
