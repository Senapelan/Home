<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Form Input Data KK</title>

<style>
:root{
  --primary:#2563eb;
  --secondary:#0f172a;
  --bg:#f8fafc;
  --card:#ffffff;
  --border:#e5e7eb;
  --muted:#64748b;
}

*{box-sizing:border-box;font-family:Inter,system-ui,sans-serif}

body{
  background:var(--bg);
  margin:0;
  padding:20px;
  color:#0f172a;
}

.container{
  max-width:1100px;
  margin:auto;
}

/* ================= HEADER ================= */
h1{
  margin-bottom:16px;
}

/* ================= CEK KK ================= */
.kk-check{
  background:var(--card);
  border:1px solid var(--border);
  padding:16px;
  border-radius:12px;
  display:flex;
  gap:12px;
  align-items:center;
}

.kk-check input{
  flex:1;
  padding:12px;
  font-size:16px;
}

button{
  padding:12px 16px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-weight:600;
}

.btn-primary{background:var(--primary);color:white}
.btn-secondary{background:#e5e7eb}
.btn-danger{background:#dc2626;color:white}

/* ================= INFO KK ================= */
.info-kk{
  margin-top:16px;
  padding:16px;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:12px;
  display:none;
}

/* ================= KARTU ANGGOTA ================= */
.cards{
  margin-top:16px;
}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  margin-bottom:12px;
  overflow:hidden;
}

.card-header{
  padding:14px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:pointer;
  background:#f1f5f9;
}

.card.status-aktif {
  border-left: 6px solid #16a34a;
  background: #f0fdf4;
}

.card.status-pindah {
  border-left: 6px solid #ea580c;
  background: #fff7ed;
}

.card.status-meninggal {
  border-left: 6px solid #334155;
  background: #f1f5f9;
}

.card.status-nonaktif {
  border-left: 6px solid #64748b;
  background: #f8fafc;
}

.badge{
  padding:4px 10px;
  border-radius:20px;
  font-size:12px;
  font-weight:600;
}

.badge.active{background:#dcfce7;color:#166534}
.badge.inactive{background:#f1f5f9;color:#475569}

.card-body{
  padding:16px;
  display:none;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:12px;
}

label{
  font-size:13px;
  color:var(--muted);
}

input,select{
  width:100%;
  padding:10px;
  margin-top:4px;
}

/* ================= FOOTER BUTTON ================= */
.actions{
  margin-top:20px;
  display:flex;
  gap:12px;
  flex-wrap:wrap;
}
</style>
</head>
<body>

<div class="container">
<h1>üìã Form Input Data Kartu Keluarga</h1>

<!-- CEK KK -->
<div class="kk-check">
  <input type="text" id="noKK" placeholder="Masukkan Nomor KK">
  <button class="btn-primary" onclick="cekKK()">Cek Data</button>
</div>

<!-- INFO KK -->
<div class="info-kk" id="infoKK">
  <strong>Info Keluarga</strong><br>
  No KK: <span id="infoNoKK"></span><br>
  Kode Keluarga: <span id="infoKode">Auto</span>
</div>

<!-- KARTU ANGGOTA -->
<div class="cards" id="cards"></div>

<!-- ACTIONS -->
<div class="actions">
  <button class="btn-secondary" onclick="tambahAnggota()">+ Tambah Anggota</button>
  <button class="btn-primary" onclick="enableEdit()">Edit Data</button>
  <button class="btn-primary" onclick="simpanData()">Update Data</button>
  <button class="btn-danger" onclick="resetForm()">Batal / Reset</button>
</div>

</div>

<script>
/* ================= CONFIG ================= */
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz26Oc1BcaIOlViRwIrjh6xF0PPhQ_qkJRPPMy8X-8sq8cSK11ixBEQkvul_17KAd1L/exec";
let editMode = false;
const maxAnggota = 10;

/* ================= CEK KK ================= */
async function cekKK(){
  const kk = document.getElementById('noKK').value.trim();
  if(!kk) return alert("No KK wajib diisi");

  try{
    const res = await fetch(WEB_APP_URL,{
      method:"POST",
      body: JSON.stringify({
        action:"cekKK",
        no_kk: kk
      })
    });

    const data = await res.json();

    document.getElementById('infoKK').style.display = 'block';
    document.getElementById('infoNoKK').innerText = kk;
    document.getElementById('infoKode').innerText = data.status;
    document.getElementById('cards').innerHTML = '';

    if(data.status === "BARU"){
      alert("KK belum terdata. Silakan isi data baru.");
      tambahAnggota();
      setReadOnly(false);
    }

    if(data.status === "ADA"){
  alert("KK sudah terdata. Mode baca aktif.");

  data.anggota.forEach((row, i)=>{
    tambahAnggota();

    const card = document.querySelectorAll('.card')[i];
    const inputs = card.querySelectorAll('input, select');

    console.log("RAW tanggal lahir:", data.anggota[0][14]);
    console.log("RAW tanggal kawin:", data.anggota[0][21]);


    inputs[0].value  = row[10] || ""; // Nama
    inputs[1].value  = row[11] || ""; // NIK
    inputs[2].value  = row[12] || "-"; // JK
    inputs[3].value  = row[13] || ""; // Tempat lahir
    inputs[4].value  = toInputDate(row[14]); // Tgl lahir
    inputs[5].value  = row[18] || "-"; // Gol darah
    inputs[6].value  = row[15] || "-"; // Agama
    inputs[7].value  = row[16] || "-"; // Pendidikan
    inputs[8].value  = row[17] || "";  // Pekerjaan

    inputs[9].value  = row[19] || "-"; // Status hubungan
    inputs[10].value = row[20] || "-"; // Status kawin
    inputs[11].value = toInputDate(row[21]); // Tgl kawin

    inputs[12].value = row[22] || "-"; // Kewarganegaraan
    inputs[13].value = row[24] || "";  // No paspor
    inputs[14].value = row[25] || "";  // NIKITAP

    inputs[15].value = row[26] || "";  // Ayah
    inputs[16].value = row[27] || "";  // Ibu

    inputs[17].value = row[23] || "Aktif"; // Status anggota
    inputs[18].value = row[28] || "-"; // Status kekayaan
    inputs[19].value = row[29] || "-"; // Status LPS
    inputs[20].value = row[30] || "-"; // Status kesehatan
  });

  setReadOnly(true);
}


  }catch(err){
    console.error(err);
    alert("Gagal terhubung ke server");
  }
}

/* ================= TAMBAH ANGGOTA ================= */
function tambahAnggota(){
  const jumlah = document.querySelectorAll('.card').length;
  if(jumlah >= maxAnggota){
    alert("Maksimal 10 anggota");
    return;
  }

  const idx = jumlah + 1;
  const card = document.createElement('div');
  card.className = 'card status-aktif';

  card.innerHTML = `
  <div class="card-header" onclick="toggleCard(this)">
    <div>üë§ Anggota ${idx}</div>
    <span class="badge active">Aktif</span>
  </div>

  <div class="card-body" style="display:block">

    <h4>Identitas Dasar</h4>
    <div class="grid">
      <div><label>Nama Lengkap</label><input></div>
      <div><label>NIK</label><input></div>
      <div>
        <label>Jenis Kelamin</label>
        <select>
          <option>-</option>
          <option>Laki-laki</option>
          <option>Perempuan</option>
        </select>
      </div>
      <div><label>Tempat Lahir</label><input></div>
      <div><label>Tanggal Lahir</label><input type="date"></div>
      <div>
        <label>Golongan Darah</label>
        <select>
          <option>-</option>
          <option>A</option><option>B</option><option>AB</option><option>O</option>
        </select>
      </div>
      <div>
        <label>Agama</label>
        <select>
          <option>-</option>
          <option>Islam</option>
          <option>Kristen</option>
          <option>Katholik</option>
          <option>Hindu</option>
          <option>Buddha</option>
          <option>Konghucu</option>
        </select>
      </div>
      <div>
        <label>Pendidikan</label>
        <select>
          <option>-</option>
          <option>Tidak / Belum Sekolah</option>
          <option>SD / Sederajat</option>
          <option>SLTP / Sederajat</option>
          <option>SLTA / Sederajat</option>
          <option>Diploma</option>
          <option>Sarjana</option>
          <option>Pascasarjana</option>
        </select>
      </div>
      <div><label>Pekerjaan</label><input></div>
    </div>

    <h4>Status & Relasi Keluarga</h4>
    <div class="grid">
      <div>
        <label>Status Hubungan Keluarga</label>
        <select>
          <option>-</option>
          <option>Kepala Keluarga</option>
          <option>Istri</option>
          <option>Anak</option>
          <option>Orang Tua</option>
          <option>Famili Lain</option>
        </select>
      </div>
      <div>
        <label>Status Perkawinan</label>
        <select>
          <option>-</option>
          <option>Kawin Tercatat</option>
          <option>Kawin Tidak Tercatat</option>
          <option>Belum Kawin</option>
          <option>Cerai Hidup</option>
          <option>Cerai Mati</option>
        </select>
      </div>
      <div><label>Tanggal Perkawinan</label><input type="date"></div>
    </div>

    <h4>Kewarganegaraan & Imigrasi</h4>
    <div class="grid">
      <div>
        <label>Kewarganegaraan</label>
        <select>
          <option>-</option>
          <option>WNI</option>
          <option>WNA</option>
        </select>
      </div>
      <div><label>No Paspor</label><input></div>
      <div><label>NIKITAP</label><input></div>
    </div>

    <h4>Orang Tua</h4>
    <div class="grid">
      <div><label>Nama Ayah</label><input></div>
      <div><label>Nama Ibu</label><input></div>
    </div>

    <h4>Status Administratif</h4>
    <div class="grid">
      <div>
        <label>Status Anggota</label>
        <select onchange="confirmStatusChange(this)">
          <option>Aktif</option>
          <option>Meninggal</option>
          <option>Pindah</option>
          <option>Tidak Aktif</option>
        </select>
      </div>
      <div><label>Status Kekayaan</label>
      <select>
          <option>-</option>
          <option>Mampu</option>
          <option>Tidak Mampu</option>
        </select>
        </div>
      <div><label>Status LPS</label>
      <select>
          <option>-</option>
          <option>Peserta LPS</option>
          <option>Peserta Subsidi Silang</option>
          <option>Peserta DLHK</option>
          <option>Tidak Ikut LPS</option>
        </select>
        </div>
      <div><label>Status Kesehatan</label>
      <select>
          <option>-</option>
          <option>Memiliki BPJS</option>
          <option>Tidak Memiliki BPJS</option>
        </select>
        </div>
    </div>

  </div>`;

  document.getElementById('cards').appendChild(card);
}

function toggleCard(header){
  const body=header.nextElementSibling;
  body.style.display=body.style.display==='block'?'none':'block';
}

function enableEdit(){
  setReadOnly(false);
}

function setReadOnly(state){
  editMode=!state;
  document.querySelectorAll('input,select').forEach(el=>{
    el.disabled=state;
  });
}

function resetForm(){
  setReadOnly(true);
  alert("Perubahan dibatalkan");
}

function simpanData(){
  const ok = confirm(
    "Apakah Anda yakin menyimpan perubahan data keluarga ini?"
  );

  if(!ok) return;

  alert("Data siap dikirim ke Spreadsheet üëç");
}
</script>

<script>
<select onchange=
  const card = select.closest('.card');
  const body = card.querySelector('.card-body');
  const badge = card.querySelector('.badge');
  const inputs = body.querySelectorAll('input, select');

  // reset kelas warna
  card.classList.remove(
    'status-aktif',
    'status-pindah',
    'status-meninggal',
    'status-nonaktif'
  );

  const status = select.value;

  if(status === 'Tidak Aktif' || status === 'Meninggal'){
    inputs.forEach(el=>{
      if(el !== select){
        el.value = '-';
        el.disabled = true;
      }
    });

    badge.className = 'badge inactive';
    badge.innerText = status;

    card.classList.add(
      status === 'Meninggal' ? 'status-meninggal' : 'status-nonaktif'
    );

    body.style.display = 'none';
  }

  else if(status === 'Pindah'){
    inputs.forEach(el=>el.disabled=false);

    badge.className = 'badge inactive';
    badge.innerText = 'Pindah';

    card.classList.add('status-pindah');
  }

  else { // Aktif
    inputs.forEach(el=>{
      if(el.value === '-') el.value = '';
      el.disabled = false;
    });

    badge.className = 'badge active';
    badge.innerText = 'Aktif';

    card.classList.add('status-aktif');
  }
}
</script>

<script>
function confirmStatusChange(select){
  const status = select.value;

  if(status === 'Meninggal' || status === 'Tidak Aktif'){
    const ok = confirm(
      `Status "${status}" akan mengosongkan seluruh data anggota ini.\n\nLanjutkan?`
    );

    if(!ok){
      select.value = 'Aktif';
      return;
    }
  }

  handleStatus(select);
}
</script>

<script>
async function simpanData(){
  const cards = document.querySelectorAll('.card');
  let anggota = [];

  cards.forEach(card=>{
    const inputs = card.querySelectorAll('input, select');

    anggota.push({
      nama: inputs[0].value,
      nik: inputs[1].value,
      jk: inputs[2].value,
      tempat_lahir: inputs[3].value,
      tgl_lahir: inputs[4].value,
      gol_darah: inputs[5].value,
      agama: inputs[6].value,
      pendidikan: inputs[7].value,
      pekerjaan: inputs[8].value,
      status_hubungan: inputs[9].value,
      status_kawin: inputs[10].value,
      tgl_kawin: inputs[11].value,
      kewarganegaraan: inputs[12].value,
      no_paspor: inputs[13].value,
      nikitap: inputs[14].value,
      ayah: inputs[15].value,
      ibu: inputs[16].value,
      status_anggota: inputs[17].value,
      status_kekayaan: inputs[18].value,
      status_lps: inputs[19].value,
      status_kesehatan: inputs[20].value,
    });
  });

  const payload = {
    action: "simpanKK",
    no_kk: document.getElementById('noKK').value,
    alamat: "-",
    rt: "-",
    rw: "-",
    kelurahan: "Padang Terubuk",
    kecamatan: "Senapelan",
    kota: "Pekanbaru",
    provinsi: "Riau",
    anggota: anggota,
    petugas: "Admin Kelurahan"
  };

  const res = await fetch(WEB_APP_URL,{
    method:"POST",
    body: JSON.stringify(payload)
  });

  const json = await res.json();
  alert("Berhasil simpan data KK\nKode Keluarga: " + json.kode_keluarga);
}
</script>

<script>
function toInputDate(val){
  if(!val) return "";

  // Kalau dari Apps Script (ISO string: 2024-02-21T00:00:00.000Z)
  if (typeof val === "string" && val.includes("T")) {
    return val.split("T")[0];
  }

  // Kalau format dd/MM/yyyy
  if (typeof val === "string" && val.includes("/")) {
    const [d, m, y] = val.split("/");
    if (y && m && d) {
      return `${y}-${m.padStart(2,"0")}-${d.padStart(2,"0")}`;
    }
  }

  // Kalau sudah yyyy-MM-dd
  if (typeof val === "string" && /^\d{4}-\d{2}-\d{2}$/.test(val)) {
    return val;
  }

  // Kalau Date object (kadang dikirim sebagai object)
  const dt = new Date(val);
  if (!isNaN(dt)) {
    const y = dt.getFullYear();
    const m = String(dt.getMonth() + 1).padStart(2, "0");
    const d = String(dt.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }

  return "";
}</script>




</body>
</html>
