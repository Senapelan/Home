<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Informasi Senapelan · Real-time</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* [SAME STYLES - Premium] */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(145deg, #f6f9fc 0%, #edf2f7 100%);
            font-family: 'Inter', sans-serif;
            padding: 32px 24px;
            min-height: 100vh;
            color: #1e293b;
        }
        .container {
            max-width: 1100px;
            width: 100%;
            margin: 0 auto;
        }
        .header {
            margin-bottom: 40px;
        }
        .header h1 {
            font-size: 2.2rem;
            font-weight: 700;
            background: linear-gradient(145deg, #0f2b3d, #1e4a6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            border-left: 8px solid #e11d48;
            padding-left: 24px;
            line-height: 1.2;
        }
        .subhead {
            display: flex;
            justify-content: space-between;
            margin-left: 32px;
            margin-top: 8px;
            color: #4b5e6b;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding-bottom: 16px;
        }
        .live-badge {
            background: #10b981;
            color: white;
            padding: 6px 14px;
            border-radius: 60px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .last-update {
            font-size: 0.8rem;
            color: #64748b;
            margin-left: 32px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .news-feed {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .card {
            background: white;
            border-radius: 28px;
            box-shadow: 0 15px 35px -12px rgba(0,20,30,0.12);
            width: 100%;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.6);
            transition: all 0.25s ease;
            position: relative;
        }
        .card.selesai {
            opacity: 0.85;
            background: #f8fafc;
            border-left: 6px solid #94a3b8;
        }
        .card:hover {
            box-shadow: 0 24px 44px -14px rgba(0,55,80,0.18);
        }
        .selesai-label {
            position: absolute;
            top: 16px;
            right: 22px;
            background: #64748b;
            color: white;
            padding: 6px 16px;
            border-radius: 60px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 12px rgba(100,116,139,0.3);
            z-index: 2;
        }
        .card-preview {
            display: flex;
            align-items: center;
            padding: 16px 22px;
            gap: 18px;
            cursor: pointer;
        }
        .thumbnail {
            width: 70px;
            height: 70px;
            flex-shrink: 0;
            background: #f1f5f9;
            border-radius: 18px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .thumbnail i {
            font-size: 28px;
            color: #94a3b8;
        }
        .preview-content {
            flex: 1;
        }
        .news-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
            flex-wrap: wrap;
        }
        .badge-new {
            background: #e11d48;
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 60px;
            text-transform: uppercase;
            box-shadow: 0 4px 12px rgba(225,29,72,0.25);
        }
        .badge-selesai {
            background: #64748b;
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 60px;
            text-transform: uppercase;
        }
        .instansi-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #547087;
            background: rgba(84,112,135,0.08);
            padding: 4px 12px;
            border-radius: 60px;
        }
        .judul-berita {
            font-size: 1.12rem;
            font-weight: 650;
            color: #0a1c2a;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .meta-sumber {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 0.8rem;
            color: #4f6f7f;
        }
        .sumber-text {
            background: rgba(20,100,120,0.05);
            padding: 4px 12px;
            border-radius: 50px;
        }
        .arrow-toggle {
            width: 42px;
            height: 42px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 16px rgba(0,0,0,0.03);
            transition: all 0.2s;
        }
        .card.expanded .arrow-toggle {
            transform: rotate(180deg);
            background: #f1f9ff;
            color: #0a4b6e;
        }
        .card-detail {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: all 0.45s cubic-bezier(0.23, 1, 0.32, 1);
            background: rgba(249,252,255,0.7);
        }
        .card.expanded .card-detail {
            max-height: 800px;
            opacity: 1;
            padding: 22px 24px 28px;
            border-top: 1px solid rgba(168,192,207,0.2);
        }
        .isi-konten {
            font-size: 1rem;
            line-height: 1.65;
            color: #1f3a4b;
            background: white;
            padding: 20px;
            border-radius: 20px;
            border: 1px solid rgba(84,110,122,0.08);
            white-space: pre-line;
        }
        .info-section {
            background: white;
            border-radius: 20px;
            padding: 16px 20px;
            margin-bottom: 12px;
            border: 1px solid rgba(0,0,0,0.02);
        }
        .info-row {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
        }
        .info-row:last-child {
            margin-bottom: 0;
        }
        .info-icon {
            width: 24px;
            color: #e11d48;
            flex-shrink: 0;
        }
        .info-content {
            flex: 1;
            line-height: 1.5;
        }
        .info-label {
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }
        .alamat-text {
            font-weight: 600;
            color: #0f2b3d;
        }
        .time-display {
            display: flex;
            align-items: baseline;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }
        .date-badge {
            background: white;
            padding: 8px 18px;
            border-radius: 100px;
            font-weight: 600;
            color: #0f2b3d;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .time-badge {
            background: #f1f9ff;
            padding: 8px 18px;
            border-radius: 100px;
            font-weight: 600;
            color: #0369a1;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 20px;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 24px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 0.9rem;
            text-decoration: none;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
        .btn i {
            font-size: 1rem;
        }
        .btn-photo {
            background: #0a4b6e;
            color: white;
            box-shadow: 0 8px 18px rgba(10,75,110,0.2);
        }
        .btn-photo:hover {
            background: #0e5f88;
            transform: scale(0.98);
        }
        .btn-map {
            background: #e11d48;
            color: white;
            box-shadow: 0 8px 18px rgba(225,29,72,0.2);
        }
        .btn-map:hover {
            background: #be123c;
            transform: scale(0.98);
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: rgba(255,255,255,0.5);
            border-radius: 60px;
            color: #4e6a79;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #1e4a6b;
        }
        footer {
            margin-top: 50px;
            text-align: center;
            color: #7c8f99;
            padding-top: 30px;
            border-top: 1px solid rgba(0,0,0,0.04);
        }
        @media (max-width: 550px) {
            body { padding: 20px 16px; }
            .header h1 { font-size: 1.6rem; }
            .judul-berita { white-space: normal; }
            .button-group { flex-direction: column; }
            .btn { justify-content: center; }
            .time-display { flex-direction: column; }
            .selesai-label { position: static; margin-bottom: 8px; display: inline-block; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>UPDATE INFORMASI KEGIATAN<br>KECAMATAN DAN KELURAHAN DI SENAPELAN</h1>
            <div class="subhead">
                <span><i class="fas fa-map-pin" style="color:#e11d48;"></i> Sumber: Kecamatan Senapelan - Senapelan Satu Pintu</span>
                <span class="live-badge"><i class="fas fa-circle"></i> PUSAT INFORMASI RESMI SENAPELAN SATU PINTU</span>
            </div>
            <div class="last-update" id="lastUpdate">
                <i class="fas fa-sync-alt"></i> Menyambung ke server...
            </div>
        </div>

        <div id="newsFeed" class="news-feed">
            <div class="loading">
                <i class="fas fa-spinner fa-pulse fa-2x"></i>
                <p style="margin-top: 16px;">Memuat data terbaru...</p>
            </div>
        </div>
        
        <footer>
            <i class="fas fa-bolt"></i> Sinkron real-time setiap 10 detik · Update dari Google Form
        </footer>
    </div>

    <script>
    // ===========================================
    // KONFIGURASI APPS SCRIPT
    // ===========================================
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzYnfxLi8ViBeYRQmRvEYn2fiDYJHbV5zCDGpJ5YPzNB7ez8dE9G-BIS6jzCZ61CmHMGQ/exec';
    
    let expandedCardId = null;
    let retryCount = 0;
    const MAX_RETRY = 3;
    const STORAGE_KEY = 'senapelan_expanded_card';
    
    // ===========================================
    // STATE MANAGEMENT - CARD TIDAK TUTUP SENDIRI!
    // ===========================================
    
    // Simpan card yang terbuka ke localStorage
    function saveExpandedCard(cardId) {
        try {
            if (cardId) {
                localStorage.setItem(STORAGE_KEY, cardId);
                expandedCardId = cardId;
            } else {
                localStorage.removeItem(STORAGE_KEY);
                expandedCardId = null;
            }
        } catch (e) {
            console.log('Storage error:', e);
        }
    }
    
    // Ambil card yang terbuka dari localStorage
    function getSavedExpandedCard() {
        try {
            return localStorage.getItem(STORAGE_KEY);
        } catch (e) {
            return null;
        }
    }
    
    // ===========================================
    // FUNGSI CEK APAKAH ACARA SUDAH SELESAI
    // ===========================================
    function isAcaraSelesai(tglSelesai, waktuSelesai) {
        if (!tglSelesai || !waktuSelesai) return false;
        
        try {
            let tanggalSelesaiStr = tglSelesai;
            if (tglSelesai.includes('/')) {
                const parts = tglSelesai.split('/');
                if (parts.length === 3) {
                    const bulan = parseInt(parts[0]) - 1;
                    const hari = parseInt(parts[1]);
                    let tahun = parseInt(parts[2]);
                    if (tahun < 100) tahun += 2000;
                    tanggalSelesaiStr = `${tahun}-${bulan+1}-${hari}`;
                }
            }
            
            let jam = 0, menit = 0;
            if (waktuSelesai.includes('AM') || waktuSelesai.includes('PM')) {
                const match = waktuSelesai.match(/(\d{1,2}):(\d{2}):\d{2}\s*(AM|PM)/i);
                if (match) {
                    jam = parseInt(match[1]);
                    menit = parseInt(match[2]);
                    const ampm = match[3].toUpperCase();
                    if (ampm === 'PM' && jam !== 12) jam += 12;
                    if (ampm === 'AM' && jam === 12) jam = 0;
                }
            } else if (waktuSelesai.includes('T')) {
                const match = waktuSelesai.match(/T(\d{2}):(\d{2})/);
                if (match) {
                    jam = parseInt(match[1]);
                    menit = parseInt(match[2]);
                }
            } else {
                const match = waktuSelesai.match(/(\d{1,2}):(\d{2})/);
                if (match) {
                    jam = parseInt(match[1]);
                    menit = parseInt(match[2]);
                    if (jam > 23) jam -= 24;
                }
            }
            
            const dateSelesai = new Date(tanggalSelesaiStr);
            if (!isNaN(dateSelesai.getTime())) {
                dateSelesai.setHours(jam, menit, 0);
                const sekarang = new Date();
                return sekarang > dateSelesai;
            }
        } catch (e) {
            console.log('Error cek selesai:', e);
        }
        return false;
    }
    
    // ===========================================
    // FUNGSI FORMAT WAKTU INDONESIA
    // ===========================================
    function formatTanggalIndonesia(dateString) {
        if (!dateString) return null;
        try {
            const cleanDate = dateString.split(' ')[0];
            const parts = cleanDate.split('/');
            if (parts.length === 3) {
                const bulan = parseInt(parts[0]);
                const hari = parseInt(parts[1]);
                const tahun = parseInt(parts[2]);
                const namaBulan = [
                    'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                    'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
                ];
                if (bulan >= 1 && bulan <= 12) {
                    return `${hari} ${namaBulan[bulan-1]} ${tahun}`;
                }
            }
        } catch {}
        return null;
    }
    
    function formatWaktuIndonesia(waktuString) {
        if (!waktuString) return null;
        try {
            if (waktuString.includes('AM') || waktuString.includes('PM')) {
                const match = waktuString.match(/(\d{1,2}):(\d{2}):\d{2}\s*(AM|PM)/i);
                if (match) {
                    let jam = parseInt(match[1]);
                    const menit = match[2];
                    const ampm = match[3].toUpperCase();
                    if (ampm === 'PM' && jam !== 12) jam += 12;
                    if (ampm === 'AM' && jam === 12) jam = 0;
                    return `${jam.toString().padStart(2, '0')}.${menit} WIB`;
                }
            }
            if (waktuString.includes('1899') || waktuString.includes('T')) {
                const match = waktuString.match(/T(\d{2}):(\d{2})/);
                if (match) return `${match[1]}.${match[2]} WIB`;
            }
            const match = waktuString.match(/(\d{1,2}):(\d{2})/);
            if (match) {
                let jam = parseInt(match[1]);
                if (jam > 23) jam -= 24;
                return `${jam.toString().padStart(2, '0')}.${match[2]} WIB`;
            }
        } catch {}
        return null;
    }
    
    function formatDurasiAcara(tglMulai, waktuMulai, tglSelesai, waktuSelesai) {
        const tanggalMulai = formatTanggalIndonesia(tglMulai);
        const jamMulai = formatWaktuIndonesia(waktuMulai);
        const tanggalSelesai = formatTanggalIndonesia(tglSelesai);
        const jamSelesai = formatWaktuIndonesia(waktuSelesai);
        
        if (tglMulai === tglSelesai && jamMulai && jamSelesai) {
            return `
                <div class="time-display">
                    <span class="date-badge">
                        <i class="far fa-calendar-alt"></i> ${tanggalMulai || tglMulai}
                    </span>
                    <span class="time-badge">
                        <i class="far fa-clock"></i> ${jamMulai.replace('WIB', '')} — ${jamSelesai}
                    </span>
                </div>
            `;
        } else if (tanggalMulai && jamMulai && tanggalSelesai && jamSelesai) {
            return `
                <div class="time-display">
                    <span class="date-badge">
                        <i class="far fa-calendar-alt"></i> ${tanggalMulai} ${jamMulai}
                    </span>
                    <span style="color: #94a3b8;"><i class="fas fa-arrow-right"></i></span>
                    <span class="date-badge">
                        <i class="far fa-calendar-alt"></i> ${tanggalSelesai} ${jamSelesai}
                    </span>
                </div>
            `;
        }
        return `
            <div class="time-display">
                <span class="date-badge">
                    <i class="far fa-calendar-alt"></i> ${tglMulai || '?'} ${waktuMulai || ''}
                </span>
            </div>
        `;
    }
    
    // ===========================================
    // FUNGSI CEK LINK GOOGLE MAPS
    // ===========================================
    function isGoogleMapsLink(text) {
        if (!text) return false;
        const mapPatterns = [
            'google.com/maps',
            'goo.gl/maps',
            'maps.app.goo.gl',
            'google.co.id/maps',
            'maps.google.com'
        ];
        return mapPatterns.some(pattern => text.includes(pattern));
    }
    
    // ===========================================
    // FUNGSI CEK POSTINGAN BARU (24 JAM)
    // ===========================================
    function isLessThan24Hours(timestamp) {
        if (!timestamp) return false;
        try {
            const postDate = new Date(timestamp);
            if (isNaN(postDate.getTime())) return false;
            const now = new Date();
            return (now - postDate) / (1000 * 60 * 60) < 24;
        } catch {
            return false;
        }
    }
    
    // ===========================================
    // TOGGLE CARD - VERSI FIX (TIDAK TUTUP SENDIRI!)
    // ===========================================
    window.toggleCard = function(cardId) {
        const card = document.querySelector(`[data-card-id="${cardId}"]`);
        if (card) {
            if (card.classList.contains('expanded')) {
                card.classList.remove('expanded');
                saveExpandedCard(null);
            } else {
                document.querySelectorAll('.card').forEach(c => c.classList.remove('expanded'));
                card.classList.add('expanded');
                saveExpandedCard(cardId);
            }
        }
    };
    
    // ===========================================
    // RENDER CARDS - DENGAN STATE TERSIMPAN
    // ===========================================
    function renderCards(rows) {
        const feed = document.getElementById('newsFeed');
        let html = '';
        
        // Ambil card yang sebelumnya terbuka
        const savedCardId = getSavedExpandedCard();
        expandedCardId = savedCardId;
        
        rows.forEach((row, index) => {
            // AMBIL DATA DENGAN FORMAT BARU
            const timestamp = row.timestamp || '';
            const instansi = row.instansi || 'INSTANSI';
            const tglMulai = row.tglMulai || '';
            const waktuMulai = row.waktuMulai || '';
            const tglSelesai = row.tglSelesai || '';
            const waktuSelesai = row.waktuSelesai || '';
            const lokasi = row.lokasi || 'Lokasi tidak tersedia';
            const linkMap = row.linkMap || '';
            let isiKonten = row.isiKonten || 'Tidak ada keterangan';
            const fotoUrl = row.fotoUrl || '';
            
            // CEK APAKAH ACARA SUDAH SELESAI
            const selesai = isAcaraSelesai(tglSelesai, waktuSelesai);
            
            // CEK APAKAH ADA LINK MAP
            const punyaLinkMap = linkMap && linkMap.trim() !== '' && 
                (linkMap.includes('google.com/maps') || 
                 linkMap.includes('goo.gl/maps') || 
                 linkMap.includes('maps.app.goo.gl'));
            
            // ID UNIK - PASTIKAN KONSISTEN
            const cardId = `card-${index}-${timestamp.replace(/[^0-9]/g, '').slice(-6)}`;
            
            // CEK APAKAH CARD INI YANG HARUS TERBUKA
            const isExpanded = (expandedCardId === cardId);
            
            // THUMBNAIL FOTO
            let thumbnailHtml = `<div class="thumbnail"><i class="fas fa-image"></i></div>`;
            if (fotoUrl) {
                let fileId = '';
                if (fotoUrl.includes('open?id=')) {
                    fileId = fotoUrl.split('open?id=')[1].split('&')[0];
                } else if (fotoUrl.includes('file/d/')) {
                    const match = fotoUrl.match(/\/d\/(.*?)(\/|$)/);
                    if (match) fileId = match[1];
                }
                if (fileId) {
                    thumbnailHtml = `<div class="thumbnail"><img src="https://drive.google.com/thumbnail?id=${fileId}&sz=w200-h200" loading="lazy" onerror="this.parentElement.innerHTML='<i class=\'fas fa-camera\'></i>'"></div>`;
                }
            }
            
            // LABEL BARU
            const isNew = isLessThan24Hours(timestamp);
            const newBadge = isNew ? '<span class="badge-new"><i class="fas fa-bolt"></i>BARU</span>' : '';
            
            // FORMAT TANGGAL POSTING
            let tanggalPosting = '';
            try {
                const date = new Date(timestamp);
                if (!isNaN(date.getTime())) {
                    tanggalPosting = date.toLocaleDateString('id-ID', {
                        day: 'numeric', month: 'numeric', year: 'numeric'
                    });
                }
            } catch {}
            
            // FORMAT DURASI ACARA
            const waktuAcaraHTML = formatDurasiAcara(tglMulai, waktuMulai, tglSelesai, waktuSelesai);
            
            // BUILD CARD
            html += `<div class="card ${selesai ? 'selesai' : ''} ${isExpanded ? 'expanded' : ''}" data-card-id="${cardId}">
                ${selesai ? '<span class="selesai-label"><i class="fas fa-check-circle"></i> Acara Telah Selesai</span>' : ''}
                <div class="card-preview" onclick="toggleCard('${cardId}')">
                    ${thumbnailHtml}
                    <div class="preview-content">
                        <div class="news-badge">
                            ${newBadge}
                            <span class="instansi-label"><i class="fas fa-building"></i> ${instansi}</span>
                        </div>
                        <div class="judul-berita">
                            <i class="fas fa-pen-square"></i> Update dari ${instansi}
                        </div>
                        <div class="meta-sumber">
                            <span class="sumber-text"><i class="fas fa-tag"></i> Sumber: ${instansi}</span>
                            <span><i class="far fa-clock"></i> ${tanggalPosting || ''}</span>
                        </div>
                    </div>
                    <div class="arrow-toggle">
                        <i class="fas fa-chevron-down"></i>
                    </div>
                </div>
                <div class="card-detail">
                    <div class="detail-inner">
                        <div class="isi-konten">${isiKonten.replace(/\n/g, '<br>')}</div>
                        
                        <div class="info-section">
                            <div class="info-row">
                                <div class="info-icon">
                                    <i class="fas fa-map-marker-alt"></i>
                                </div>
                                <div class="info-content">
                                    <div class="info-label">ALAMAT LOKASI</div>
                                    <div class="alamat-text">${lokasi}</div>
                                </div>
                            </div>
                        </div>
                        
                        ${waktuAcaraHTML}
                        
                        <div class="button-group">`;
            
            // TOMBOL FOTO
            if (fotoUrl) {
                html += `<a href="${fotoUrl}" target="_blank" class="btn btn-photo">
                            <i class="fas fa-camera"></i> Lihat Foto Kegiatan
                        </a>`;
            }
            
            // TOMBOL PETA
            if (punyaLinkMap) {
                html += `<a href="${linkMap}" target="_blank" class="btn btn-map">
                            <i class="fas fa-map-marked-alt"></i> Buka Google Maps
                        </a>`;
            }
            
            html += `</div></div></div></div>`;
        });
        
        feed.innerHTML = html;
        
        // PASTIKAN CARD YANG TERSIMPAN TETAP TERBUKA
        if (expandedCardId) {
            const expandedCard = document.querySelector(`[data-card-id="${expandedCardId}"]`);
            if (expandedCard) {
                expandedCard.classList.add('expanded');
            } else {
                expandedCardId = null;
                saveExpandedCard(null);
            }
        }
        
        document.getElementById('lastUpdate').innerHTML = 
            `<i class="fas fa-check-circle" style="color:#10b981;"></i> Terakhir update: ${new Date().toLocaleTimeString('id-ID')} · ${rows.length} berita`;
    }
    
    // ===========================================
    // SHOW ERROR
    // ===========================================
    function showError(message) {
        document.getElementById('newsFeed').innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle" style="font-size: 36px; color: #b45309;"></i>
                <h3 style="margin-top: 16px;">Gagal mengambil data</h3>
                <p style="margin-top: 8px;">Mencoba menyambung kembali...</p>
                <p style="margin-top: 16px; font-size: 0.8rem; color: #64748b;">${message || 'Pastikan URL Apps Script sudah benar'}</p>
            </div>
        `;
        document.getElementById('lastUpdate').innerHTML = 
            `<i class="fas fa-exclamation-circle" style="color:#e11d48;"></i> Gagal sinkron · ${new Date().toLocaleTimeString('id-ID')}`;
    }
    
    // ===========================================
    // FETCH MENGGUNAKAN JSONP
    // ===========================================
    function fetchData() {
        const callbackName = 'handleData_' + Date.now();
        
        window[callbackName] = function(response) {
            const script = document.getElementById('jsonp-script');
            if (script) script.remove();
            retryCount = 0;
            
            if (response && response.success === true) {
                if (response.data && response.data.length > 0) {
                    renderCards(response.data);
                } else {
                    document.getElementById('newsFeed').innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-newspaper" style="font-size: 42px; opacity: 0.5;"></i>
                            <h3 style="margin-top: 16px;">Belum ada informasi</h3>
                            <p style="margin-top: 8px;">Data akan muncul setelah ada pengisian form</p>
                        </div>
                    `;
                    document.getElementById('lastUpdate').innerHTML = 
                        `<i class="fas fa-info-circle" style="color:#64748b;"></i> Belum ada data · ${new Date().toLocaleTimeString('id-ID')}`;
                }
            } else {
                showError(response?.error || 'Format data tidak valid');
            }
            
            setTimeout(() => delete window[callbackName], 100);
        };
        
        const script = document.createElement('script');
        script.id = 'jsonp-script';
        script.src = `${APPS_SCRIPT_URL}?callback=${callbackName}&t=${Date.now()}`;
        
        script.onerror = function() {
            retryCount++;
            if (retryCount <= MAX_RETRY) {
                console.log(`Retry ${retryCount}/${MAX_RETRY}...`);
                setTimeout(fetchData, 2000);
            } else {
                showError('Tidak dapat terhubung ke server. Periksa URL Apps Script.');
            }
            delete window[callbackName];
            document.getElementById('jsonp-script')?.remove();
        };
        
        document.head.appendChild(script);
    }
    
    // ===========================================
    // CLEANUP EXPIRED CARDS
    // ===========================================
    function cleanupExpandedCard() {
        const savedCardId = getSavedExpandedCard();
        if (savedCardId) {
            const card = document.querySelector(`[data-card-id="${savedCardId}"]`);
            if (!card) {
                saveExpandedCard(null);
            }
        }
    }
    
    // ===========================================
    // START APLIKASI
    // ===========================================
    
    // Fetch pertama
    fetchData();
    
    // Auto refresh setiap 10 detik
    setInterval(() => {
        fetchData();
        setTimeout(cleanupExpandedCard, 500);
    }, 5000);
    
    // Load state dari storage saat pertama kali
    window.addEventListener('load', function() {
        const savedCardId = getSavedExpandedCard();
        if (savedCardId) {
            setTimeout(() => {
                const card = document.querySelector(`[data-card-id="${savedCardId}"]`);
                if (card) {
                    card.classList.add('expanded');
                    expandedCardId = savedCardId;
                }
            }, 500);
        }
    });
</script>
</body>
</html>
