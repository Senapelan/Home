<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Update Info · Senapelan</title>
    <!-- Google Fonts & Font Awesome 6 (premium feel) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(145deg, #f6f9fc 0%, #edf2f7 100%);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            padding: 32px 24px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #1e293b;
        }

        .premium-container {
            max-width: 1100px;
            width: 100%;
            margin: 0 auto;
        }

        /* header premium */
        .page-header {
            display: flex;
            flex-direction: column;
            margin-bottom: 40px;
            position: relative;
        }

        .page-header h1 {
            font-size: 2.2rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            background: linear-gradient(145deg, #0f2b3d, #1e4a6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            border-left: 8px solid #e11d48;
            padding-left: 24px;
            line-height: 1.2;
        }

        .subhead {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-left: 32px;
            color: #4b5e6b;
            font-weight: 400;
            font-size: 1rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding-bottom: 16px;
        }

        .live-badge {
            background: #10b981;
            color: white;
            padding: 6px 14px;
            border-radius: 60px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 6px 14px rgba(16,185,129,0.2);
        }

        .live-badge i {
            font-size: 0.7rem;
        }

        /* card layout — full width, collapsible, elegant */
        .news-feed {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
        }

        .card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.6);
            border-radius: 28px;
            box-shadow: 0 15px 35px -12px rgba(0,20,30,0.12), 0 2px 6px rgba(0,0,0,0.02);
            transition: all 0.25s ease;
            width: 100%;
            overflow: hidden;
            font-size: 0.95rem;
        }

        .card:hover {
            box-shadow: 0 24px 44px -14px rgba(0,55,80,0.18);
            border-color: rgba(255,255,255,0.9);
            background: white;
        }

        /* area yang selalu terlihat (collapsed) */
        .card-preview {
            display: flex;
            align-items: center;
            padding: 16px 22px;
            gap: 18px;
            cursor: pointer;
            position: relative;
        }

        .thumbnail {
            width: 70px;
            height: 70px;
            flex-shrink: 0;
            background: #f1f5f9;
            border-radius: 18px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(0,0,0,0.02);
            box-shadow: 0 8px 18px -8px rgba(0,0,0,0.08);
            transition: transform 0.2s;
        }

        .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .thumbnail i {
            font-size: 28px;
            color: #94a3b8;
        }

        .preview-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 0;
        }

        .news-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
            flex-wrap: wrap;
        }

        .badge-new {
            background: #e11d48;
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 60px;
            letter-spacing: 0.3px;
            text-transform: uppercase;
            box-shadow: 0 4px 12px rgba(225,29,72,0.25);
            display: inline-block;
        }

        .instansi-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #547087;
            background: rgba(84,112,135,0.08);
            padding: 4px 12px;
            border-radius: 60px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .judul-berita {
            font-size: 1.12rem;
            font-weight: 650;
            color: #0a1c2a;
            line-height: 1.4;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .judul-berita i {
            color: #1e4a6b;
            margin-right: 6px;
            font-size: 0.9rem;
        }

        .meta-sumber {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 0.8rem;
            color: #4f6f7f;
        }

        .sumber-text {
            background: rgba(20, 100, 120, 0.05);
            padding: 4px 12px;
            border-radius: 50px;
            font-weight: 500;
        }

        .sumber-text i {
            margin-right: 4px;
            color: #0077b6;
        }

        .arrow-toggle {
            color: #607d8b;
            background: white;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            box-shadow: 0 6px 16px rgba(0,0,0,0.03);
            border: 1px solid rgba(0,0,0,0.02);
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .card.expanded .arrow-toggle {
            transform: rotate(180deg);
            background: #f1f9ff;
            color: #0a4b6e;
        }

        /* konten detail yang di buka / colapse */
        .card-detail {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.45s cubic-bezier(0.23, 1, 0.32, 1), opacity 0.35s ease, padding 0.3s;
            background: rgba(249, 252, 255, 0.7);
            border-top: 0px solid rgba(0,0,0,0.02);
        }

        .card.expanded .card-detail {
            max-height: 800px;
            opacity: 1;
            padding: 22px 24px 28px;
            border-top: 1px solid rgba(168, 192, 207, 0.2);
        }

        .detail-inner {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .isi-konten {
            font-size: 1rem;
            line-height: 1.65;
            color: #1f3a4b;
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: inset 0 1px 4px rgba(0,0,0,0.01);
            border: 1px solid rgba(84,110,122,0.08);
            white-space: pre-line;
            font-weight: 400;
        }

        .acara-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 20px 32px;
            background: rgba(203, 223, 233, 0.2);
            padding: 14px 20px;
            border-radius: 24px;
            color: #1f4e5f;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .acara-meta i {
            width: 18px;
            color: #007296;
            margin-right: 6px;
        }

        .btn-google {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: #0a4b6e;
            color: white;
            padding: 14px 26px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 0.9rem;
            border: none;
            cursor: pointer;
            transition: 0.2s;
            text-decoration: none;
            width: fit-content;
            box-shadow: 0 8px 18px rgba(10,75,110,0.2);
            letter-spacing: 0.3px;
            margin-top: 8px;
        }

        .btn-google:hover {
            background: #0e5f88;
            transform: scale(0.98);
            box-shadow: 0 12px 24px rgba(10,75,110,0.25);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: rgba(255,255,255,0.5);
            border-radius: 60px;
            color: #4e6a79;
            font-weight: 500;
            backdrop-filter: blur(6px);
        }

        .loading-skeleton {
            padding: 40px;
            text-align: center;
        }

        footer {
            margin-top: 50px;
            font-size: 0.8rem;
            color: #7c8f99;
            text-align: center;
            border-top: 1px solid rgba(0,0,0,0.04);
            padding-top: 30px;
        }

        @media (max-width: 550px) {
            body { padding: 20px 16px; }
            .page-header h1 { font-size: 1.6rem; padding-left: 16px; }
            .card-preview { padding: 14px; gap: 12px; }
            .thumbnail { width: 60px; height: 60px; }
            .judul-berita { white-space: normal; font-size: 1rem; }
        }

        /* Last update indicator */
        .last-update {
            font-size: 0.8rem;
            color: #64748b;
            margin-top: 8px;
            margin-left: 32px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .last-update i {
            color: #0ea5e9;
        }
    </style>
</head>
<body>
    <div class="premium-container">
        <div class="page-header">
            <h1>UPDATE INFORMASI <br>KECAMATAN DAN KELURAHAN DI SENAPELAN</h1>
            <div class="subhead">
                <span><i class="fas fa-map-pin" style="color:#e11d48;"></i> Sumber terpercaya · Kecamatan Senapelan</span>
                <span class="live-badge"><i class="fas fa-circle"></i> LANGSUNG · SPREADSHEET</span>
            </div>
            <div class="last-update" id="lastUpdateInfo">
                <i class="fas fa-sync-alt"></i> Memuat data terbaru...
            </div>
        </div>

        <div id="newsFeed" class="news-feed">
            <div class="loading-skeleton">
                <i class="fas fa-spinner fa-pulse fa-2x" style="color:#1e4a6b;"></i>
                <p style="margin-top: 16px;">Memuat update terkini...</p>
            </div>
        </div>
        <footer>
            <i class="fas fa-database"></i> terhubung langsung · update realtime setiap 10 detik · max 1000 card
        </footer>
    </div>

    <script>
        (function() {
            "use strict";

            // ================ KONFIGURASI ================
            const SPREADSHEET_ID = '1lvWJ615b3FrjKO-JULTQ2Yq5HC4Mvfzjleej8Td3kmI';
            const SHEET_NAME = 'UPDATE_INFORMASI';
            
            // APPS SCRIPT ENDPOINT - PASTIKAN INI URL YANG BENAR
            // Gunakan endpoint CSV sebagai fallback yang lebih stabil
            const CSV_ENDPOINT = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}&t=${Date.now()}`;
            
            // ================ UTILITY FUNCTIONS ================
            
            // Fungsi untuk toggle card dengan event delegation
            function setupCardToggles() {
                // Hapus semua event listener lama dengan cara mengganti parent
                const feed = document.getElementById('newsFeed');
                
                // Gunakan event delegation di parent
                feed.removeEventListener('click', handleCardClick);
                feed.addEventListener('click', handleCardClick);
            }
            
            // Handler untuk klik card
            function handleCardClick(e) {
                // Cari elemen card-preview yang diklik
                const preview = e.target.closest('.card-preview');
                if (!preview) return;
                
                const card = preview.closest('.card');
                if (card) {
                    e.preventDefault();
                    e.stopPropagation();
                    card.classList.toggle('expanded');
                }
            }

            // Cek apakah dalam 24 jam
            function isWithin24Hours(timestampStr) {
                if (!timestampStr) return false;
                
                try {
                    // Parse timestamp dengan format: "2/12/2026 22:34:29" atau dengan AM/PM
                    let dateStr = timestampStr.trim();
                    
                    // Handle format dengan AM/PM
                    if (dateStr.includes('AM') || dateStr.includes('PM')) {
                        // Format: "2/13/2026 11:00:00 AM"
                        const [datePart, timePart, ampm] = dateStr.split(' ');
                        const [month, day, year] = datePart.split('/').map(Number);
                        let [hour, minute, second] = timePart.split(':').map(Number);
                        
                        if (ampm.toUpperCase() === 'PM' && hour !== 12) hour += 12;
                        if (ampm.toUpperCase() === 'AM' && hour === 12) hour = 0;
                        
                        const dateObj = new Date(year, month-1, day, hour, minute, second || 0);
                        const now = new Date();
                        return (now - dateObj) < 24 * 60 * 60 * 1000;
                    } else {
                        // Format tanpa AM/PM
                        const dateObj = new Date(dateStr);
                        if (!isNaN(dateObj.getTime())) {
                            const now = new Date();
                            return (now - dateObj) < 24 * 60 * 60 * 1000;
                        }
                    }
                } catch (e) {
                    console.error('Error parsing date:', timestampStr, e);
                }
                return false;
            }

            // Format judul
            function formatJudul(instansi) {
                if (!instansi || instansi.trim() === '') return "Update Informasi";
                let instansiClean = instansi.trim();
                return `Update dari ${instansiClean}`;
            }

            // Extract URL gambar dari Google Drive
            function extractDirectImageUrl(driveLink) {
                if (!driveLink || driveLink === '') return null;
                
                try {
                    let id = null;
                    if (driveLink.includes('open?id=')) {
                        id = driveLink.split('open?id=')[1].split('&')[0].split('?')[0];
                    } else if (driveLink.includes('file/d/')) {
                        const match = driveLink.match(/\/d\/(.*?)(\/|$)/);
                        if (match) id = match[1];
                    } else if (driveLink.includes('id=')) {
                        id = driveLink.split('id=')[1].split('&')[0];
                    }
                    
                    if (id) {
                        return `https://drive.google.com/thumbnail?id=${id}&sz=w200-h200`;
                    }
                } catch (e) {
                    console.error('Error extracting image URL:', e);
                }
                return null;
            }

            // Parse CSV string ke array
            function parseCSV(csvText) {
                const lines = csvText.split('\n');
                return lines.map(line => {
                    // Handle quoted fields
                    const matches = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                    return matches.map(match => {
                        if (match.startsWith('"') && match.endsWith('"')) {
                            return match.slice(1, -1).replace(/""/g, '"');
                        }
                        return match;
                    });
                }).filter(row => row.length > 0 && row.some(cell => cell.trim() !== ''));
            }

            // ================ RENDER CARDS ================
            function renderCards(rows) {
                const feed = document.getElementById('newsFeed');
                
                if (!rows || rows.length === 0) {
                    feed.innerHTML = `<div class="empty-state">
                        <i class="fas fa-newspaper" style="font-size: 42px; opacity: 0.5; margin-bottom: 16px;"></i>
                        <h3 style="font-weight: 500;">Belum ada informasi</h3>
                        <p style="margin-top: 8px;">Update dari kecamatan/kelurahan akan tampil di sini.</p>
                    </div>`;
                    return;
                }

                // Batasi 1000 card dan sortir dari terbaru ke terlama
                const limited = rows.slice(0, Math.min(rows.length, 1000));
                
                let html = '';

                limited.forEach((row, index) => {
                    if (!Array.isArray(row) || row.length < 9) return;
                    
                    // Mapping kolom
                    const timestamp = row[0] || '';
                    const instansi = row[1] || 'KELURAHAN/INSTANSI';
                    const tglMulai = row[2] || '';
                    const waktuMulai = row[3] || '';
                    const tglSelesai = row[4] || '';
                    const waktuSelesai = row[5] || '';
                    const lokasi = row[6] || 'Lokasi tidak tersedia';
                    let isiKonten = row[7] || 'Tidak ada keterangan lebih lanjut.';
                    const fotoUrl = row[8] || '';

                    // Validasi dan bersihkan konten
                    if (isiKonten.trim() === '') {
                        isiKonten = 'Informasi lebih lanjut dapat menghubungi kelurahan setempat.';
                    }

                    const judul = formatJudul(instansi);
                    
                    // Thumbnail
                    let thumbnailHtml = `<div class="thumbnail"><i class="fas fa-image"></i></div>`;
                    const directFoto = extractDirectImageUrl(fotoUrl);
                    if (directFoto) {
                        thumbnailHtml = `<div class="thumbnail"><img src="${directFoto}" alt="foto kegiatan" loading="lazy" onerror="this.onerror=null; this.parentElement.innerHTML='<i class=\\'fas fa-camera\\'></i>'"></div>`;
                    }

                    // Label baru
                    const newLabel = isWithin24Hours(timestamp) ? 
                        '<span class="badge-new"><i class="fas fa-bolt"></i>BARU</span>' : '';

                    // Format waktu detail
                    let waktuDetail = '';
                    if (tglMulai && waktuMulai) {
                        waktuDetail = `${tglMulai} ${waktuMulai}`;
                        if (tglSelesai && waktuSelesai) {
                            waktuDetail += ` — ${tglSelesai} ${waktuSelesai}`;
                        }
                    } else {
                        waktuDetail = 'Waktu belum ditentukan';
                    }

                    // Unique ID untuk card
                    const cardId = `card-${index}-${timestamp.replace(/[^0-9]/g, '')}`;

                    html += `<div class="card" id="${cardId}">
                        <div class="card-preview">
                            ${thumbnailHtml}
                            <div class="preview-content">
                                <div class="news-badge">
                                    ${newLabel}
                                    <span class="instansi-label"><i class="fas fa-building"></i> ${instansi}</span>
                                </div>
                                <div class="judul-berita">
                                    <i class="fas fa-pen-square"></i> ${judul}
                                </div>
                                <div class="meta-sumber">
                                    <span class="sumber-text"><i class="fas fa-tag"></i> Sumber: ${instansi}</span>
                                    <span style="display:flex; align-items:center; gap:4px;">
                                        <i class="far fa-clock"></i> ${new Date(timestamp).toLocaleDateString('id-ID') || 'Tanggal tidak tersedia'}
                                    </span>
                                </div>
                            </div>
                            <div class="arrow-toggle">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                        <div class="card-detail">
                            <div class="detail-inner">
                                <div class="isi-konten">
                                    <i class="fas fa-quote-left" style="opacity:0.3; margin-right:6px;"></i>
                                    ${isiKonten.replace(/\n/g, '<br>')}
                                </div>
                                <div class="acara-meta">
                                    <span><i class="fas fa-map-marker-alt"></i> ${lokasi}</span>
                                    <span><i class="fas fa-calendar-alt"></i> ${waktuDetail}</span>
                                </div>`;
                    
                    if (fotoUrl && fotoUrl.trim() !== '') {
                        html += `<a href="${fotoUrl}" target="_blank" rel="noopener noreferrer" class="btn-google">
                                    <i class="fas fa-external-link-alt"></i> Lihat Foto Kegiatan
                                </a>`;
                    }
                    
                    html += `</div></div></div>`;
                });

                feed.innerHTML = html;
                
                // Setup toggle setelah card dirender
                setupCardToggles();
                
                // Update informasi last update
                document.getElementById('lastUpdateInfo').innerHTML = `<i class="fas fa-check-circle"></i> Terakhir diperbarui: ${new Date().toLocaleTimeString('id-ID')}`;
            }

            // ================ FETCH DATA ================
            async function fetchSheetData() {
                const feed = document.getElementById('newsFeed');
                
                try {
                    // Fetch CSV dengan cache busting
                    const response = await fetch(`${CSV_ENDPOINT}&_=${Date.now()}`, {
                        method: 'GET',
                        cache: 'no-store',
                        headers: {
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const csvText = await response.text();
                    
                    // Parse CSV
                    let rows = parseCSV(csvText);
                    
                    // Buang header (baris pertama)
                    if (rows.length > 0) {
                        rows = rows.slice(1);
                    }
                    
                    // Filter baris kosong
                    rows = rows.filter(row => 
                        row.length >= 2 && 
                        row[0] && row[0].trim() !== '' && 
                        row[1] && row[1].trim() !== ''
                    );
                    
                    // Sortir berdasarkan timestamp (terbaru di atas)
                    rows.sort((a, b) => {
                        try {
                            const dateA = new Date(a[0]);
                            const dateB = new Date(b[0]);
                            if (isNaN(dateA) && isNaN(dateB)) return 0;
                            if (isNaN(dateA)) return 1;
                            if (isNaN(dateB)) return -1;
                            return dateB - dateA;
                        } catch (e) {
                            return 0;
                        }
                    });

                    console.log(`Loaded ${rows.length} rows from spreadsheet`);
                    renderCards(rows);
                    
                } catch (error) {
                    console.error('Error fetching sheet:', error);
                    
                    // Fallback ke data demo
                    feed.innerHTML = `<div class="empty-state">
                        <i class="fas fa-exclamation-triangle" style="font-size: 36px; color: #b45309;"></i>
                        <h3 style="margin-top: 16px; font-weight: 600;">Gagal memuat data</h3>
                        <p style="margin-top: 8px; color: #64748b;">Menampilkan data contoh...</p>
                    </div>`;
                    
                    // Data demo
                    const demoRows = [
                        ["2/13/2026 14:30:00", "KELURAHAN PADANG TERUBUK", "2/13/2026", "11:00:00", "2/13/2026", "14:00:00", "JALAN MELUR NO 4", "PEMBAGIAN BERAS BULOG - Hari ini kita membagikan 100 paket sembako kepada warga kurang mampu. Kegiatan berlangsung lancar dan didampingi oleh Bhabinkamtibmas.", "https://drive.google.com/open?id=1z7XHxr_DKUXQhvLhdvNTi4yUGwp94Mbb"],
                        ["2/12/2026 09:15:00", "KELURAHAN PADANG BULAN", "2/14/2026", "08:00:00", "2/14/2026", "12:00:00", "BALAI KELURAHAN", "POSYANDU BALITA - Akan diadakan penimbangan dan imunisasi untuk balita. Harap membawa KMS.", ""],
                        ["2/11/2026 10:45:00", "KECAMATAN SENAPELAN", "2/15/2026", "09:00:00", "2/15/2026", "11:00:00", "KANTOR CAMAT", "SOSIALISASI KB KESEHATAN - Program Keluarga Berencana dan kesehatan reproduksi remaja.", ""]
                    ];
                    
                    renderCards(demoRows);
                }
            }

            // ================ INITIALIZATION ================
            
            // Initial fetch
            fetchSheetData();
            
            // Auto refresh setiap 10 detik untuk real-time update
            setInterval(fetchSheetData, 10000);
            
            // Setup toggle untuk card yang sudah ada
            setupCardToggles();

        })();
    </script>
</body>
</html>
