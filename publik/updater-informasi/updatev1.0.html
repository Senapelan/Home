<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Update Info · Senapelan</title>
    <!-- Google Fonts & Font Awesome 6 (premium feel) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Sheets API / AppScript – kita pake endpoint JSONP versi cepat -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(145deg, #f6f9fc 0%, #edf2f7 100%);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            padding: 32px 24px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #1e293b;
        }

        .premium-container {
            max-width: 1100px;
            width: 100%;
            margin: 0 auto;
        }

        /* header premium */
        .page-header {
            display: flex;
            flex-direction: column;
            margin-bottom: 40px;
            position: relative;
        }

        .page-header h1 {
            font-size: 2.2rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            background: linear-gradient(145deg, #0f2b3d, #1e4a6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            border-left: 8px solid #e11d48;
            padding-left: 24px;
            line-height: 1.2;
        }

        .subhead {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-left: 32px;
            color: #4b5e6b;
            font-weight: 400;
            font-size: 1rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding-bottom: 16px;
        }

        .live-badge {
            background: #10b981;
            color: white;
            padding: 6px 14px;
            border-radius: 60px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 6px 14px rgba(16,185,129,0.2);
        }

        .live-badge i {
            font-size: 0.7rem;
        }

        /* card layout — full width, collapsible, elegant */
        .news-feed {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
        }

        .card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.6);
            border-radius: 28px;
            box-shadow: 0 15px 35px -12px rgba(0,20,30,0.12), 0 2px 6px rgba(0,0,0,0.02);
            transition: all 0.25s ease;
            width: 100%;
            overflow: hidden;
            font-size: 0.95rem;
        }

        .card:hover {
            box-shadow: 0 24px 44px -14px rgba(0,55,80,0.18);
            border-color: rgba(255,255,255,0.9);
            background: white;
        }

        /* area yang selalu terlihat (collapsed) */
        .card-preview {
            display: flex;
            align-items: center;
            padding: 16px 22px;
            gap: 18px;
            cursor: pointer;
            position: relative;
        }

        .thumbnail {
            width: 70px;
            height: 70px;
            flex-shrink: 0;
            background: #f1f5f9;
            border-radius: 18px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(0,0,0,0.02);
            box-shadow: 0 8px 18px -8px rgba(0,0,0,0.08);
            transition: transform 0.2s;
        }

        .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .thumbnail i {
            font-size: 28px;
            color: #94a3b8;
        }

        .preview-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 0; /* untuk text overflow */
        }

        .news-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
            flex-wrap: wrap;
        }

        .badge-new {
            background: #e11d48;
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 60px;
            letter-spacing: 0.3px;
            text-transform: uppercase;
            box-shadow: 0 4px 12px rgba(225,29,72,0.25);
            display: inline-block;
        }

        .instansi-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #547087;
            background: rgba(84,112,135,0.08);
            padding: 4px 12px;
            border-radius: 60px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .judul-berita {
            font-size: 1.12rem;
            font-weight: 650;
            color: #0a1c2a;
            line-height: 1.4;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .judul-berita i {
            color: #1e4a6b;
            margin-right: 6px;
            font-size: 0.9rem;
        }

        .meta-sumber {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 0.8rem;
            color: #4f6f7f;
        }

        .sumber-text {
            background: rgba(20, 100, 120, 0.05);
            padding: 4px 12px;
            border-radius: 50px;
            font-weight: 500;
        }

        .sumber-text i {
            margin-right: 4px;
            color: #0077b6;
        }

        .arrow-toggle {
            color: #607d8b;
            background: white;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            box-shadow: 0 6px 16px rgba(0,0,0,0.03);
            border: 1px solid rgba(0,0,0,0.02);
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .card.expanded .arrow-toggle {
            transform: rotate(180deg);
            background: #f1f9ff;
            color: #0a4b6e;
        }

        /* konten detail yang di buka / colapse */
        .card-detail {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.45s cubic-bezier(0.23, 1, 0.32, 1), opacity 0.35s ease, padding 0.3s;
            background: rgba(249, 252, 255, 0.7);
            border-top: 0px solid rgba(0,0,0,0.02);
        }

        .card.expanded .card-detail {
            max-height: 800px; /* cukup untuk konten panjang */
            opacity: 1;
            padding: 22px 24px 28px;
            border-top: 1px solid rgba(168, 192, 207, 0.2);
        }

        .detail-inner {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .isi-konten {
            font-size: 1rem;
            line-height: 1.65;
            color: #1f3a4b;
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: inset 0 1px 4px rgba(0,0,0,0.01);
            border: 1px solid rgba(84,110,122,0.08);
            white-space: pre-line;
            font-weight: 400;
        }

        .acara-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 20px 32px;
            background: rgba(203, 223, 233, 0.2);
            padding: 14px 20px;
            border-radius: 24px;
            color: #1f4e5f;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .acara-meta i {
            width: 18px;
            color: #007296;
            margin-right: 6px;
        }

        .btn-google {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: #0a4b6e;
            color: white;
            padding: 14px 26px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 0.9rem;
            border: none;
            cursor: pointer;
            transition: 0.2s;
            text-decoration: none;
            width: fit-content;
            box-shadow: 0 8px 18px rgba(10,75,110,0.2);
            letter-spacing: 0.3px;
            margin-top: 8px;
        }

        .btn-google:hover {
            background: #0e5f88;
            transform: scale(0.98);
            box-shadow: 0 12px 24px rgba(10,75,110,0.25);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: rgba(255,255,255,0.5);
            border-radius: 60px;
            color: #4e6a79;
            font-weight: 500;
            backdrop-filter: blur(6px);
        }

        .loading-skeleton {
            padding: 40px;
            text-align: center;
        }

        footer {
            margin-top: 50px;
            font-size: 0.8rem;
            color: #7c8f99;
            text-align: center;
            border-top: 1px solid rgba(0,0,0,0.04);
            padding-top: 30px;
        }

        /* responsive */
        @media (max-width: 550px) {
            body { padding: 20px 16px; }
            .page-header h1 { font-size: 1.6rem; padding-left: 16px; }
            .card-preview { padding: 14px; gap: 12px; }
            .thumbnail { width: 60px; height: 60px; }
            .judul-berita { white-space: normal; font-size: 1rem; }
        }
    </style>
</head>
<body>
    <div class="premium-container">
        <!-- HEADER PREMIUM -->
        <div class="page-header">
            <h1>UPDATE INFORMASI <br>KECAMATAN DAN KELURAHAN DI SENAPELAN</h1>
            <div class="subhead">
                <span><i class="fas fa-map-pin" style="color:#e11d48;"></i> Sumber terpercaya · Kecamatan Senapelan</span>
                <span class="live-badge"><i class="fas fa-circle"></i> LANGSUNG · SPREADSHEET</span>
            </div>
        </div>

        <!-- NEWS FEED: card container inject via js -->
        <div id="newsFeed" class="news-feed">
            <div class="loading-skeleton">
                <i class="fas fa-spinner fa-pulse fa-2x" style="color:#1e4a6b;"></i>
                <p style="margin-top: 16px;">Memuat update terkini...</p>
            </div>
        </div>
        <footer>
            <i class="fas fa-database"></i> terhubung langsung · update realtime · max 1000 card
        </footer>
    </div>

    <script>
        (function() {
            "use strict";

            // ----------------------------------------------------------
            // CONFIG SHEET & APPSCRIPT ENDPOINT (cepat, no cache)
            // ----------------------------------------------------------
            const SPREADSHEET_ID = '1lvWJ615b3FrjKO-JULTQ2Yq5HC4Mvfzjleej8Td3kmI';
            const SHEET_NAME = 'UPDATE_INFORMASI';
            // Gunakan APPSCRIPT WEBAPP — DEPLOYMENT URL, respon JSON cepat, tanpa delay.
            // (anda bisa ganti dengan endpoint sendiri, karena ini publik saya set read)
            // PASTIKAN endpoint mengembalikan array baris (termasuk header) atau langsung data.
            // Berikut endpoint cepat dengan caching dimatikan (no-cache)
            const APPS_SCRIPT_URL = `https://script.google.com/macros/s/AKfycbwMT8j2sH-HI6J8xrBw1t0Z6wW6uxiQy36ugdM85lcdAeSAt7vO2M4k2eR_-YSf9cC6/exec?spreadsheetId=${SPREADSHEET_ID}&sheet=${SHEET_NAME}&t=${Date.now()}`;
            
            // fallback jika endpoint tidak bisa diakses? kita juga bisa pakai csv export, tapi pilih appscript.
            // Untuk memastikan, kita juga punya sample data jika terjadi error (premium fallback)
            
            // Variabel global
            let allRows = [];
            const MAX_CARDS = 1000;

            // Utility: format tanggal, cek label baru (24 jam)
            function isWithin24Hours(timestampStr) {
                if (!timestampStr) return false;
                // timestamp format: "2/12/2026 22:34:29" (en-US)
                const parts = timestampStr.split(' ');
                if (parts.length < 2) return false;
                const dateParts = parts[0].split('/');
                if (dateParts.length !== 3) return false;
                // bulan/hari/tahun
                const month = parseInt(dateParts[0], 10) - 1;
                const day = parseInt(dateParts[1], 10);
                let year = parseInt(dateParts[2], 10);
                if (year < 100) year += 2000; 
                const timeParts = parts[1].split(':');
                if (timeParts.length < 2) return false;
                let hour = parseInt(timeParts[0], 10);
                const minute = parseInt(timeParts[1], 10);
                const second = timeParts[2] ? parseInt(timeParts[2], 10) : 0;
                // handle AM/PM mungkin? contoh: "11:00:00 AM" -> ada AM.
                if (parts[2] && (parts[2].toUpperCase() === 'AM' || parts[2].toUpperCase() === 'PM')) {
                    const ampm = parts[2].toUpperCase();
                    if (ampm === 'PM' && hour !== 12) hour += 12;
                    if (ampm === 'AM' && hour === 12) hour = 0;
                }
                const dateObj = new Date(year, month, day, hour, minute, second);
                if (isNaN(dateObj.getTime())) return false;
                const now = new Date();
                const diffMs = now - dateObj;
                return diffMs < 24 * 60 * 60 * 1000; // kurang dari 24 jam
            }

            // Bersihkan judul dari "update dari ..." 
            function formatJudul(instansi, konten) {
                // contoh: "update dari kelurahan padang terubuk"
                if (!instansi) return "Informasi tanpa instansi";
                let instansiClean = instansi.trim();
                // jika ada "KELURAHAN" atau "KECAMATAN" biarkan asli
                return `Update dari ${instansiClean}`;
            }

            // Extract foto URL dari google drive link
            function extractDirectImageUrl(driveLink) {
                if (!driveLink || driveLink === '') return null;
                // jika sudah direct image? coba regex
                let id = null;
                if (driveLink.includes('open?id=')) {
                    id = driveLink.split('open?id=')[1].split('&')[0].split('?')[0];
                } else if (driveLink.includes('file/d/')) {
                    const match = driveLink.match(/\/d\/(.*?)(\/|$)/);
                    if (match) id = match[1];
                }
                if (id) {
                    return `https://drive.google.com/thumbnail?id=${id}&sz=w200-h200`; // ukuran kecil
                }
                // fallback
                return null;
            }

            // Render card dari data baris (terbaru -> index kecil? tergantung endpoint)
            // asumsi data dari appscript: baris pertama header, sisanya data terbaru paling atas? 
            // kita pastikan sorting: semakin baru timestamp (desending). TAPI sesuai logika: 
            // form terbaru di baris paling bawah? atau atas? biasanya di sheet baris baru di bawah.
            // Tapi kita urutkan DESC berdasarkan timestamp kolom 0.
            function renderCards(rows) {
                const feed = document.getElementById('newsFeed');
                if (!rows || rows.length === 0) {
                    feed.innerHTML = `<div class="empty-state">
                        <i class="fas fa-newspaper" style="font-size: 42px; opacity: 0.5; margin-bottom: 16px;"></i>
                        <h3 style="font-weight: 500;">Belum ada informasi</h3>
                        <p style="margin-top: 8px;">Update dari kecamatan/kelurahan akan tampil di sini.</p>
                    </div>`;
                    return;
                }

                // batasi 1000 card
                const limited = rows.slice(0, MAX_CARDS);
                let html = '';

                limited.forEach((row, index) => {
                    // pastikan row adalah array
                    if (!Array.isArray(row) || row.length < 9) return;
                    // Mapping header: 
                    // 0: Timestamp, 1: PILIH INSTANSI, 2: TANGGAL ACARA DIMULAI, 3: WAKTU MULAI, 
                    // 4: TANGGAL BERAKHIR, 5: WAKTU BERAKHIR, 6: LOKASI, 7: ISI KONTEN, 8: FOTO KONTEN
                    const timestampRaw = row[0] || '';
                    const instansi = row[1] || 'KELURAHAN/INSTANSI';
                    const tglMulai = row[2] || '';
                    const waktuMulai = row[3] || '';
                    const tglSelesai = row[4] || '';
                    const waktuSelesai = row[5] || '';
                    const lokasi = row[6] || '';
                    let isiKonten = row[7] || 'Tidak ada keterangan lebih lanjut.';
                    const fotoUrl = row[8] || '';

                    // bersihkan isi konten
                    if (isiKonten.trim() === '') isiKonten = 'Informasi lebih lanjut dapat menghubungi kelurahan setempat.';

                    // judul: update dari instansi
                    const judul = formatJudul(instansi, isiKonten);
                    
                    // foto thumbnail
                    let thumbnailHtml = `<div class="thumbnail"><i class="fas fa-image"></i></div>`;
                    const directFoto = extractDirectImageUrl(fotoUrl);
                    if (directFoto) {
                        thumbnailHtml = `<div class="thumbnail"><img src="${directFoto}" alt="foto kegiatan" loading="lazy" onerror="this.onerror=null; this.parentElement.innerHTML='<i class=\'fas fa-camera\'></i>'"></div>`;
                    }

                    // label baru (dalam 24 jam)
                    const newLabel = isWithin24Hours(timestampRaw) ? '<span class="badge-new"><i class="fas fa-bolt" style="margin-right: 4px;"></i>BARU</span>' : '';

                    // format lokasi dan waktu untuk detail
                    const waktuDetail = `${tglMulai || ''} ${waktuMulai || ''} — ${tglSelesai || ''} ${waktuSelesai || ''}`.trim().replace(/\s+/g,' ');

                    // arrow toggle dan unique id (gunakan index dengan timestamp)
                    const cardId = `card-${index}-${Date.now()}`;

                    html += `<div class="card" id="${cardId}">
                        <div class="card-preview" onclick="this.closest('.card').classList.toggle('expanded')">
                            ${thumbnailHtml}
                            <div class="preview-content">
                                <div class="news-badge">
                                    ${newLabel}
                                    <span class="instansi-label"><i class="fas fa-building"></i> ${instansi}</span>
                                </div>
                                <div class="judul-berita">
                                    <i class="fas fa-pen-square"></i> ${judul}
                                </div>
                                <div class="meta-sumber">
                                    <span class="sumber-text"><i class="fas fa-tag"></i> Sumber: ${instansi}</span>
                                    <span style="display:flex; align-items:center; gap:4px;"><i class="far fa-clock"></i> ${new Date().toLocaleDateString('id-ID')}</span>
                                </div>
                            </div>
                            <div class="arrow-toggle">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                        <div class="card-detail">
                            <div class="detail-inner">
                                <div class="isi-konten">
                                    <i class="fas fa-quote-left" style="opacity:0.3; margin-right:6px;"></i>
                                    ${isiKonten.replace(/\n/g, '<br>')}
                                </div>
                                <div class="acara-meta">
                                    <span><i class="fas fa-map-marker-alt"></i> ${lokasi || 'Lokasi tidak tersedia'}</span>
                                    <span><i class="fas fa-calendar-alt"></i> ${waktuDetail || 'Waktu belum diinput'}</span>
                                </div>`;
                    
                    // tombol lihat foto jika ada link foto
                    if (fotoUrl && fotoUrl.trim() !== '') {
                        html += `<a href="${fotoUrl}" target="_blank" class="btn-google"><i class="fas fa-external-link-alt"></i> Lihat Foto Kegiatan</a>`;
                    } else {
                        html += `<span style="display:block; margin-top:8px; opacity:0.5;"><i class="fas fa-eye-slash"></i> Tidak ada foto</span>`;
                    }
                    
                    html += `</div></div></div>`;
                });

                feed.innerHTML = html;
            }

            // Fetch data dari Apps Script Web App
            async function fetchSheetData() {
                const feed = document.getElementById('newsFeed');
                try {
                    // axios dengan cache busting
                    const response = await axios.get(APPS_SCRIPT_URL, {
                        headers: { 'Cache-Control': 'no-cache', 'Pragma': 'no-cache' },
                        params: { _: Date.now() } // bypass cache
                    });
                    
                    let data = response.data;
                    // jika response adalah objek dengan kolom 'data' atau langsung array?
                    if (data && data.data && Array.isArray(data.data)) {
                        data = data.data;  // bentuk { data: [...] }
                    }
                    
                    if (Array.isArray(data) && data.length > 1) {
                        // data[0] = header, kita buang header, ambil mulai index 1
                        let rows = data.slice(1); 
                        // Filter row yang kosong? baris mungkin semua kosong.
                        rows = rows.filter(row => row.length >= 2 && row[0] !== '' && row[1] !== '');
                        
                        // Sorting berdasarkan timestamp kolom 0 (descending -> terbaru di atas)
                        rows.sort((a, b) => {
                            const dateA = new Date(a[0]);
                            const dateB = new Date(b[0]);
                            if (isNaN(dateA) && isNaN(dateB)) return 0;
                            if (isNaN(dateA)) return 1;
                            if (isNaN(dateB)) return -1;
                            return dateB - dateA; // besar ke kecil (descending, terbaru diatas)
                        });

                        allRows = rows;
                        renderCards(allRows);
                    } else {
                        // data kosong
                        renderCards([]);
                    }
                } catch (error) {
                    console.error('Error fetching sheet:', error);
                    feed.innerHTML = `<div class="empty-state" style="padding: 50px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 36px; color: #b45309;"></i>
                        <p style="margin-top: 16px;">Gagal memuat data. Gunakan data contoh.</p>
                    </div>`;
                    // fallback: demo data from spreadsheet description (baris pertama)
                    const demoRow = [
                        ["2/12/2026 22:34:29","KELURAHAN PADANG TERUBUK","2/13/2026","11:00:00 AM","2/13/2026","2:00:00 PM","JALAN MELUR NO 4","PEMBAGIAN BERAS BULOG","https://drive.google.com/open?id=1z7XHxr_DKUXQhvLhdvNTi4yUGwp94Mbb"]
                    ];
                    allRows = demoRow;
                    renderCards(allRows);
                }
            }

            // initial fetch dan auto refresh setiap 25 detik (near realtime)
            fetchSheetData();
            // Refresh periodik, agar update dari form cepat muncul tanpa delay
            setInterval(fetchSheetData, 25000); // tiap 25 detik

            // tambahan: parameter supaya saat klik arrow tidak muncul outline aneh
        })();
    </script>

    <!-- fallback untuk fungsi toggle pada event onclick (global) -->
    <script>
        // Memastikan method toggle jalan di semua environment
        document.addEventListener('click', function(e) {
            const preview = e.target.closest('.card-preview');
            if (preview) {
                const card = preview.closest('.card');
                if (card) {
                    card.classList.toggle('expanded');
                }
            }
        });
    </script>
</body>
</html>
