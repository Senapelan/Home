<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Update Info ¬∑ Senapelan ¬∑ Real-time</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* SAME PREMIUM STYLES - I'll keep it clean and compact */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(145deg, #f6f9fc 0%, #edf2f7 100%);
            font-family: 'Inter', sans-serif;
            padding: 32px 24px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #1e293b;
        }
        .premium-container { max-width: 1100px; width: 100%; margin: 0 auto; }
        .page-header {
            display: flex;
            flex-direction: column;
            margin-bottom: 40px;
            position: relative;
        }
        .page-header h1 {
            font-size: 2.2rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            background: linear-gradient(145deg, #0f2b3d, #1e4a6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
            border-left: 8px solid #e11d48;
            padding-left: 24px;
            line-height: 1.2;
        }
        .subhead {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-left: 32px;
            color: #4b5e6b;
            font-weight: 400;
            font-size: 1rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding-bottom: 16px;
        }
        .live-badge {
            background: #10b981;
            color: white;
            padding: 6px 14px;
            border-radius: 60px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 6px 14px rgba(16,185,129,0.2);
        }
        .last-update {
            font-size: 0.8rem;
            color: #64748b;
            margin-top: 8px;
            margin-left: 32px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .news-feed {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
        }
        .card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.6);
            border-radius: 28px;
            box-shadow: 0 15px 35px -12px rgba(0,20,30,0.12);
            transition: all 0.25s ease;
            width: 100%;
            overflow: hidden;
        }
        .card:hover {
            box-shadow: 0 24px 44px -14px rgba(0,55,80,0.18);
            background: white;
        }
        .card-preview {
            display: flex;
            align-items: center;
            padding: 16px 22px;
            gap: 18px;
            cursor: pointer;
            position: relative;
        }
        .thumbnail {
            width: 70px;
            height: 70px;
            flex-shrink: 0;
            background: #f1f5f9;
            border-radius: 18px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(0,0,0,0.02);
            box-shadow: 0 8px 18px -8px rgba(0,0,0,0.08);
        }
        .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .thumbnail i {
            font-size: 28px;
            color: #94a3b8;
        }
        .preview-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 0;
        }
        .news-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
            flex-wrap: wrap;
        }
        .badge-new {
            background: #e11d48;
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 60px;
            text-transform: uppercase;
            box-shadow: 0 4px 12px rgba(225,29,72,0.25);
        }
        .instansi-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #547087;
            background: rgba(84,112,135,0.08);
            padding: 4px 12px;
            border-radius: 60px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-transform: uppercase;
        }
        .judul-berita {
            font-size: 1.12rem;
            font-weight: 650;
            color: #0a1c2a;
            line-height: 1.4;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .meta-sumber {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 0.8rem;
            color: #4f6f7f;
        }
        .sumber-text {
            background: rgba(20, 100, 120, 0.05);
            padding: 4px 12px;
            border-radius: 50px;
            font-weight: 500;
        }
        .arrow-toggle {
            color: #607d8b;
            background: white;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            box-shadow: 0 6px 16px rgba(0,0,0,0.03);
            border: 1px solid rgba(0,0,0,0.02);
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .card.expanded .arrow-toggle {
            transform: rotate(180deg);
            background: #f1f9ff;
            color: #0a4b6e;
        }
        .card-detail {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.45s cubic-bezier(0.23, 1, 0.32, 1), opacity 0.35s ease;
            background: rgba(249, 252, 255, 0.7);
            border-top: 0px solid rgba(0,0,0,0.02);
        }
        .card.expanded .card-detail {
            max-height: 800px;
            opacity: 1;
            padding: 22px 24px 28px;
            border-top: 1px solid rgba(168, 192, 207, 0.2);
        }
        .detail-inner {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .isi-konten {
            font-size: 1rem;
            line-height: 1.65;
            color: #1f3a4b;
            background: white;
            padding: 20px;
            border-radius: 20px;
            border: 1px solid rgba(84,110,122,0.08);
            white-space: pre-line;
        }
        .acara-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 20px 32px;
            background: rgba(203, 223, 233, 0.2);
            padding: 14px 20px;
            border-radius: 24px;
            color: #1f4e5f;
            font-size: 0.85rem;
            font-weight: 500;
        }
        .btn-google {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: #0a4b6e;
            color: white;
            padding: 14px 26px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 0.9rem;
            text-decoration: none;
            width: fit-content;
            box-shadow: 0 8px 18px rgba(10,75,110,0.2);
            margin-top: 8px;
        }
        .btn-google:hover {
            background: #0e5f88;
            transform: scale(0.98);
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: rgba(255,255,255,0.5);
            border-radius: 60px;
            color: #4e6a79;
        }
        .loading-skeleton {
            padding: 40px;
            text-align: center;
        }
        footer {
            margin-top: 50px;
            font-size: 0.8rem;
            color: #7c8f99;
            text-align: center;
            border-top: 1px solid rgba(0,0,0,0.04);
            padding-top: 30px;
        }
        @media (max-width: 550px) {
            body { padding: 20px 16px; }
            .page-header h1 { font-size: 1.6rem; }
            .judul-berita { white-space: normal; }
        }
    </style>
</head>
<body>
    <div class="premium-container">
        <div class="page-header">
            <h1>UPDATE INFORMASI <br>KECAMATAN DAN KELURAHAN DI SENAPELAN</h1>
            <div class="subhead">
                <span><i class="fas fa-map-pin" style="color:#e11d48;"></i> Sumber terpercaya ¬∑ Kecamatan Senapelan</span>
                <span class="live-badge"><i class="fas fa-circle"></i> REAL-TIME ¬∑ SHEET</span>
            </div>
            <div class="last-update" id="lastUpdateInfo">
                <i class="fas fa-sync-alt"></i> Menunggu data pertama...
            </div>
        </div>

        <div id="newsFeed" class="news-feed">
            <div class="loading-skeleton">
                <i class="fas fa-spinner fa-pulse fa-2x" style="color:#1e4a6b;"></i>
                <p style="margin-top: 16px;">Memuat update terkini...</p>
            </div>
        </div>
        <footer>
            <i class="fas fa-database"></i> Sinkron real-time dengan spreadsheet ¬∑ Hapus baris di sheet = hilang di web
        </footer>
    </div>

    <script>
        (function() {
            "use strict";

            // ================ KONFIGURASI ================
            const SPREADSHEET_ID = '1lvWJ615b3FrjKO-JULTQ2Yq5HC4Mvfzjleej8Td3kmI';
            const SHEET_NAME = 'UPDATE_INFORMASI';
            
            // GUNAKAN CSV ENDPOINT - PALING CEPAT DAN REAL-TIME
            const CSV_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}&t=${Date.now()}`;
            
            // ================ STATE MANAGEMENT ================
            let expandedCardId = null; // Menyimpan card mana yang sedang terbuka
            
            // ================ UTILITY ================
            
            // Parse CSV dengan benar (handle quotes dan koma di dalam teks)
            function parseCSV(csvText) {
                const lines = csvText.split('\n');
                const result = [];
                
                for (let line of lines) {
                    if (!line.trim()) continue;
                    
                    const row = [];
                    let inQuotes = false;
                    let currentValue = '';
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        
                        if (char === '"') {
                            if (inQuotes && line[i + 1] === '"') {
                                // Double quotes inside quotes
                                currentValue += '"';
                                i++;
                            } else {
                                inQuotes = !inQuotes;
                            }
                        } else if (char === ',' && !inQuotes) {
                            row.push(currentValue);
                            currentValue = '';
                        } else {
                            currentValue += char;
                        }
                    }
                    row.push(currentValue);
                    result.push(row);
                }
                
                return result;
            }

            // Cek apakah timestamp dalam 24 jam terakhir
            function isNewPost(timestampStr) {
                if (!timestampStr) return false;
                
                try {
                    // Bersihkan string
                    let cleanStr = timestampStr.trim();
                    
                    // Handle format dengan AM/PM
                    if (cleanStr.includes('AM') || cleanStr.includes('PM')) {
                        const parts = cleanStr.split(' ');
                        if (parts.length >= 3) {
                            const dateParts = parts[0].split('/');
                            const timeParts = parts[1].split(':');
                            const ampm = parts[2];
                            
                            if (dateParts.length === 3 && timeParts.length >= 2) {
                                let month = parseInt(dateParts[0]) - 1;
                                let day = parseInt(dateParts[1]);
                                let year = parseInt(dateParts[2]);
                                if (year < 100) year += 2000;
                                
                                let hour = parseInt(timeParts[0]);
                                let minute = parseInt(timeParts[1]);
                                let second = timeParts[2] ? parseInt(timeParts[2]) : 0;
                                
                                if (ampm.toUpperCase() === 'PM' && hour < 12) hour += 12;
                                if (ampm.toUpperCase() === 'AM' && hour === 12) hour = 0;
                                
                                const dateObj = new Date(year, month, day, hour, minute, second);
                                const now = new Date();
                                return (now - dateObj) < 24 * 60 * 60 * 1000;
                            }
                        }
                    } else {
                        // Format standar
                        const dateObj = new Date(cleanStr);
                        if (!isNaN(dateObj.getTime())) {
                            const now = new Date();
                            return (now - dateObj) < 24 * 60 * 60 * 1000;
                        }
                    }
                } catch (e) {
                    console.error('Date parse error:', e);
                }
                return false;
            }

            // Extract Google Drive Image ID
            function getDriveThumbnail(url) {
                if (!url) return null;
                try {
                    let id = null;
                    if (url.includes('open?id=')) {
                        id = url.split('open?id=')[1].split('&')[0];
                    } else if (url.includes('file/d/')) {
                        const match = url.match(/\/d\/(.*?)(\/|$)/);
                        if (match) id = match[1];
                    } else if (url.includes('id=')) {
                        id = url.split('id=')[1].split('&')[0];
                    }
                    
                    if (id) {
                        return `https://drive.google.com/thumbnail?id=${id}&sz=w200-h200`;
                    }
                } catch (e) {}
                return null;
            }

            // ================ RENDER CARDS ================
            function renderCards(rows) {
                const feed = document.getElementById('newsFeed');
                
                if (!rows || rows.length === 0) {
                    feed.innerHTML = `<div class="empty-state">
                        <i class="fas fa-newspaper" style="font-size: 42px; opacity: 0.5;"></i>
                        <h3 style="margin-top: 16px;">Belum ada informasi</h3>
                        <p style="margin-top: 8px;">Update dari form akan tampil di sini secara real-time</p>
                    </div>`;
                    return;
                }

                // Batasi 1000 card
                const limited = rows.slice(0, 1000);
                
                let html = '';

                limited.forEach((row, index) => {
                    // Validasi minimal kolom
                    if (!Array.isArray(row) || row.length < 7) return;
                    
                    // Mapping kolom
                    const timestamp = row[0] || '';
                    const instansi = row[1] || 'INSTANSI';
                    const tglMulai = row[2] || '';
                    const waktuMulai = row[3] || '';
                    const tglSelesai = row[4] || '';
                    const waktuSelesai = row[5] || '';
                    const lokasi = row[6] || 'Lokasi tidak tersedia';
                    let isiKonten = row[7] || 'Tidak ada keterangan lebih lanjut.';
                    const fotoUrl = row[8] || '';

                    // ID unik berdasarkan timestamp + instansi
                    const cardId = `card-${index}-${timestamp.replace(/[^0-9]/g, '').slice(-8)}`;
                    
                    // Cek apakah card ini sebelumnya terbuka
                    const isExpanded = (expandedCardId === cardId);
                    
                    // Thumbnail
                    let thumbnailHtml = `<div class="thumbnail"><i class="fas fa-image"></i></div>`;
                    const thumbUrl = getDriveThumbnail(fotoUrl);
                    if (thumbUrl) {
                        thumbnailHtml = `<div class="thumbnail"><img src="${thumbUrl}" alt="foto" loading="lazy" onerror="this.parentElement.innerHTML='<i class=\\'fas fa-camera\\'></i>'"></div>`;
                    }

                    // Label BARU
                    const newLabel = isNewPost(timestamp) ? 
                        '<span class="badge-new"><i class="fas fa-bolt"></i>BARU</span>' : '';

                    // Format waktu detail
                    let waktuDetail = 'Waktu belum ditentukan';
                    if (tglMulai && waktuMulai) {
                        waktuDetail = `${tglMulai} ${waktuMulai}`;
                        if (tglSelesai && waktuSelesai) {
                            waktuDetail += ` ‚Äî ${tglSelesai} ${waktuSelesai}`;
                        }
                    }

                    // Judul
                    const judul = `Update dari ${instansi}`;

                    html += `<div class="card ${isExpanded ? 'expanded' : ''}" data-card-id="${cardId}">
                        <div class="card-preview">
                            ${thumbnailHtml}
                            <div class="preview-content">
                                <div class="news-badge">
                                    ${newLabel}
                                    <span class="instansi-label"><i class="fas fa-building"></i> ${instansi}</span>
                                </div>
                                <div class="judul-berita">
                                    <i class="fas fa-pen-square"></i> ${judul}
                                </div>
                                <div class="meta-sumber">
                                    <span class="sumber-text"><i class="fas fa-tag"></i> Sumber: ${instansi}</span>
                                    <span><i class="far fa-clock"></i> ${new Date(timestamp).toLocaleDateString('id-ID') || ''}</span>
                                </div>
                            </div>
                            <div class="arrow-toggle">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                        <div class="card-detail">
                            <div class="detail-inner">
                                <div class="isi-konten">${isiKonten.replace(/\n/g, '<br>')}</div>
                                <div class="acara-meta">
                                    <span><i class="fas fa-map-marker-alt"></i> ${lokasi}</span>
                                    <span><i class="fas fa-calendar-alt"></i> ${waktuDetail}</span>
                                </div>`;
                    
                    if (fotoUrl && fotoUrl.trim()) {
                        html += `<a href="${fotoUrl}" target="_blank" class="btn-google">
                                    <i class="fas fa-external-link-alt"></i> Lihat Foto Kegiatan
                                </a>`;
                    }
                    
                    html += `</div></div></div>`;
                });

                feed.innerHTML = html;
                
                // Update info last update
                document.getElementById('lastUpdateInfo').innerHTML = 
                    `<i class="fas fa-check-circle" style="color:#10b981;"></i> Terakhir sinkron: ${new Date().toLocaleTimeString('id-ID')} ¬∑ ${rows.length} berita`;
            }

            // ================ EVENT HANDLER ================
            function setupCardEvents() {
                const feed = document.getElementById('newsFeed');
                
                // Hapus event listener lama
                feed.removeEventListener('click', handleCardClick);
                // Tambah event listener baru
                feed.addEventListener('click', handleCardClick);
            }

            function handleCardClick(e) {
                const preview = e.target.closest('.card-preview');
                if (!preview) return;
                
                const card = preview.closest('.card');
                if (!card) return;
                
                e.preventDefault();
                e.stopPropagation();
                
                const cardId = card.dataset.cardId;
                
                // Toggle expanded state
                if (card.classList.contains('expanded')) {
                    card.classList.remove('expanded');
                    expandedCardId = null; // Tidak ada card yang terbuka
                } else {
                    // Tutup semua card lain
                    document.querySelectorAll('.card').forEach(c => {
                        c.classList.remove('expanded');
                    });
                    
                    // Buka card ini
                    card.classList.add('expanded');
                    expandedCardId = cardId; // Simpan ID card yang terbuka
                }
            }

            // ================ FETCH DATA REAL-TIME ================
            async function fetchSheetData() {
                try {
                    // Fetch dengan cache busting maksimal
                    const response = await fetch(`${CSV_URL}&_=${Date.now()}${Math.random()}`, {
                        method: 'GET',
                        cache: 'no-store',
                        headers: {
                            'Cache-Control': 'no-cache, no-store, must-revalidate, max-age=0',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const csvText = await response.text();
                    
                    // Parse CSV
                    let rows = parseCSV(csvText);
                    
                    // Buang header (baris pertama)
                    if (rows.length > 0) {
                        rows = rows.slice(1);
                    }
                    
                    // Filter baris KOSONG dan TIDAK VALID
                    rows = rows.filter(row => {
                        // Baris harus memiliki timestamp dan instansi yang valid
                        return row && 
                               row.length >= 2 && 
                               row[0] && row[0].trim() !== '' && 
                               row[1] && row[1].trim() !== '' &&
                               row[0] !== 'Timestamp'; // Bukan header
                    });

                    // SORTIR berdasarkan TIMESTAMP (TERBARU DI ATAS)
                    rows.sort((a, b) => {
                        try {
                            const dateA = new Date(a[0]);
                            const dateB = new Date(b[0]);
                            if (isNaN(dateA.getTime())) return 1;
                            if (isNaN(dateB.getTime())) return -1;
                            return dateB.getTime() - dateA.getTime(); // Descending
                        } catch (e) {
                            return 0;
                        }
                    });

                    console.log(`üìä Data real-time: ${rows.length} baris valid dari spreadsheet`);
                    
                    // Render cards
                    renderCards(rows);
                    
                } catch (error) {
                    console.error('‚ùå Gagal fetch spreadsheet:', error);
                    
                    const feed = document.getElementById('newsFeed');
                    feed.innerHTML = `<div class="empty-state">
                        <i class="fas fa-exclamation-triangle" style="font-size: 36px; color: #b45309;"></i>
                        <h3 style="margin-top: 16px;">Gagal sinkron</h3>
                        <p style="margin-top: 8px;">Mencoba lagi dalam 5 detik...</p>
                    </div>`;
                }
            }

            // ================ INITIALIZATION ================
            
            // Fetch pertama kali
            fetchSheetData();
            
            // Auto refresh SETIAP 5 DETIK - REAL-TIME
            setInterval(fetchSheetData, 5000);
            
            // Setup event listeners
            setTimeout(() => {
                setupCardEvents();
            }, 1000);
            
            // Pastikan event listener tetap aktif setelah render ulang
            const originalRender = renderCards;
            window.renderCards = function(rows) {
                originalRender(rows);
                setupCardEvents();
            };
            
            // Override renderCards
            renderCards = function(rows) {
                originalRender(rows);
                setupCardEvents();
            };

        })();
    </script>
</body>
</html>
