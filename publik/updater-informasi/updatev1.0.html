<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Informasi Senapelan</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        .header {
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 28px;
            color: #0c4a6e;
            border-left: 6px solid #e11d48;
            padding-left: 20px;
        }
        .badge {
            background: #059669;
            color: white;
            padding: 6px 16px;
            border-radius: 100px;
            font-size: 14px;
            display: inline-block;
            margin-top: 10px;
        }
        .card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 16px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        .card-preview {
            display: flex;
            align-items: center;
            padding: 16px;
            gap: 16px;
            cursor: pointer;
        }
        .thumbnail {
            width: 70px;
            height: 70px;
            background: #f1f5f9;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .content {
            flex: 1;
        }
        .instansi {
            background: #f1f5f9;
            padding: 4px 12px;
            border-radius: 100px;
            font-size: 12px;
            font-weight: 600;
            color: #334155;
            display: inline-block;
        }
        .judul {
            font-size: 16px;
            font-weight: 600;
            color: #0f172a;
            margin: 6px 0;
        }
        .sumber {
            font-size: 13px;
            color: #64748b;
        }
        .arrow {
            width: 36px;
            height: 36px;
            background: #f8fafc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
        }
        .card.expanded .arrow {
            transform: rotate(180deg);
            background: #e0f2fe;
            color: #0369a1;
        }
        .card-detail {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: 0.3s;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
        }
        .card.expanded .card-detail {
            max-height: 600px;
            opacity: 1;
            padding: 20px;
        }
        .btn {
            background: #0c4a6e;
            color: white;
            padding: 12px 24px;
            border-radius: 100px;
            text-decoration: none;
            display: inline-block;
            margin-top: 12px;
            font-size: 14px;
        }
        .status {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }
        .label-baru {
            background: #e11d48;
            color: white;
            padding: 2px 10px;
            border-radius: 100px;
            font-size: 11px;
            font-weight: 700;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>UPDATE INFORMASI<br>KECAMATAN & KELURAHAN SENAPELAN</h1>
            <div class="badge">
                <i class="fas fa-circle" style="font-size: 10px;"></i> REAL-TIME
            </div>
            <p id="lastUpdate" style="margin-top: 10px; color: #475569;">
                <i class="fas fa-sync"></i> Menghubungkan...
            </p>
        </div>

        <div id="feed"></div>
        
        <p style="text-align: center; margin-top: 40px; color: #94a3b8; font-size: 13px;">
            <i class="fas fa-bolt"></i> Update setiap 5 detik · Sinkron dengan spreadsheet
        </p>
    </div>

    <script>
        // MASUKKAN URL APPS SCRIPT ANDA DI SINI
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby6_TGaueFLliw6C_fmD-eQkyuwkm4Ju7bfH_hTC1G1zjkGwzN21cD1v84KRKAbdAQEFw/exec';
        
        let expandedId = null;

        async function ambilData() {
            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?t=${Date.now()}`);
                const result = await response.json();
                
                if (result.success) {
                    tampilkanData(result.data);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                document.getElementById('feed').innerHTML = `
                    <div class="status">
                        <i class="fas fa-exclamation-triangle" style="font-size: 40px; color: #e11d48;"></i>
                        <h3 style="margin: 16px 0;">Gagal mengambil data</h3>
                        <p style="color: #64748b;">${error.message || 'Cek koneksi internet'}</p>
                        <p style="margin-top: 20px; font-size: 14px;">Mencoba lagi dalam 3 detik...</p>
                    </div>
                `;
            }
        }

        function tampilkanData(data) {
            if (!data || data.length === 0) {
                document.getElementById('feed').innerHTML = `
                    <div class="status">
                        <i class="fas fa-newspaper" style="font-size: 40px; color: #94a3b8;"></i>
                        <h3 style="margin: 16px 0;">Belum ada informasi</h3>
                        <p>Data akan muncul setelah form diisi</p>
                    </div>
                `;
                return;
            }

            let html = '';
            
            data.slice(0, 100).forEach((item, index) => {
                const timestamp = item.Timestamp || item[0] || '';
                const instansi = item['PILIH INSTANSI'] || item[1] || 'KELURAHAN';
                const lokasi = item['LOKASI ACARA'] || item[6] || '-';
                const isi = item['ISI KONTEN'] || item[7] || 'Tidak ada keterangan';
                const foto = item['FOTO KONTEN'] || item[8] || '';
                const tglMulai = item['TANGGAL ACARA DIMULAI'] || item[2] || '';
                const waktuMulai = item['WAKTU MULAI'] || item[3] || '';
                
                // Cek apakah postingan baru (24 jam)
                const isNew = cekBaru(timestamp);
                
                // Buat ID unik
                const cardId = `card-${index}`;
                
                // Thumbnail foto
                let thumbHtml = '<div class="thumbnail"><i class="fas fa-image" style="color: #94a3b8; font-size: 24px;"></i></div>';
                if (foto) {
                    const fileId = ambilIdDrive(foto);
                    if (fileId) {
                        thumbHtml = `<div class="thumbnail"><img src="https://drive.google.com/thumbnail?id=${fileId}&sz=w120-h120" onerror="this.parentElement.innerHTML='<i class=\'fas fa-camera\'></i>'"></div>`;
                    }
                }
                
                html += `
                    <div class="card ${expandedId === cardId ? 'expanded' : ''}" data-id="${cardId}">
                        <div class="card-preview" onclick="toggleCard('${cardId}')">
                            ${thumbHtml}
                            <div class="content">
                                <div>
                                    <span class="instansi"><i class="fas fa-building"></i> ${instansi}</span>
                                    ${isNew ? '<span class="label-baru">BARU</span>' : ''}
                                </div>
                                <div class="judul">Update dari ${instansi}</div>
                                <div class="sumber">
                                    <i class="fas fa-tag"></i> Sumber: ${instansi}
                                    <span style="margin-left: 12px;"><i class="far fa-clock"></i> ${formatTanggal(timestamp)}</span>
                                </div>
                            </div>
                            <div class="arrow">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                        <div class="card-detail">
                            <p style="margin-bottom: 16px; line-height: 1.6;">${isi.replace(/\n/g, '<br>')}</p>
                            <p style="background: white; padding: 12px; border-radius: 12px; margin-bottom: 8px;">
                                <i class="fas fa-map-marker-alt" style="color: #e11d48;"></i> ${lokasi}
                            </p>
                            <p style="background: white; padding: 12px; border-radius: 12px;">
                                <i class="fas fa-calendar" style="color: #e11d48;"></i> ${tglMulai} ${waktuMulai}
                            </p>
                `;
                
                if (foto) {
                    html += `<a href="${foto}" target="_blank" class="btn"><i class="fas fa-external-link"></i> Lihat Foto</a>`;
                }
                
                html += `</div></div>`;
            });
            
            document.getElementById('feed').innerHTML = html;
            document.getElementById('lastUpdate').innerHTML = `<i class="fas fa-check-circle" style="color: #059669;"></i> Terakhir update: ${new Date().toLocaleTimeString('id-ID')} · ${data.length} berita`;
        }

        // Fungsi untuk toggle card
        window.toggleCard = function(cardId) {
            const card = document.querySelector(`[data-id="${cardId}"]`);
            if (card) {
                if (card.classList.contains('expanded')) {
                    card.classList.remove('expanded');
                    expandedId = null;
                } else {
                    document.querySelectorAll('.card').forEach(c => c.classList.remove('expanded'));
                    card.classList.add('expanded');
                    expandedId = cardId;
                }
            }
        };

        // Cek 24 jam
        function cekBaru(timestamp) {
            if (!timestamp) return false;
            try {
                const waktu = new Date(timestamp);
                if (isNaN(waktu)) return false;
                const sekarang = new Date();
                const selisih = (sekarang - waktu) / (1000 * 60 * 60);
                return selisih < 24;
            } catch {
                return false;
            }
        }

        // Ambil ID Google Drive
        function ambilIdDrive(url) {
            if (!url) return null;
            if (url.includes('open?id=')) {
                return url.split('open?id=')[1].split('&')[0];
            }
            if (url.includes('file/d/')) {
                const match = url.match(/\/d\/(.*?)(\/|$)/);
                return match ? match[1] : null;
            }
            return null;
        }

        // Format tanggal
        function formatTanggal(timestamp) {
            try {
                const date = new Date(timestamp);
                if (isNaN(date)) return '-';
                return date.toLocaleDateString('id-ID');
            } catch {
                return '-';
            }
        }

        // Ambil data setiap 5 detik
        ambilData();
        setInterval(ambilData, 5000);
    </script>
</body>
</html>
