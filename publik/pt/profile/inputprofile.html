<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Input Data Profile Pegawai</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --gray: #95a5a6;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --radius: 10px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary), #1a2530);
            color: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .logo-icon {
            font-size: 2.5rem;
            color: var(--secondary);
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 600;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            border: 1px solid #e0e0e0;
        }

        .login-card {
            max-width: 400px;
            margin: 30px auto;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light);
        }

        .card-header h2 {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary);
        }

        .card-actions {
            display: flex;
            gap: 10px;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            border-color: var(--secondary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        /* Button Styles */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--secondary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #219653;
        }

        .btn-secondary {
            background: var(--gray);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #c0392b;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-collapse {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: var(--primary);
            cursor: pointer;
            padding: 5px;
        }

        /* Card Content Layout */
        .card-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }

        /* Photo Section */
        .photo-section {
            padding-left: 20px;
            border-left: 2px solid var(--light);
        }

        @media (max-width: 768px) {
            .card-content {
                grid-template-columns: 1fr;
            }
            
            .photo-section {
                padding-left: 0;
                border-left: none;
                border-top: 2px solid var(--light);
                padding-top: 20px;
            }
        }

        .photo-upload {
            text-align: center;
        }

        .photo-note {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 10px;
            border-radius: 6px;
            margin: 15px 0;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .photo-preview-container {
            margin: 20px 0;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .photo-preview {
            width: 150px;
            height: 187.5px; /* 4:5 ratio */
            border: 2px dashed #ddd;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            color: var(--gray);
            overflow: hidden;
            position: relative;
        }

        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        /* Pegawai Card */
        .pegawai-card {
            margin-bottom: 20px;
            border-left: 4px solid var(--secondary);
        }

        .pegawai-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--light);
        }

        .pegawai-card-header h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary);
        }

        .card-footer {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--light);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--light);
        }

        .modal-header h3 {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--light);
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        .crop-container {
            width: 100%;
            height: 400px;
            overflow: hidden;
        }

        #crop-image {
            max-width: 100%;
            max-height: 400px;
        }

        .crop-note {
            margin-top: 15px;
            padding: 10px;
            background: #e8f4fc;
            border-radius: 6px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-content {
            text-align: center;
            color: white;
        }

        .loading-content i {
            font-size: 3rem;
            margin-bottom: 20px;
        }

        .loading-content p {
            font-size: 1.2rem;
        }

        /* Login Note */
        .login-note {
            margin-top: 20px;
            padding: 15px;
            background: #e8f4fc;
            border-radius: 8px;
            text-align: center;
            color: var(--primary);
        }

        .login-note i {
            margin-right: 8px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .logo-container {
                flex-direction: column;
                text-align: center;
            }
            
            .pegawai-card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
        }

        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .main-content {
            animation: fadeIn 0.5s ease-out;
        }

        /* Status Messages */
        .status-message {
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            min-width: 300px;
            box-shadow: var(--shadow);
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        /* Photo Actions */
        .photo-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        /* File Input Styling */
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        /* Card Count Badge */
        .card-count-badge {
            background: var(--secondary);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-left: 10px;
        }

        /* Required Field */
        .required::after {
            content: " *";
            color: var(--danger);
        }

        /* Photo Loading */
        .photo-loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }

        /* Auto Save Indicator */
        .auto-save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 10px 15px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: none;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo-container">
                <i class="fas fa-user-tie logo-icon"></i>
                <h1>Sistem Input Data Profile Pegawai</h1>
            </div>
            <p class="subtitle">Pemerintah Kota Pekanbaru</p>
        </header>

        <!-- Login Card -->
        <div id="login-card" class="card login-card">
            <h2><i class="fas fa-lock"></i> Autentikasi Pengguna</h2>
            <div class="login-form">
                <div class="form-group">
                    <label for="username"><i class="fas fa-user"></i> Username</label>
                    <input type="text" id="username" placeholder="Masukkan username" value="Admin">
                </div>
                <div class="form-group">
                    <label for="password"><i class="fas fa-key"></i> Password</label>
                    <input type="password" id="password" placeholder="Masukkan password" value="123456">
                </div>
                <div class="form-group">
                    <button id="login-btn" class="btn btn-primary">
                        <i class="fas fa-sign-in-alt"></i> Proses Login
                    </button>
                </div>
                <div class="login-note">
                    <p><i class="fas fa-info-circle"></i> Default: Admin / 123456</p>
                </div>
            </div>
        </div>

        <!-- Main Content (hidden until login) -->
        <div id="main-content" class="main-content" style="display: none;">
            <!-- Kantor Card -->
            <div class="card-container">
                <div class="card-header">
                    <h2><i class="fas fa-building"></i> Data Kantor</h2>
                    <button class="btn-collapse" data-target="kantor-card">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                <div id="kantor-card" class="card kantor-card">
                    <h3><i class="fas fa-edit"></i> LENGKAPI DATA KANTOR ANDA</h3>
                    <div class="card-content">
                        <div class="form-section">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="nama_kelurahan" class="required"><i class="fas fa-signature"></i> NAMA KELURAHAN</label>
                                    <input type="text" id="nama_kelurahan" required>
                                </div>
                                <div class="form-group">
                                    <label for="alamat" class="required"><i class="fas fa-map-marker-alt"></i> ALAMAT</label>
                                    <input type="text" id="alamat" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="rt" class="required"><i class="fas fa-hashtag"></i> RT</label>
                                    <input type="text" id="rt" required>
                                </div>
                                <div class="form-group">
                                    <label for="rw" class="required"><i class="fas fa-hashtag"></i> RW</label>
                                    <input type="text" id="rw" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="kelurahan" class="required"><i class="fas fa-map"></i> KELURAHAN</label>
                                    <input type="text" id="kelurahan" required>
                                </div>
                                <div class="form-group">
                                    <label for="kecamatan" class="required"><i class="fas fa-map"></i> KECAMATAN</label>
                                    <input type="text" id="kecamatan" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="kota"><i class="fas fa-city"></i> KOTA</label>
                                    <input type="text" id="kota" value="Pekanbaru" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="provinsi"><i class="fas fa-globe"></i> PROVINSI</label>
                                    <input type="text" id="provinsi" value="Riau" readonly>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="kode_pos" class="required"><i class="fas fa-mail-bulk"></i> KODE POS</label>
                                    <input type="text" id="kode_pos" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="photo-section">
                            <div class="photo-upload">
                                <h4><i class="fas fa-camera"></i> Upload Logo Kantor</h4>
                                <p class="photo-note">
                                    <i class="fas fa-exclamation-triangle"></i> Mohon upload lambang Pemko Pekanbaru
                                </p>
                                <div class="photo-preview-container">
                                    <div id="kantor-photo-preview" class="photo-preview">
                                        <i class="fas fa-building preview-icon"></i>
                                        <span>Preview Logo</span>
                                    </div>
                                </div>
                                <div class="photo-actions">
                                    <div class="file-input-wrapper">
                                        <button id="kantor-upload-btn" class="btn btn-secondary">
                                            <i class="fas fa-upload"></i> Pilih Foto
                                        </button>
                                        <input type="file" id="kantor-photo-upload" accept="image/*">
                                    </div>
                                    <button id="kantor-crop-btn" class="btn btn-secondary" style="display: none;">
                                        <i class="fas fa-crop-alt"></i> Crop Foto
                                    </button>
                                </div>
                                <div id="kantor-photo-loading" class="photo-loading" style="display: none;">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <button id="save-kantor" class="btn btn-success">
                            <i class="fas fa-save"></i> Simpan Data Kantor
                        </button>
                        <button id="reset-kantor" class="btn btn-secondary">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                    </div>
                </div>
            </div>

            <!-- Pegawai Cards -->
            <div class="card-container">
                <div class="card-header">
                    <h2><i class="fas fa-users"></i> Data Pegawai</h2>
                    <div class="card-actions">
                        <span id="card-count" class="card-count-badge">0/10</span>
                        <button id="add-card-btn" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Tambah Card
                        </button>
                    </div>
                </div>
                
                <div id="pegawai-cards-container">
                    <!-- Cards will be dynamically added here -->
                </div>
            </div>
        </div>

        <!-- Crop Modal -->
        <div id="crop-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-crop-alt"></i> Crop Foto</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="crop-container">
                        <img id="crop-image" src="" alt="Crop Preview">
                    </div>
                    <p class="crop-note"><i class="fas fa-info-circle"></i> Pastikan foto dengan rasio 4:5 (1080x1350px)</p>
                </div>
                <div class="modal-footer">
                    <button id="cancel-crop" class="btn btn-secondary">Batal</button>
                    <button id="apply-crop" class="btn btn-primary">Terapkan Crop</button>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loading" class="loading-overlay" style="display: none;">
            <div class="loading-content">
                <i class="fas fa-spinner fa-spin"></i>
                <p id="loading-text">Memproses data...</p>
            </div>
        </div>

        <!-- Auto Save Indicator -->
        <div id="auto-save-indicator" class="auto-save-indicator">
            <i class="fas fa-check-circle"></i> Data tersimpan otomatis
        </div>
    </div>

    <!-- External JS Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <!-- Load external JavaScript file -->
    <script src="https://cdn.jsdelivr.net/gh/username/repository@main/publik/pt/profile/kirimdanambil.js"></script>
    
    <!-- Inline JavaScript for UI interactions -->
    <script>
        // State aplikasi
        const appState = {
            isLoggedIn: false,
            currentUser: null,
            kantorData: null,
            pegawaiData: {},
            activeCards: new Set(),
            nextCardId: 1,
            currentPhotoType: null,
            currentPhotoIndex: null,
            cropper: null,
            isProcessing: false,
            APP_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbx_idtLPGT_wK9N9BNmjqCBExK50gGonoi_uoUv58Kg95Zyk5_sV8I8meD5B85urtp4XQ/exec' // Ganti dengan URL Apps Script Anda
        };

        // DOM Elements
        const elements = {
            loginCard: document.getElementById('login-card'),
            mainContent: document.getElementById('main-content'),
            usernameInput: document.getElementById('username'),
            passwordInput: document.getElementById('password'),
            loginBtn: document.getElementById('login-btn'),
            addCardBtn: document.getElementById('add-card-btn'),
            kantorCard: document.getElementById('kantor-card'),
            pegawaiCardsContainer: document.getElementById('pegawai-cards-container'),
            saveKantorBtn: document.getElementById('save-kantor'),
            resetKantorBtn: document.getElementById('reset-kantor'),
            kantorPhotoUpload: document.getElementById('kantor-photo-upload'),
            kantorUploadBtn: document.getElementById('kantor-upload-btn'),
            kantorCropBtn: document.getElementById('kantor-crop-btn'),
            kantorPhotoPreview: document.getElementById('kantor-photo-preview'),
            kantorPhotoLoading: document.getElementById('kantor-photo-loading'),
            cropModal: document.getElementById('crop-modal'),
            cropImage: document.getElementById('crop-image'),
            cancelCropBtn: document.getElementById('cancel-crop'),
            applyCropBtn: document.getElementById('apply-crop'),
            loadingOverlay: document.getElementById('loading'),
            loadingText: document.getElementById('loading-text'),
            cardCount: document.getElementById('card-count'),
            autoSaveIndicator: document.getElementById('auto-save-indicator')
        };

        // Inisialisasi aplikasi
        function init() {
            setupEventListeners();
            checkAuth();
        }

        // Setup event listeners
        function setupEventListeners() {
            // Login
            elements.loginBtn.addEventListener('click', handleLogin);
            elements.passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });

            // Kantor
            elements.saveKantorBtn.addEventListener('click', saveKantorData);
            elements.resetKantorBtn.addEventListener('click', resetKantorData);
            
            // Photo upload
            elements.kantorPhotoUpload.addEventListener('change', (e) => handlePhotoUpload(e, 'kantor'));
            elements.kantorCropBtn.addEventListener('click', () => openCropModal('kantor'));

            // Pegawai
            elements.addCardBtn.addEventListener('click', addPegawaiCard);

            // Modal
            document.querySelector('.close-modal').addEventListener('click', closeCropModal);
            elements.cancelCropBtn.addEventListener('click', closeCropModal);
            elements.applyCropBtn.addEventListener('click', applyCrop);
            
            // Collapse cards
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-collapse') || e.target.closest('.btn-collapse')) {
                    const btn = e.target.closest('.btn-collapse');
                    const targetId = btn.getAttribute('data-target');
                    const targetCard = document.getElementById(targetId);
                    if (targetCard) {
                        const isHidden = targetCard.style.display === 'none';
                        targetCard.style.display = isHidden ? 'block' : 'none';
                        const icon = btn.querySelector('i');
                        icon.classList.toggle('fa-chevron-down');
                        icon.classList.toggle('fa-chevron-up');
                    }
                }
            });
        }

        // Check authentication status
        function checkAuth() {
            const token = localStorage.getItem('auth_token');
            if (token) {
                // Verifikasi token dengan server
                verifyToken(token);
            }
        }

        // Verify token dengan server
        async function verifyToken(token) {
            try {
                showLoading('Memverifikasi sesi...');
                const response = await fetch(`${appState.APP_SCRIPT_URL}?action=verifyToken&token=${token}`);
                const data = await response.json();
                
                if (data.success) {
                    appState.isLoggedIn = true;
                    appState.currentUser = data.user;
                    
                    elements.loginCard.style.display = 'none';
                    elements.mainContent.style.display = 'block';
                    
                    loadAllData();
                } else {
                    localStorage.removeItem('auth_token');
                }
            } catch (error) {
                console.error('Token verification error:', error);
            } finally {
                showLoading(false);
            }
        }

        // Login handler
        async function handleLogin() {
            const username = elements.usernameInput.value.trim();
            const password = elements.passwordInput.value;

            if (!username || !password) {
                showMessage('Username dan password harus diisi!', 'error');
                return;
            }

            try {
                showLoading('Memproses login...');
                const result = await authAPI.login(username, password);
                
                if (result.success) {
                    appState.isLoggedIn = true;
                    appState.currentUser = username;
                    
                    // Simpan token
                    if (result.token) {
                        localStorage.setItem('auth_token', result.token);
                    }
                    
                    elements.loginCard.style.display = 'none';
                    elements.mainContent.style.display = 'block';
                    
                    showMessage('Login berhasil!', 'success');
                    loadAllData();
                } else {
                    showMessage(result.message || 'Login gagal!', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showMessage('Terjadi kesalahan saat login!', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Load semua data
        async function loadAllData() {
            showLoading('Memuat data...');
            try {
                await loadKantorData();
                await loadPegawaiData();
                updateCardCount();
            } catch (error) {
                console.error('Error loading data:', error);
                showMessage('Gagal memuat data!', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Load data kantor
        async function loadKantorData() {
            try {
                const data = await dataAPI.getKantorData();
                if (data.success && data.data) {
                    appState.kantorData = data.data;
                    populateKantorForm(data.data);
                    
                    // Load foto kantor
                    if (data.data.foto_url) {
                        loadPhotoPreview('kantor', data.data.foto_url);
                    }
                }
            } catch (error) {
                console.error('Error loading kantor data:', error);
            }
        }

        // Isi form kantor dengan data
        function populateKantorForm(data) {
            document.getElementById('nama_kelurahan').value = data.nama_kelurahan || '';
            document.getElementById('alamat').value = data.alamat || '';
            document.getElementById('rt').value = data.rt || '';
            document.getElementById('rw').value = data.rw || '';
            document.getElementById('kelurahan').value = data.kelurahan || '';
            document.getElementById('kecamatan').value = data.kecamatan || '';
            document.getElementById('kota').value = data.kota || 'Pekanbaru';
            document.getElementById('provinsi').value = data.provinsi || 'Riau';
            document.getElementById('kode_pos').value = data.kode_pos || '';
        }

        // Reset data kantor
        function resetKantorData() {
            if (confirm('Reset data kantor? Data yang belum disimpan akan hilang.')) {
                populateKantorForm({
                    kota: 'Pekanbaru',
                    provinsi: 'Riau'
                });
                resetPhotoPreview('kantor');
                showMessage('Form kantor telah direset!', 'success');
            }
        }

        // Simpan data kantor
        async function saveKantorData() {
            const kantorData = {
                nama_kelurahan: document.getElementById('nama_kelurahan').value.trim(),
                alamat: document.getElementById('alamat').value.trim(),
                rt: document.getElementById('rt').value.trim(),
                rw: document.getElementById('rw').value.trim(),
                kelurahan: document.getElementById('kelurahan').value.trim(),
                kecamatan: document.getElementById('kecamatan').value.trim(),
                kota: document.getElementById('kota').value.trim(),
                provinsi: document.getElementById('provinsi').value.trim(),
                kode_pos: document.getElementById('kode_pos').value.trim()
            };

            // Validasi
            const requiredFields = ['nama_kelurahan', 'alamat', 'rt', 'rw', 'kelurahan', 'kecamatan', 'kode_pos'];
            for (const field of requiredFields) {
                if (!kantorData[field]) {
                    showMessage(`Field ${field.replace('_', ' ')} harus diisi!`, 'error');
                    document.getElementById(field).focus();
                    return;
                }
            }

            showLoading('Menyimpan data kantor...');

            try {
                // Upload foto jika ada
                let fotoUrl = null;
                const photoFile = elements.kantorPhotoUpload.files[0];
                if (photoFile) {
                    fotoUrl = await uploadPhoto(photoFile, 'kantor');
                }

                kantorData.foto_url = fotoUrl;

                const result = await dataAPI.saveKantorData(kantorData);
                
                if (result.success) {
                    appState.kantorData = kantorData;
                    showMessage('Data kantor berhasil disimpan!', 'success');
                    showAutoSaveIndicator();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error saving kantor data:', error);
                showMessage('Gagal menyimpan data kantor: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Handle photo upload
        function handlePhotoUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            // Validasi file
            if (!file.type.match('image.*')) {
                showMessage('Hanya file gambar yang diizinkan!', 'error');
                return;
            }

            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                showMessage('Ukuran file maksimal 5MB!', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.onload = function() {
                    const preview = document.getElementById(`${type}-photo-preview`);
                    preview.innerHTML = '';
                    preview.appendChild(img);
                    
                    const cropBtn = document.getElementById(`${type}-crop-btn`);
                    if (cropBtn) {
                        cropBtn.style.display = 'inline-flex';
                    }
                    
                    appState.currentPhotoType = type;
                    appState.currentPhoto = img;
                };
            };
            reader.readAsDataURL(file);
        }

        // Load photo preview
        function loadPhotoPreview(type, url) {
            if (!url) return;
            
            const preview = document.getElementById(`${type}-photo-preview`);
            const img = document.createElement('img');
            img.src = url;
            img.onload = function() {
                preview.innerHTML = '';
                preview.appendChild(img);
            };
            img.onerror = function() {
                console.error('Failed to load photo:', url);
                preview.innerHTML = '<i class="fas fa-image preview-icon"></i><span>Foto tidak tersedia</span>';
            };
        }

        // Reset photo preview
        function resetPhotoPreview(type) {
            const preview = document.getElementById(`${type}-photo-preview`);
            preview.innerHTML = '<i class="fas fa-image preview-icon"></i><span>Preview Foto</span>';
            const uploadInput = document.getElementById(`${type}-photo-upload`);
            uploadInput.value = '';
            const cropBtn = document.getElementById(`${type}-crop-btn`);
            if (cropBtn) {
                cropBtn.style.display = 'none';
            }
        }

        // Open crop modal
        function openCropModal(type) {
            appState.currentPhotoType = type;
            
            if (appState.currentPhoto) {
                elements.cropImage.src = appState.currentPhoto.src;
                
                // Initialize cropper
                if (appState.cropper) {
                    appState.cropper.destroy();
                }
                
                appState.cropper = new Cropper(elements.cropImage, {
                    aspectRatio: 4/5,
                    viewMode: 1,
                    autoCropArea: 1,
                    responsive: true,
                    restore: false,
                    guides: true,
                    center: true,
                    highlight: true,
                    cropBoxMovable: true,
                    cropBoxResizable: true
                });
                
                elements.cropModal.style.display = 'flex';
            }
        }

        // Close crop modal
        function closeCropModal() {
            elements.cropModal.style.display = 'none';
            if (appState.cropper) {
                appState.cropper.destroy();
                appState.cropper = null;
            }
        }

        // Apply crop
        function applyCrop() {
            if (appState.cropper) {
                const canvas = appState.cropper.getCroppedCanvas({
                    width: 1080,
                    height: 1350,
                    imageSmoothingEnabled: true,
                    imageSmoothingQuality: 'high'
                });
                
                const croppedImageUrl = canvas.toDataURL('image/jpeg', 0.9);
                
                // Update preview
                const preview = document.getElementById(`${appState.currentPhotoType}-photo-preview`);
                preview.innerHTML = '';
                const img = document.createElement('img');
                img.src = croppedImageUrl;
                preview.appendChild(img);
                
                // Store cropped image
                appState.currentPhoto = img;
                
                // Convert data URL to blob for upload
                canvas.toBlob(async (blob) => {
                    const file = new File([blob], `cropped_${Date.now()}.jpg`, { type: 'image/jpeg' });
                    
                    // Store for later upload
                    if (appState.currentPhotoType === 'kantor') {
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(file);
                        elements.kantorPhotoUpload.files = dataTransfer.files;
                    } else {
                        const input = document.getElementById(`photo-upload-${appState.currentPhotoIndex}`);
                        if (input) {
                            const dataTransfer = new DataTransfer();
                            dataTransfer.items.add(file);
                            input.files = dataTransfer.files;
                        }
                    }
                }, 'image/jpeg', 0.9);
                
                closeCropModal();
                showMessage('Foto berhasil di-crop!', 'success');
            }
        }

        // Upload photo to server
        async function uploadPhoto(file, type, index = null) {
            if (!file) return null;
            
            try {
                const loadingElement = document.getElementById(`${type}-photo-loading`);
                if (loadingElement) {
                    loadingElement.style.display = 'flex';
                }
                
                const result = await fileAPI.uploadPhoto(file, type, index);
                
                if (result.success) {
                    return result.url;
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Upload error:', error);
                showMessage('Gagal mengupload foto: ' + error.message, 'error');
                return null;
            } finally {
                const loadingElement = document.getElementById(`${type}-photo-loading`);
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }
            }
        }

        // Add pegawai card
        function addPegawaiCard() {
            if (appState.activeCards.size >= 10) {
                showMessage('Maksimal 10 card pegawai!', 'warning');
                return;
            }

            const cardId = appState.nextCardId++;
            const cardHTML = createPegawaiCardHTML(cardId);
            
            elements.pegawaiCardsContainer.insertAdjacentHTML('beforeend', cardHTML);
            appState.activeCards.add(cardId);
            updateCardCount();
            
            // Setup event listeners for new card
            setupPegawaiCardEvents(cardId);
            
            showMessage(`Card pegawai ${cardId} berhasil ditambahkan!`, 'success');
        }

        // Create pegawai card HTML
        function createPegawaiCardHTML(id) {
            return `
                <div id="pegawai-card-${id}" class="card pegawai-card" data-card-id="${id}">
                    <div class="pegawai-card-header">
                        <h3><i class="fas fa-user"></i> DATA PROFILE PEGAWAI ${id}</h3>
                        <div class="card-actions">
                            <button class="btn btn-secondary btn-collapse" data-target="pegawai-content-${id}">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <button class="btn btn-danger delete-card-btn" data-card-id="${id}">
                                <i class="fas fa-trash"></i> Hapus
                            </button>
                        </div>
                    </div>
                    <div id="pegawai-content-${id}" class="card-content">
                        <div class="form-section">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="nama-${id}" class="required"><i class="fas fa-user"></i> NAMA</label>
                                    <input type="text" id="nama-${id}" class="pegawai-input" required>
                                </div>
                                <div class="form-group">
                                    <label for="nip-${id}" class="required"><i class="fas fa-id-card"></i> NIP</label>
                                    <input type="text" id="nip-${id}" class="pegawai-input" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="jabatan-${id}" class="required"><i class="fas fa-briefcase"></i> JABATAN</label>
                                    <input type="text" id="jabatan-${id}" class="pegawai-input" required>
                                </div>
                                <div class="form-group">
                                    <label for="pangkat-${id}" class="required"><i class="fas fa-star"></i> PANGKAT/GOL</label>
                                    <input type="text" id="pangkat-${id}" class="pegawai-input" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="email-${id}"><i class="fas fa-envelope"></i> EMAIL</label>
                                    <input type="email" id="email-${id}" class="pegawai-input">
                                </div>
                                <div class="form-group">
                                    <label for="nohp-${id}"><i class="fas fa-phone"></i> NO HP</label>
                                    <input type="tel" id="nohp-${id}" class="pegawai-input">
                                </div>
                            </div>
                        </div>
                        <div class="photo-section">
                            <div class="photo-upload">
                                <h4><i class="fas fa-camera"></i> Upload Foto Pegawai</h4>
                                <p class="photo-note">
                                    <i class="fas fa-ruler-combined"></i> Ukuran: 4:5 (1080x1350px)
                                </p>
                                <div class="photo-preview-container">
                                    <div id="photo-preview-${id}" class="photo-preview">
                                        <i class="fas fa-user preview-icon"></i>
                                        <span>Preview Foto</span>
                                    </div>
                                </div>
                                <div class="photo-actions">
                                    <div class="file-input-wrapper">
                                        <button class="btn btn-secondary upload-pegawai-btn" data-card-id="${id}">
                                            <i class="fas fa-upload"></i> Pilih Foto
                                        </button>
                                        <input type="file" id="photo-upload-${id}" class="photo-upload-input" accept="image/*" data-card-id="${id}">
                                    </div>
                                    <button class="btn btn-secondary crop-pegawai-btn" data-card-id="${id}" style="display: none;">
                                        <i class="fas fa-crop-alt"></i> Crop Foto
                                    </button>
                                </div>
                                <div id="photo-loading-${id}" class="photo-loading" style="display: none;">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <button class="btn btn-success save-pegawai-btn" data-card-id="${id}">
                            <i class="fas fa-save"></i> Simpan Data
                        </button>
                        <button class="btn btn-secondary reset-pegawai-btn" data-card-id="${id}">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                    </div>
                </div>
            `;
        }

        // Setup events for pegawai card
        function setupPegawaiCardEvents(id) {
            const card = document.getElementById(`pegawai-card-${id}`);
            
            // Delete button
            const deleteBtn = card.querySelector('.delete-card-btn');
            deleteBtn.addEventListener('click', () => deletePegawaiCard(id));
            
            // Save button
            const saveBtn = card.querySelector('.save-pegawai-btn');
            saveBtn.addEventListener('click', () => savePegawaiData(id));
            
            // Reset button
            const resetBtn = card.querySelector('.reset-pegawai-btn');
            resetBtn.addEventListener('click', () => resetPegawaiCard(id));
            
            // Photo upload
            const uploadBtn = card.querySelector('.upload-pegawai-btn');
            const fileInput = card.querySelector('.photo-upload-input');
            const cropBtn = card.querySelector('.crop-pegawai-btn');
            
            uploadBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => {
                appState.currentPhotoIndex = id;
                handlePhotoUpload(e, `pegawai-${id}`);
            });
            
            cropBtn.addEventListener('click', () => {
                appState.currentPhotoIndex = id;
                openCropModal(`pegawai-${id}`);
            });
        }

        // Load data pegawai
        async function loadPegawaiData() {
            try {
                const data = await dataAPI.getPegawaiData();
                if (data.success && data.data) {
                    data.data.forEach(pegawai => {
                        if (!appState.activeCards.has(pegawai.card_id)) {
                            addPegawaiCard();
                        }
                        populatePegawaiCard(pegawai.card_id, pegawai);
                        
                        // Load foto pegawai
                        if (pegawai.foto_url) {
                            loadPhotoPreview(`pegawai-${pegawai.card_id}`, pegawai.foto_url);
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading pegawai data:', error);
            }
        }

        // Isi card pegawai dengan data
        function populatePegawaiCard(id, data) {
            document.getElementById(`nama-${id}`).value = data.nama || '';
            document.getElementById(`nip-${id}`).value = data.nip || '';
            document.getElementById(`jabatan-${id}`).value = data.jabatan || '';
            document.getElementById(`pangkat-${id}`).value = data.pangkat || '';
            document.getElementById(`email-${id}`).value = data.email || '';
            document.getElementById(`nohp-${id}`).value = data.no_hp || '';
            
            appState.pegawaiData[id] = data;
        }

        // Reset card pegawai
        function resetPegawaiCard(id) {
            if (confirm(`Reset data pegawai ${id}? Data yang belum disimpan akan hilang.`)) {
                document.getElementById(`nama-${id}`).value = '';
                document.getElementById(`nip-${id}`).value = '';
                document.getElementById(`jabatan-${id}`).value = '';
                document.getElementById(`pangkat-${id}`).value = '';
                document.getElementById(`email-${id}`).value = '';
                document.getElementById(`nohp-${id}`).value = '';
                resetPhotoPreview(`pegawai-${id}`);
                showMessage(`Data pegawai ${id} telah direset!`, 'success');
            }
        }

        // Simpan data pegawai
        async function savePegawaiData(id) {
            const pegawaiData = {
                card_id: id,
                nama: document.getElementById(`nama-${id}`).value.trim(),
                nip: document.getElementById(`nip-${id}`).value.trim(),
                jabatan: document.getElementById(`jabatan-${id}`).value.trim(),
                pangkat: document.getElementById(`pangkat-${id}`).value.trim(),
                email: document.getElementById(`email-${id}`).value.trim(),
                no_hp: document.getElementById(`nohp-${id}`).value.trim()
            };

            // Validasi
            const requiredFields = ['nama', 'nip', 'jabatan', 'pangkat'];
            for (const field of requiredFields) {
                if (!pegawaiData[field]) {
                    showMessage(`Field ${field} pada card ${id} harus diisi!`, 'error');
                    document.getElementById(`${field}-${id}`).focus();
                    return;
                }
            }

            showLoading(`Menyimpan data pegawai ${id}...`);

            try {
                // Upload foto jika ada
                let fotoUrl = null;
                const fileInput = document.getElementById(`photo-upload-${id}`);
                if (fileInput && fileInput.files[0]) {
                    fotoUrl = await uploadPhoto(fileInput.files[0], 'pegawai', id);
                }

                pegawaiData.foto_url = fotoUrl;

                const result = await dataAPI.savePegawaiData(pegawaiData);
                
                if (result.success) {
                    appState.pegawaiData[id] = pegawaiData;
                    showMessage(`Data pegawai ${id} berhasil disimpan!`, 'success');
                    showAutoSaveIndicator();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error(`Error saving pegawai data ${id}:`, error);
                showMessage(`Gagal menyimpan data pegawai ${id}: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Delete pegawai card
        async function deletePegawaiCard(id) {
            if (!confirm(`Hapus card pegawai ${id}? Data juga akan dihapus dari sistem.`)) {
                return;
            }

            showLoading(`Menghapus data pegawai ${id}...`);

            try {
                const result = await dataAPI.deletePegawaiData(id);
                
                if (result.success) {
                    const card = document.getElementById(`pegawai-card-${id}`);
                    if (card) {
                        card.remove();
                    }
                    
                    appState.activeCards.delete(id);
                    delete appState.pegawaiData[id];
                    updateCardCount();
                    
                    showMessage(`Card pegawai ${id} berhasil dihapus!`, 'success');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error(`Error deleting pegawai data ${id}:`, error);
                showMessage(`Gagal menghapus data pegawai ${id}: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Update card count display
        function updateCardCount() {
            const count = appState.activeCards.size;
            elements.cardCount.textContent = `${count}/10`;
            elements.addCardBtn.disabled = count >= 10;
        }

        // Show loading overlay
        function showLoading(message = 'Memproses...') {
            if (message) {
                elements.loadingText.textContent = message;
                elements.loadingOverlay.style.display = 'flex';
            } else {
                elements.loadingOverlay.style.display = 'none';
            }
        }

        // Show message
        function showMessage(message, type = 'info') {
            // Remove existing messages
            const existingMessages = document.querySelectorAll('.status-message');
            existingMessages.forEach(msg => msg.remove());
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `status-message status-${type}`;
            messageDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(messageDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }

        // Show auto-save indicator
        function showAutoSaveIndicator() {
            elements.autoSaveIndicator.style.display = 'block';
            setTimeout(() => {
                elements.autoSaveIndicator.style.display = 'none';
            }, 3000);
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
