<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Profile Pegawai - GitHub Pages Fix</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* [PASTE SEMUA STYLE DARI SEBELUMNYA - TIDAK BERUBAH] */
        /* ... semua CSS tetap sama ... */
    </style>
</head>
<body>
    <!-- [SEMUA HTML STRUCTURE TETAP SAMA] -->
    <!-- ... login section, cards, dll ... -->

    <script>
        // ============ KONFIGURASI FIXED ============
        const CONFIG = {
            SHEET_ID: '1XCTZBBxu4HGDZ1e7JW8DJGdoYT8tMkooxfNrZMJoruY',
            API_KEY: 'AIzaSyBR1XK5osDoe2Mvsk1TCUt0ebrMqQu1Gv4',
            SHEETS: {
                PASSWORD: 'PASSWORD',
                PROFILE: 'PROFILE',
                PEGAWAI: 'DATA_PEGAWAI'
            },
            MAX_CARDS: 10
        };
        
        // ============ FIXED FUNCTIONS ============
        
        async function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!username || !password) {
                showNotification('Harap isi username dan password', 'error');
                return;
            }

            showLoading('Memeriksa login...');

            try {
                // FIX: Gunakan range yang lebih spesifik
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${CONFIG.SHEETS.PASSWORD}!A2:B?key=${CONFIG.API_KEY}`;
                console.log('Login URL:', url);
                
                const response = await fetch(url);
                console.log('Login response status:', response.status);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Login API error:', errorData);
                    
                    // Coba create sheet jika belum ada
                    if (response.status === 404) {
                        await createDefaultSheets();
                        showNotification('Sheet dibuat, coba login lagi', 'success');
                        hideLoading();
                        return;
                    }
                    
                    throw new Error(errorData.error?.message || 'Gagal mengakses sheet');
                }
                
                const data = await response.json();
                console.log('Login data:', data);
                const rows = data.values || [];
                
                // Check credentials
                let found = false;
                for (const row of rows) {
                    if (row[0] === username && row[1] === password) {
                        found = true;
                        break;
                    }
                }
                
                if (found) {
                    currentUser = username;
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    showNotification('Login berhasil!', 'success');
                    
                    // Load existing data
                    await loadKantorData();
                    await loadPegawaiData();
                } else {
                    showNotification('Username atau password salah', 'error');
                }
                
            } catch (error) {
                console.error('Login error:', error);
                showNotification('Error: ' + error.message, 'error');
            }
            
            hideLoading();
        }
        
        async function createDefaultSheets() {
            try {
                // Create PASSWORD sheet headers and default user
                const passUrl = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/PASSWORD!A1:B2?valueInputOption=USER_ENTERED&key=${CONFIG.API_KEY}`;
                
                await fetch(passUrl, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        values: [
                            ['USER', 'PASSWORD'],
                            ['Admin', '123456']
                        ]
                    })
                });
                
                // Create PROFILE headers
                const profileUrl = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/PROFILE!A1:K1?valueInputOption=USER_ENTERED&key=${CONFIG.API_KEY}`;
                
                await fetch(profileUrl, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        values: [[
                            'TIMESTAMP', 'NAMA_KELURAHAN', 'ALAMAT', 'RT', 'RW', 
                            'KELURAHAN', 'KECAMATAN', 'KOTA', 'PROVINSI', 'KODE_POS', 'FOTO_URL'
                        ]]
                    })
                });
                
                // Create DATA_PEGAWAI headers
                const pegawaiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/DATA_PEGAWAI!A1:J1?valueInputOption=USER_ENTERED&key=${CONFIG.API_KEY}`;
                
                await fetch(pegawaiUrl, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        values: [[
                            'TIMESTAMP', 'CARD_ID', 'NAMA', 'NIP', 'JABATAN',
                            'PANGKAT', 'EMAIL', 'NO_HP', 'FOTO_URL', 'STATUS'
                        ]]
                    })
                });
                
                console.log('Default sheets created successfully');
                return true;
                
            } catch (error) {
                console.error('Error creating sheets:', error);
                return false;
            }
        }
        
        async function saveKantorData() {
            showLoading('Menyimpan data kantor...');
            
            const data = {
                timestamp: new Date().toISOString(),
                nama_kelurahan: document.getElementById('nama_kelurahan').value,
                alamat: document.getElementById('alamat').value,
                rt: document.getElementById('rt').value,
                rw: document.getElementById('rw').value,
                kelurahan: document.getElementById('kelurahan').value,
                kecamatan: document.getElementById('kecamatan').value,
                kota: document.getElementById('kota').value || 'Pekanbaru',
                provinsi: document.getElementById('provinsi').value || 'Riau',
                kode_pos: document.getElementById('kode_pos').value,
                foto_url: ''
            };
            
            console.log('Saving kantor data:', data);

            try {
                // FIX: Selalu append data baru (tidak perlu check existing)
                const range = `${CONFIG.SHEETS.PROFILE}!A:K`;
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${range}:append?valueInputOption=USER_ENTERED&insertDataOption=INSERT_ROWS&key=${CONFIG.API_KEY}`;
                
                console.log('Save URL:', url);
                
                const values = [[
                    data.timestamp,
                    data.nama_kelurahan,
                    data.alamat,
                    data.rt,
                    data.rw,
                    data.kelurahan,
                    data.kecamatan,
                    data.kota,
                    data.provinsi,
                    data.kode_pos,
                    data.foto_url
                ]];
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({values})
                });
                
                console.log('Save response status:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Save success:', result);
                    showNotification('Data kantor berhasil disimpan!', 'success');
                } else {
                    const errorData = await response.json();
                    console.error('Save error response:', errorData);
                    throw new Error(errorData.error?.message || 'Gagal menyimpan data');
                }
            } catch (error) {
                console.error('Error saving kantor data:', error);
                showNotification('Error: ' + error.message, 'error');
            }
            
            hideLoading();
        }
        
        // ============ DEBUG FUNCTIONS ============
        
        function enableDebugMode() {
            // Log semua API calls
            const originalFetch = window.fetch;
            window.fetch = function(...args) {
                console.log('Fetch called:', args[0], args[1] || '');
                return originalFetch.apply(this, args)
                    .then(response => {
                        console.log('Fetch response:', response.status, response.url);
                        return response;
                    });
            };
            
            // Show debug panel
            const debugPanel = document.createElement('div');
            debugPanel.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 10px;
                border-radius: 5px;
                z-index: 9999;
                font-family: monospace;
                font-size: 12px;
                max-width: 300px;
            `;
            debugPanel.innerHTML = `
                <strong>DEBUG MODE</strong><br>
                API Key: ${CONFIG.API_KEY.substring(0, 10)}...<br>
                Sheet ID: ${CONFIG.SHEET_ID.substring(0, 10)}...<br>
                <button onclick="testConnection()" style="margin-top:5px;padding:5px;">Test Connection</button>
                <div id="debugOutput" style="margin-top:5px;"></div>
            `;
            document.body.appendChild(debugPanel);
            
            window.testConnection = async function() {
                const output = document.getElementById('debugOutput');
                output.innerHTML = 'Testing...';
                
                try {
                    const testUrl = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}?key=${CONFIG.API_KEY}`;
                    const res = await fetch(testUrl);
                    const data = await res.json();
                    
                    if (res.ok) {
                        output.innerHTML = `<span style="color:green">✓ Connected<br>Sheet: ${data.properties.title}</span>`;
                    } else {
                        output.innerHTML = `<span style="color:red">✗ ${data.error.message}</span>`;
                    }
                } catch (err) {
                    output.innerHTML = `<span style="color:red">✗ ${err.message}</span>`;
                }
            };
            
            console.log('Debug mode enabled');
        }
        
        // Enable debug on load
        document.addEventListener('DOMContentLoaded', function() {
            enableDebugMode();
            console.log('Current origin:', window.location.origin);
            console.log('Full URL:', window.location.href);
        });
        
        // [FUNGSI LAINNYA TETAP SAMA...]
        // ... semua fungsi lainnya tetap seperti sebelumnya ...
        
    </script>
</body>
</html>
