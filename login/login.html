<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Premium - Senapelan</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        /* Animated background elements */
        .circle {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            animation: float 6s ease-in-out infinite;
        }

        .circle1 {
            width: 200px;
            height: 200px;
            top: -50px;
            right: -50px;
        }

        .circle2 {
            width: 300px;
            height: 300px;
            bottom: -100px;
            left: -100px;
            animation-delay: -3s;
        }

        .circle3 {
            width: 150px;
            height: 150px;
            bottom: 50px;
            right: 50px;
            animation-delay: -1.5s;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0) rotate(0deg);
            }
            50% {
                transform: translateY(-30px) rotate(180deg);
            }
        }

        .login-container {
            width: 100%;
            max-width: 450px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            position: relative;
            z-index: 1;
            animation: slideUp 0.8s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px 30px;
            text-align: center;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .login-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        .login-header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
            position: relative;
            z-index: 1;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .login-header p {
            font-size: 1.1em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .login-form {
            padding: 40px 30px;
        }

        .input-group {
            margin-bottom: 25px;
            position: relative;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 0.95em;
            transition: all 0.3s ease;
        }

        .input-group input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e1e1e1;
            border-radius: 15px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: white;
            color: #333;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .input-group input::placeholder {
            color: #999;
            font-weight: 300;
        }

        .input-group i {
            position: absolute;
            right: 15px;
            top: 47px;
            color: #999;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .input-group i:hover {
            color: #667eea;
        }

        .toggle-password {
            font-size: 1.2em;
        }

        .forgot-password {
            text-align: right;
            margin-bottom: 25px;
        }

        .forgot-password a {
            color: #667eea;
            text-decoration: none;
            font-size: 0.9em;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .forgot-password a:hover {
            color: #764ba2;
            text-decoration: underline;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 15px;
            color: white;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .login-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .login-btn:active::after {
            width: 300px;
            height: 300px;
        }

        .login-footer {
            text-align: center;
            padding: 20px 30px;
            background: #f8f9fa;
            border-top: 1px solid #e1e1e1;
        }

        .login-footer p {
            color: #666;
            font-size: 0.95em;
        }

        .login-footer a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .login-footer a:hover {
            color: #764ba2;
            text-decoration: underline;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            animation: slideIn 0.5s ease-out;
            font-weight: 500;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .alert-error {
            background: #fee;
            color: #c33;
            border-left: 4px solid #c33;
        }

        .alert-success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #2e7d32;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .btn-text {
            display: inline-block;
        }

        .btn-loading {
            display: none;
        }

        .login-btn.loading .btn-text {
            display: none;
        }

        .login-btn.loading .btn-loading {
            display: inline-block;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .login-container {
                max-width: 100%;
                border-radius: 20px;
            }

            .login-header {
                padding: 30px 20px;
            }

            .login-header h1 {
                font-size: 2em;
            }

            .login-form {
                padding: 30px 20px;
            }

            .input-group input {
                padding: 12px 15px;
            }
        }

        /* Role indicator */
        .role-info {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            background: #e8f5e9;
            border-radius: 10px;
            color: #2e7d32;
            font-size: 0.9em;
            display: none;
        }

        .role-info.show {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <!-- Animated background elements -->
    <div class="circle circle1"></div>
    <div class="circle circle2"></div>
    <div class="circle circle3"></div>

    <div class="login-container">
        <div class="login-header">
            <h1>Selamat Datang</h1>
            <p>Silakan login untuk melanjutkan</p>
        </div>

        <div class="login-form">
            <div id="alert" class="alert"></div>
            
            <div class="input-group">
                <label for="username">Username</label>
                <input type="text" id="username" placeholder="Masukkan username" autocomplete="off">
                <i class="fas fa-user"></i>
            </div>

            <div class="input-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Masukkan password">
                <i class="fas fa-eye toggle-password" onclick="togglePassword()"></i>
            </div>

            <div class="forgot-password">
                <a href="#">Lupa Password?</a>
            </div>

            <button class="login-btn" onclick="handleLogin()" id="loginBtn">
                <span class="btn-text">Login</span>
                <span class="btn-loading"><span class="loading"></span> Memproses...</span>
            </button>

            <div id="roleInfo" class="role-info"></div>
        </div>

        <div class="login-footer">
            <p>&copy; 2024 Senapelan. All rights reserved.</p>
        </div>
    </div>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <script>
    // Konfigurasi
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyPkTztHid5sYXVVWrvJixiupp1Xx86Blm-5lvf2FLElCERADDjMg9BB0RPFuu8MUOMtA/exec';
    const LOGIN_PAGE_URL = 'https://senapelan.github.io/Home/login/login.html';
    
    // State
    let currentUser = null;
    let isEditingKelurahan = false;
    let editingPegawaiId = null;
    let currentFotoType = null;
    let currentFotoTarget = null;
    let cropper = null;
    let pegawaiCount = 0;
    
    // Cache data untuk mencegah kehilangan saat refresh
    let localDataCache = {
        kelurahan: {},
        pegawai: []
    };

    // Auto-save draft setiap 5 detik
    let autoSaveInterval;

    // Cegah semua form submission dan refresh
    document.addEventListener('DOMContentLoaded', function() {
        // Cegah semua form submission
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                return false;
            });
        });

        // Cegah refresh dengan F5 dan Ctrl+R
        window.addEventListener('keydown', function(e) {
            if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
                e.preventDefault();
                showToast('Gunakan tombol Simpan untuk menyimpan data', 'warning');
                return false;
            }
        });

        // Cegah refresh dengan tombol back browser
        window.addEventListener('popstate', function(e) {
            e.preventDefault();
            showToast('Data akan hilang jika keluar. Simpan dulu!', 'warning');
            history.pushState(null, null, location.href);
        });

        // Push state untuk cegah back
        history.pushState(null, null, location.href);

        // Load draft dari localStorage jika ada
        loadDraft();

        // Start auto-save
        startAutoSave();
    });

    // Check login status
    (function checkLogin() {
        try {
            const isLoggedIn = sessionStorage.getItem('isLoggedIn');
            const username = sessionStorage.getItem('username');
            
            if (!isLoggedIn || isLoggedIn !== 'true' || !username) {
                console.log('Tidak ada session, redirect ke login');
                window.location.href = LOGIN_PAGE_URL;
                return;
            }
            
            currentUser = username;
            document.getElementById('usernameDisplay').textContent = username;
            loadUserData();
        } catch (error) {
            console.error('Error checking login:', error);
            window.location.href = LOGIN_PAGE_URL;
        }
    })();

    // Auto-save draft ke localStorage
    function startAutoSave() {
        if (autoSaveInterval) clearInterval(autoSaveInterval);
        
        autoSaveInterval = setInterval(() => {
            if (isEditingKelurahan || document.querySelector('.pegawai-card input:not(:disabled)')) {
                saveDraft();
                showToast('Draft tersimpan', 'info', 1000);
            }
        }, 5000);
    }

    function saveDraft() {
        const draft = {
            kelurahan: {},
            pegawai: [],
            timestamp: new Date().getTime()
        };

        // Simpan data kelurahan yang sedang diedit
        if (isEditingKelurahan) {
            draft.kelurahan = {
                nama_kelurahan: document.getElementById('nama_kelurahan').value,
                alamat_kelurahan: document.getElementById('alamat_kelurahan').value,
                rt: document.getElementById('rt').value,
                rw: document.getElementById('rw').value,
                kelurahan: document.getElementById('kelurahan').value,
                kecamatan: document.getElementById('kecamatan').value,
                kota: document.getElementById('kota').value,
                provinsi: document.getElementById('provinsi').value,
                kode_pos: document.getElementById('kode_pos').value,
                telp_kantor: document.getElementById('telp_kantor').value
            };
        }

        // Simpan data pegawai yang sedang diedit
        document.querySelectorAll('.pegawai-card').forEach(card => {
            const inputs = card.querySelectorAll('input');
            if (inputs.length > 0 && !inputs[0].disabled) {
                const pegawaiData = {
                    id: card.id,
                    nama: card.querySelector('.pegawai-nama')?.value || '',
                    jabatan: card.querySelector('.pegawai-jabatan')?.value || '',
                    nip: card.querySelector('.pegawai-nip')?.value || '',
                    pangkat_gol: card.querySelector('.pegawai-pangkat')?.value || '',
                    no_hp: card.querySelector('.pegawai-nohp')?.value || ''
                };
                draft.pegawai.push(pegawaiData);
            }
        });

        localStorage.setItem(`draft_${currentUser}`, JSON.stringify(draft));
    }

    function loadDraft() {
        if (!currentUser) return;
        
        const savedDraft = localStorage.getItem(`draft_${currentUser}`);
        if (savedDraft) {
            try {
                const draft = JSON.parse(savedDraft);
                const now = new Date().getTime();
                
                // Hanya load draft jika kurang dari 30 menit
                if (now - draft.timestamp < 30 * 60 * 1000) {
                    if (Object.keys(draft.kelurahan).length > 0) {
                        showToast('Draft ditemukan. Apakah ingin melanjutkan?', 'warning', 5000);
                        if (confirm('Ada draft yang belum disimpan. Lanjutkan mengedit?')) {
                            Object.keys(draft.kelurahan).forEach(key => {
                                const el = document.getElementById(key);
                                if (el) el.value = draft.kelurahan[key];
                            });
                        }
                    }
                } else {
                    // Hapus draft yang sudah kadaluarsa
                    localStorage.removeItem(`draft_${currentUser}`);
                }
            } catch (e) {
                console.error('Error loading draft:', e);
            }
        }
    }

    // Load user data from spreadsheet
    async function loadUserData() {
        showLoading();
        
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // Timeout 10 detik
            
            const response = await fetch(`${APPS_SCRIPT_URL}?action=getData&username=${currentUser}`, {
                signal: controller.signal,
                cache: 'no-cache' // Cegah caching
            });
            
            clearTimeout(timeoutId);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                localDataCache = {
                    kelurahan: result.data.kelurahan,
                    pegawai: result.data.pegawai
                };
                
                // Cek apakah ada draft yang lebih baru
                const draft = localStorage.getItem(`draft_${currentUser}`);
                if (draft) {
                    const draftData = JSON.parse(draft);
                    if (draftData.timestamp > (localDataCache.lastSaved || 0)) {
                        // Merge data
                        result.data.kelurahan = { ...result.data.kelurahan, ...draftData.kelurahan };
                    }
                }
                
                renderKelurahanData(result.data.kelurahan);
                renderPegawaiData(result.data.pegawai);
            } else {
                showToast('Gagal memuat data: ' + result.message, 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            if (error.name === 'AbortError') {
                showToast('Timeout: Server tidak merespon', 'error');
            } else {
                showToast('Gagal memuat data', 'error');
            }
            
            // Load dari cache jika offline
            if (localDataCache.kelurahan) {
                renderKelurahanData(localDataCache.kelurahan);
                renderPegawaiData(localDataCache.pegawai);
                showToast('Memuat data dari cache', 'info');
            }
        } finally {
            hideLoading();
        }
    }

    // Render kelurahan data
    function renderKelurahanData(data) {
        // Simpan nilai saat ini jika sedang diedit
        const inputs = document.querySelectorAll('#kelurahanInfo input, #kelurahanInfo textarea');
        inputs.forEach(input => {
            if (!input.disabled) {
                // Jika sedang diedit, jangan timpa nilai
                return;
            }
        });

        document.getElementById('nama_kelurahan').value = data.nama_kelurahan || '';
        document.getElementById('alamat_kelurahan').value = data.alamat_kelurahan || '';
        document.getElementById('rt').value = data.rt || '';
        document.getElementById('rw').value = data.rw || '';
        document.getElementById('kelurahan').value = data.kelurahan || '';
        document.getElementById('kecamatan').value = data.kecamatan || '';
        document.getElementById('kota').value = data.kota || '';
        document.getElementById('provinsi').value = data.provinsi || '';
        document.getElementById('kode_pos').value = data.kode_pos || '';
        document.getElementById('telp_kantor').value = data.telp_kantor || '';
        
        if (data.link_foto_kelurahan) {
            document.getElementById('kelurahanFoto').src = data.link_foto_kelurahan;
            document.getElementById('kelurahanFoto').style.display = 'block';
            document.getElementById('kelurahanFotoPlaceholder').style.display = 'none';
        }
    }

    // Toggle edit kelurahan dengan event prevention
    function toggleEditKelurahan(event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        isEditingKelurahan = !isEditingKelurahan;
        
        const inputs = document.querySelectorAll('#kelurahanInfo input, #kelurahanInfo textarea');
        inputs.forEach(input => input.disabled = !isEditingKelurahan);
        
        document.getElementById('editKelurahanBtn').style.display = isEditingKelurahan ? 'none' : 'block';
        document.getElementById('saveKelurahanBtn').style.display = isEditingKelurahan ? 'block' : 'none';
        document.getElementById('uploadKelurahanBtn').style.display = isEditingKelurahan ? 'block' : 'none';
    }

    // Toggle edit pegawai dengan event prevention
    function toggleEditPegawai(cardId, event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        const card = document.getElementById(cardId);
        const inputs = card.querySelectorAll('input');
        inputs.forEach(input => input.disabled = false);
        
        card.querySelector('.edit-btn').style.display = 'none';
        card.querySelector('.save-btn').style.display = 'block';
        card.querySelector('.cancel-btn').style.display = 'block';
        
        const uploadBtn = card.querySelector('.upload-btn');
        if (uploadBtn) uploadBtn.style.display = 'block';
    }

    // Cancel edit pegawai
    function cancelEditPegawai(cardId, event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        if (confirm('Batalkan perubahan?')) {
            loadUserData(); // Reload data
            // Hapus draft untuk card ini
            const draft = JSON.parse(localStorage.getItem(`draft_${currentUser}`) || '{}');
            if (draft.pegawai) {
                draft.pegawai = draft.pegawai.filter(p => p.id !== cardId);
                localStorage.setItem(`draft_${currentUser}`, JSON.stringify(draft));
            }
        }
    }

    // Save kelurahan data dengan event prevention
    async function saveKelurahan(event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        showLoading();
        
        try {
            const formData = new FormData();
            formData.append('action', 'saveKelurahan');
            formData.append('username', currentUser);
            formData.append('nama_kelurahan', document.getElementById('nama_kelurahan').value);
            formData.append('alamat_kelurahan', document.getElementById('alamat_kelurahan').value);
            formData.append('rt', document.getElementById('rt').value);
            formData.append('rw', document.getElementById('rw').value);
            formData.append('kelurahan', document.getElementById('kelurahan').value);
            formData.append('kecamatan', document.getElementById('kecamatan').value);
            formData.append('kota', document.getElementById('kota').value);
            formData.append('provinsi', document.getElementById('provinsi').value);
            formData.append('kode_pos', document.getElementById('kode_pos').value);
            formData.append('telp_kantor', document.getElementById('telp_kantor').value);
            
            const fotoKelurahan = document.getElementById('kelurahanFoto');
            if (fotoKelurahan && fotoKelurahan.src) {
                formData.append('link_foto_kelurahan', fotoKelurahan.src);
            }
            
            const response = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast('Data kelurahan berhasil disimpan');
                toggleEditKelurahan();
                
                // Hapus draft setelah sukses simpan
                const draft = JSON.parse(localStorage.getItem(`draft_${currentUser}`) || '{}');
                draft.kelurahan = {};
                localStorage.setItem(`draft_${currentUser}`, JSON.stringify(draft));
            } else {
                showToast('Gagal menyimpan: ' + result.message, 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Gagal menyimpan data', 'error');
        } finally {
            hideLoading();
        }
    }

    // Save pegawai data dengan event prevention
    async function savePegawai(cardId, event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        showLoading();
        
        try {
            const card = document.getElementById(cardId);
            const pegawaiId = cardId.split('-').pop();
            
            const formData = new FormData();
            formData.append('action', 'savePegawai');
            formData.append('username', currentUser);
            formData.append('pegawaiId', pegawaiId);
            formData.append('nama', card.querySelector('.pegawai-nama').value);
            formData.append('jabatan', card.querySelector('.pegawai-jabatan').value);
            formData.append('nip', card.querySelector('.pegawai-nip').value);
            formData.append('pangkat_gol', card.querySelector('.pegawai-pangkat').value);
            formData.append('no_hp', card.querySelector('.pegawai-nohp').value);
            
            const fotoImg = card.querySelector('.pegawai-foto img');
            if (fotoImg) {
                formData.append('foto', fotoImg.src);
            }
            
            const response = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast('Data pegawai berhasil disimpan');
                loadUserData(); // Reload data
                
                // Hapus draft untuk pegawai ini
                const draft = JSON.parse(localStorage.getItem(`draft_${currentUser}`) || '{}');
                if (draft.pegawai) {
                    draft.pegawai = draft.pegawai.filter(p => p.id !== cardId);
                    localStorage.setItem(`draft_${currentUser}`, JSON.stringify(draft));
                }
            } else {
                showToast('Gagal menyimpan: ' + result.message, 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Gagal menyimpan data', 'error');
        } finally {
            hideLoading();
        }
    }

    // Upload foto dengan event prevention
    function uploadFoto(type, target = null, event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        currentFotoType = type;
        currentFotoTarget = target;
        
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = handleFotoSelected;
        input.click();
    }

    // Handle foto selected
    function handleFotoSelected(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('cropperImage').src = e.target.result;
            document.getElementById('cropperModal').classList.add('active');
            
            setTimeout(() => {
                if (cropper) {
                    cropper.destroy();
                }
                
                const image = document.getElementById('cropperImage');
                cropper = new Cropper(image, {
                    aspectRatio: 4/5,
                    viewMode: 1,
                    dragMode: 'move',
                    autoCropArea: 1,
                    cropBoxMovable: true,
                    cropBoxResizable: true,
                    background: false
                });
            }, 100);
        };
        reader.readAsDataURL(file);
    }

    // Crop and upload
    async function cropAndUpload(event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        if (!cropper) return;
        
        showLoading();
        
        try {
            const canvas = cropper.getCroppedCanvas({
                width: 400,
                height: 500
            });
            
            const croppedImage = canvas.toDataURL('image/jpeg', 0.9);
            
            // Convert base64 to blob
            const block = croppedImage.split(';');
            const contentType = block[0].split(':')[1];
            const realData = block[1].split(',')[1];
            
            const formData = new FormData();
            formData.append('action', 'uploadFoto');
            formData.append('username', currentUser);
            formData.append('jenis', currentFotoType);
            formData.append('fotoData', realData);
            formData.append('contentType', contentType);
            
            const response = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                const thumbnailUrl = result.data.thumbnailUrl;
                
                if (currentFotoType === 'kelurahan') {
                    document.getElementById('kelurahanFoto').src = thumbnailUrl;
                    document.getElementById('kelurahanFoto').style.display = 'block';
                    document.getElementById('kelurahanFotoPlaceholder').style.display = 'none';
                    
                    // Simpan ke draft
                    const draft = JSON.parse(localStorage.getItem(`draft_${currentUser}`) || '{}');
                    if (!draft.kelurahan) draft.kelurahan = {};
                    draft.kelurahan.link_foto_kelurahan = thumbnailUrl;
                    localStorage.setItem(`draft_${currentUser}`, JSON.stringify(draft));
                    
                } else if (currentFotoType === 'pegawai' && currentFotoTarget) {
                    const fotoContainer = document.getElementById(`foto-${currentFotoTarget}`);
                    fotoContainer.innerHTML = `
                        <img src="${thumbnailUrl}" alt="Foto Pegawai">
                        <button class="upload-btn" onclick="uploadFoto('pegawai', '${currentFotoTarget}', event)">
                            <i class="fas fa-camera"></i>
                        </button>
                    `;
                }
                
                showToast('Foto berhasil diupload');
                closeCropper();
            } else {
                showToast('Gagal upload: ' + result.message, 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Gagal upload foto', 'error');
        } finally {
            hideLoading();
        }
    }

    // Close cropper
    function closeCropper(event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        document.getElementById('cropperModal').classList.remove('active');
        if (cropper) {
            cropper.destroy();
            cropper = null;
        }
    }

    // Add pegawai dengan event prevention
    function addPegawai(event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        if (pegawaiCount >= 30) {
            showToast('Maksimal 30 pegawai', 'error');
            return;
        }
        
        const cardId = `pegawai-new-${Date.now()}`;
        addPegawaiCard(null, cardId);
        toggleEditPegawai(cardId);
    }

    // Add pegawai card
    function addPegawaiCard(pegawai = null, cardId = null) {
        const grid = document.getElementById('pegawaiGrid');
        const id = cardId || (pegawai ? `pegawai-${pegawai.id}` : `pegawai-new-${Date.now()}`);
        const pegawaiData = pegawai || {
            id: pegawaiCount,
            nama: '',
            jabatan: '',
            nip: '',
            pangkat_gol: '',
            no_hp: '',
            foto: ''
        };
        
        const card = document.createElement('div');
        card.className = 'pegawai-card';
        card.id = id;
        card.innerHTML = `
            <div class="pegawai-header">
                <div class="pegawai-foto" id="foto-${id}">
                    ${pegawaiData.foto ? 
                        `<img src="${pegawaiData.foto}" alt="Foto Pegawai">` : 
                        `<div class="foto-placeholder">
                            <i class="fas fa-user"></i>
                        </div>`
                    }
                    <button class="upload-btn" onclick="uploadFoto('pegawai', '${id}', event)" style="display: none;">
                        <i class="fas fa-camera"></i>
                    </button>
                </div>
                <div class="pegawai-info">
                    <div class="pegawai-field">
                        <label>Nama</label>
                        <input type="text" class="pegawai-nama" value="${pegawaiData.nama}" disabled>
                    </div>
                </div>
            </div>
            
            <div class="pegawai-info" style="margin-top: 1rem;">
                <div class="pegawai-field">
                    <label>Jabatan</label>
                    <input type="text" class="pegawai-jabatan" value="${pegawaiData.jabatan}" disabled>
                </div>
                <div class="pegawai-field">
                    <label>NIP</label>
                    <input type="text" class="pegawai-nip" value="${pegawaiData.nip}" disabled>
                </div>
                <div class="pegawai-field">
                    <label>Pangkat/Gol</label>
                    <input type="text" class="pegawai-pangkat" value="${pegawaiData.pangkat_gol}" disabled>
                </div>
                <div class="pegawai-field">
                    <label>No. HP</label>
                    <input type="text" class="pegawai-nohp" value="${pegawaiData.no_hp}" disabled>
                </div>
            </div>
            
            <div class="card-actions">
                <button type="button" class="edit-btn" onclick="toggleEditPegawai('${id}', event)">
                    <i class="fas fa-edit"></i> Edit
                </button>
                <button type="button" class="save-btn" onclick="savePegawai('${id}', event)" style="display: none;">
                    <i class="fas fa-save"></i> Simpan
                </button>
                <button type="button" class="cancel-btn" onclick="cancelEditPegawai('${id}', event)" style="display: none;">
                    <i class="fas fa-times"></i> Batal
                </button>
            </div>
        `;
        
        grid.appendChild(card);
        
        if (!pegawai) {
            pegawaiCount++;
        }
    }

    // Logout dengan konfirmasi
    function handleLogout(event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        // Cek apakah ada draft yang belum disimpan
        const draft = localStorage.getItem(`draft_${currentUser}`);
        if (draft) {
            if (!confirm('Ada data yang belum disimpan. Yakin ingin logout?')) {
                return;
            }
        }
        
        // Bersihkan semua data
        if (autoSaveInterval) clearInterval(autoSaveInterval);
        localStorage.removeItem(`draft_${currentUser}`);
        sessionStorage.removeItem('isLoggedIn');
        sessionStorage.removeItem('username');
        
        window.location.href = LOGIN_PAGE_URL;
    }

    // Helper functions
    function showLoading() {
        document.getElementById('loadingOverlay').classList.add('active');
    }

    function hideLoading() {
        document.getElementById('loadingOverlay').classList.remove('active');
    }

    function showToast(message, type = 'success', duration = 3000) {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        const toastIcon = toast.querySelector('i');
        
        // Set icon based on type
        if (type === 'success') {
            toastIcon.className = 'fas fa-check-circle';
            toastIcon.style.color = '#84fab0';
        } else if (type === 'error') {
            toastIcon.className = 'fas fa-exclamation-circle';
            toastIcon.style.color = '#f5576c';
        } else if (type === 'warning') {
            toastIcon.className = 'fas fa-exclamation-triangle';
            toastIcon.style.color = '#ffa502';
        } else if (type === 'info') {
            toastIcon.className = 'fas fa-info-circle';
            toastIcon.style.color = '#4facfe';
        }
        
        toast.className = `toast ${type}`;
        toastMessage.textContent = message;
        toast.classList.add('show');
        
        setTimeout(() => {
            toast.classList.remove('show');
        }, duration);
    }

    // Bersihkan interval saat halaman ditutup
    window.addEventListener('beforeunload', function() {
        if (autoSaveInterval) {
            clearInterval(autoSaveInterval);
        }
    });

    // Hapus interval auto-refresh yang lama
    // setInterval(loadUserData, 30000); // HAPUS BARIS INI
</script>
</body>
</html>
