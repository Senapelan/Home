<script>
    // Konfigurasi - PASTIKAN URL INI BENAR
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyqLxwyMTmlPAAIpgENVO7vTVY-rtfHsZ_LzmZLovdTAesLGPBS_oj8ZgF8RmCKuNm2hQ/exec';
    const DRIVE_FOLDER_ID = '1E1qH_IJCG9vL8HqYSKtuDbON8_AjWD3-';
    
    // State
    let currentUser = null;
    let isEditModeKelurahan = false;
    let isEditModePegawai = false;
    let kelurahanData = {};
    let pegawaiData = [];

    // Field definitions
    const kelurahanFields = [
        { id: 'nama_kelurahan', label: 'Nama Kelurahan', type: 'text' },
        { id: 'alamat_kelurahan', label: 'Alamat Kelurahan', type: 'textarea' },
        { id: 'rt', label: 'RT', type: 'text' },
        { id: 'rw', label: 'RW', type: 'text' },
        { id: 'kelurahan', label: 'Kelurahan', type: 'text' },
        { id: 'kecamatan', label: 'Kecamatan', type: 'text' },
        { id: 'kota', label: 'Kota', type: 'text' },
        { id: 'provinsi', label: 'Provinsi', type: 'text' },
        { id: 'kode_pos', label: 'Kode Pos', type: 'text' },
        { id: 'telp_kantor', label: 'Telp. Kantor', type: 'tel' }
    ];

    const pegawaiFields = [
        { id: 'nama', label: 'Nama', type: 'text' },
        { id: 'jabatan', label: 'Jabatan', type: 'text' },
        { id: 'nip', label: 'NIP', type: 'text' },
        { id: 'pangkat_gol', label: 'Pangkat/Gol', type: 'text' },
        { id: 'no_hp', label: 'No. HP', type: 'tel' }
    ];

    // Inisialisasi
    window.onload = function() {
        checkAuth();
        renderKelurahanFields();
    };

    // Cek autentikasi
    function checkAuth() {
        const isLoggedIn = sessionStorage.getItem('isLoggedIn');
        const username = sessionStorage.getItem('username');
        
        if (!isLoggedIn || !username) {
            window.location.href = 'https://senapelan.github.io/Home/login/login.html';
            return;
        }
        
        currentUser = username;
        document.getElementById('userName').textContent = username;
        document.getElementById('userAvatar').textContent = username.charAt(0).toUpperCase();
        
        // Coba load dari cache dulu
        loadFromCache();
        
        // Then load from server
        loadUserData();
    }

    // Load dari cache
    function loadFromCache() {
        try {
            const cached = localStorage.getItem(`profile_${currentUser}`);
            if (cached) {
                const data = JSON.parse(cached);
                kelurahanData = data.kelurahan || {};
                pegawaiData = data.pegawai || [];
                renderKelurahanData();
                renderPegawaiData();
                console.log('Loaded from cache');
            }
        } catch (e) {
            console.error('Cache error:', e);
        }
    }

    // Save ke cache
    function saveToCache() {
        try {
            const data = {
                kelurahan: kelurahanData,
                pegawai: pegawaiData,
                timestamp: Date.now()
            };
            localStorage.setItem(`profile_${currentUser}`, JSON.stringify(data));
        } catch (e) {
            console.error('Cache save error:', e);
        }
    }

    // Load data user dari spreadsheet
    async function loadUserData() {
        showLoading(true);
        
        try {
            const response = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'loadData',
                    username: currentUser
                })
            });
            
            // Karena no-cors, kita tidak bisa membaca response
            // Tapi kita tahu request berhasil dikirim
            console.log('Load data request sent');
            
            // Untuk sementara, kita akan pakai data dari cache atau default
            if (Object.keys(kelurahanData).length === 0) {
                // Inisialisasi data default
                kelurahanFields.forEach(field => {
                    kelurahanData[field.id] = '';
                });
                kelurahanData.link_foto_kelurahan = '';
                pegawaiData = [];
            }
            
            renderKelurahanData();
            renderPegawaiData();
            
        } catch (error) {
            console.error('Error loading data:', error);
            showAlert('Gagal memuat data', 'error');
        } finally {
            showLoading(false);
        }
    }

    // Render fields kelurahan
    function renderKelurahanFields() {
        const container = document.getElementById('kelurahanFields');
        container.innerHTML = '';
        
        kelurahanFields.forEach(field => {
            const div = document.createElement('div');
            div.className = 'field-group';
            
            const label = document.createElement('label');
            label.htmlFor = field.id;
            label.textContent = field.label;
            
            let input;
            if (field.type === 'textarea') {
                input = document.createElement('textarea');
                input.rows = 3;
            } else {
                input = document.createElement('input');
                input.type = field.type;
            }
            
            input.id = field.id;
            input.name = field.id;
            input.readOnly = !isEditModeKelurahan;
            input.value = kelurahanData[field.id] || '';
            
            if (field.type === 'tel') {
                input.pattern = '[0-9]*';
            }
            
            div.appendChild(label);
            div.appendChild(input);
            container.appendChild(div);
        });
    }

    // Render data kelurahan
    function renderKelurahanData() {
        kelurahanFields.forEach(field => {
            const input = document.getElementById(field.id);
            if (input) {
                input.value = kelurahanData[field.id] || '';
                input.readOnly = !isEditModeKelurahan;
            }
        });
        
        // Update foto preview
        if (kelurahanData.link_foto_kelurahan) {
            document.getElementById('kelurahanPhotoPreview').src = kelurahanData.link_foto_kelurahan;
        } else {
            document.getElementById('kelurahanPhotoPreview').src = 'https://via.placeholder.com/400x500?text=Upload+Foto';
        }
        
        // Update tombol edit
        document.getElementById('editKelurahanText').textContent = isEditModeKelurahan ? 'Batal' : 'Edit Data';
        document.getElementById('simpanKelurahanBtn').style.display = isEditModeKelurahan ? 'block' : 'none';
    }

    // Render data pegawai
    function renderPegawaiData() {
        const grid = document.getElementById('pegawaiGrid');
        grid.innerHTML = '';
        
        if (pegawaiData.length === 0) {
            grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Belum ada data pegawai. Klik "Tambah Pegawai" untuk menambah.</div>';
        } else {
            pegawaiData.forEach((pegawai, index) => {
                const card = document.createElement('div');
                card.className = 'pegawai-card';
                
                let fields = '';
                pegawaiFields.forEach(field => {
                    fields += `
                        <div class="field-group">
                            <label>${field.label}</label>
                            <input type="${field.type}" id="pegawai_${index}_${field.id}" 
                                   value="${pegawai[field.id] || ''}" 
                                   ${isEditModePegawai ? '' : 'readonly'}>
                        </div>
                    `;
                });
                
                card.innerHTML = `
                    <div class="pegawai-header">
                        <div class="pegawai-photo" onclick="${isEditModePegawai ? `document.getElementById('pegawaiPhoto${index}').click()` : ''}">
                            <img src="${pegawai.link_foto || 'https://via.placeholder.com/80x100?text=Upload'}" alt="Foto">
                            <input type="file" id="pegawaiPhoto${index}" class="photo-upload" accept="image/*" onchange="handlePhotoUpload(this, 'pegawai', ${index})" ${isEditModePegawai ? '' : 'disabled'}>
                        </div>
                        <div class="pegawai-info">
                            ${fields}
                        </div>
                    </div>
                    <button class="btn-simpan" onclick="simpanDataPegawai(${index})" style="display: ${isEditModePegawai ? 'block' : 'none'};">
                        <i class="fas fa-save"></i> Simpan Data Pegawai
                    </button>
                `;
                grid.appendChild(card);
            });
        }
        
        // Update tombol edit dan tambah
        document.getElementById('editPegawaiText').textContent = isEditModePegawai ? 'Batal' : 'Edit Data';
        document.getElementById('tambahPegawaiBtn').style.display = (pegawaiData.length < 10 && isEditModePegawai) ? 'block' : 'none';
    }

    // Toggle edit mode kelurahan
    function toggleEditKelurahan() {
        isEditModeKelurahan = !isEditModeKelurahan;
        renderKelurahanData();
    }

    // Toggle edit mode pegawai
    function toggleEditPegawai() {
        isEditModePegawai = !isEditModePegawai;
        renderPegawaiData();
    }

    // Tambah pegawai
    function tambahPegawai() {
        if (pegawaiData.length >= 10) {
            showAlert('Maksimal 10 pegawai', 'error');
            return;
        }
        
        const newPegawai = {
            nama: '',
            jabatan: '',
            nip: '',
            pangkat_gol: '',
            no_hp: '',
            link_foto: ''
        };
        
        pegawaiData.push(newPegawai);
        renderPegawaiData();
    }

    // Handle photo upload
    async function handlePhotoUpload(input, type, index = null) {
        const file = input.files[0];
        if (!file) return;
        
        // Validasi ukuran (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
            showAlert('Ukuran file maksimal 5MB', 'error');
            input.value = '';
            return;
        }
        
        // Validasi tipe file
        if (!file.type.startsWith('image/')) {
            showAlert('File harus berupa gambar', 'error');
            input.value = '';
            return;
        }
        
        showLoading(true);
        
        try {
            // Konversi ke base64
            const reader = new FileReader();
            
            const base64Data = await new Promise((resolve, reject) => {
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
            
            // Preview lokal dulu
            if (type === 'kelurahan') {
                document.getElementById('kelurahanPhotoPreview').src = base64Data;
            } else if (index !== null) {
                const img = document.querySelector(`#pegawaiPhoto${index}`).previousElementSibling;
                if (img) img.src = base64Data;
            }
            
            // Upload ke server
            const response = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'uploadPhoto',
                    file: base64Data,
                    filename: file.name,
                    type: type,
                    index: index,
                    username: currentUser
                })
            });
            
            console.log('Upload request sent');
            
            // Karena no-cors, kita asumsikan sukses
            // Simulasi link (kita tidak bisa dapat response)
            const dummyLink = `https://drive.google.com/thumbnail?id=dummy_${Date.now()}`;
            
            if (type === 'kelurahan') {
                kelurahanData.link_foto_kelurahan = dummyLink;
            } else if (index !== null && pegawaiData[index]) {
                pegawaiData[index].link_foto = dummyLink;
            }
            
            saveToCache();
            showAlert('Foto berhasil diupload', 'success');
            
        } catch (error) {
            console.error('Error uploading photo:', error);
            showAlert('Gagal upload foto', 'error');
            
            // Kembalikan preview ke foto lama
            if (type === 'kelurahan') {
                document.getElementById('kelurahanPhotoPreview').src = kelurahanData.link_foto_kelurahan || 'https://via.placeholder.com/400x500?text=Upload+Foto';
            } else if (index !== null) {
                const img = document.querySelector(`#pegawaiPhoto${index}`).previousElementSibling;
                if (img) {
                    img.src = pegawaiData[index]?.link_foto || 'https://via.placeholder.com/80x100?text=Upload';
                }
            }
        } finally {
            showLoading(false);
            input.value = '';
        }
    }

    // Simpan data kelurahan
    async function simpanDataKelurahan() {
        // Ambil data dari form
        kelurahanFields.forEach(field => {
            const input = document.getElementById(field.id);
            if (input) {
                kelurahanData[field.id] = input.value;
            }
        });
        
        showLoading(true);
        
        try {
            const response = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'saveKelurahan',
                    username: currentUser,
                    kelurahanData: kelurahanData
                })
            });
            
            console.log('Save kelurahan request sent');
            
            saveToCache();
            showAlert('Data kelurahan berhasil disimpan', 'success');
            isEditModeKelurahan = false;
            renderKelurahanData();
            
        } catch (error) {
            console.error('Error saving kelurahan:', error);
            showAlert('Gagal menyimpan data', 'error');
        } finally {
            showLoading(false);
        }
    }

    // Simpan data pegawai
    async function simpanDataPegawai(index) {
        // Ambil data dari form
        pegawaiFields.forEach(field => {
            const input = document.getElementById(`pegawai_${index}_${field.id}`);
            if (input && pegawaiData[index]) {
                pegawaiData[index][field.id] = input.value;
            }
        });
        
        showLoading(true);
        
        try {
            const response = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'savePegawai',
                    username: currentUser,
                    pegawaiData: pegawaiData
                })
            });
            
            console.log('Save pegawai request sent');
            
            saveToCache();
            showAlert('Data pegawai berhasil disimpan', 'success');
            
        } catch (error) {
            console.error('Error saving pegawai:', error);
            showAlert('Gagal menyimpan data', 'error');
        } finally {
            showLoading(false);
        }
    }

    // Handle logout
    function handleLogout() {
        sessionStorage.removeItem('isLoggedIn');
        sessionStorage.removeItem('username');
        window.location.href = 'https://senapelan.github.io/Home/login/login.html';
    }

    // Utility functions
    function showLoading(show) {
        document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    }

    function showAlert(message, type) {
        const existingAlerts = document.querySelectorAll('.alert');
        existingAlerts.forEach(alert => alert.remove());
        
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}`;
        document.body.appendChild(alert);
        
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 3000);
    }
</script>
