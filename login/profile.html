<script>
    // Konfigurasi - PASTIKAN URL INI BENAR
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw71K1RMN0ajM-umfxWearbWC5Ipudw0OnOs-8NGyPp2zl92thXm0DMgbLG990CQQPYaQ/exec';
    const DRIVE_FOLDER_ID = '1E1qH_IJCG9vL8HqYSKtuDbON8_AjWD3-';
    
    // State
    let currentUser = null;
    let isEditModeKelurahan = false;
    let isEditModePegawai = false;
    let kelurahanData = {};
    let pegawaiData = [];
    let activeUploads = 0; // Untuk tracking upload aktif

    // Field definitions
    const kelurahanFields = [
        { id: 'nama_kelurahan', label: 'Nama Kelurahan', type: 'text' },
        { id: 'alamat_kelurahan', label: 'Alamat Kelurahan', type: 'textarea' },
        { id: 'rt', label: 'RT', type: 'text' },
        { id: 'rw', label: 'RW', type: 'text' },
        { id: 'kelurahan', label: 'Kelurahan', type: 'text' },
        { id: 'kecamatan', label: 'Kecamatan', type: 'text' },
        { id: 'kota', label: 'Kota', type: 'text' },
        { id: 'provinsi', label: 'Provinsi', type: 'text' },
        { id: 'kode_pos', label: 'Kode Pos', type: 'text' },
        { id: 'telp_kantor', label: 'Telp. Kantor', type: 'tel' }
    ];

    const pegawaiFields = [
        { id: 'nama', label: 'Nama', type: 'text' },
        { id: 'jabatan', label: 'Jabatan', type: 'text' },
        { id: 'nip', label: 'NIP', type: 'text' },
        { id: 'pangkat_gol', label: 'Pangkat/Gol', type: 'text' },
        { id: 'no_hp', label: 'No. HP', type: 'tel' }
    ];

    // Inisialisasi
    window.onload = function() {
        checkAuth();
        renderKelurahanFields();
    };

    // Cek autentikasi
    function checkAuth() {
        const isLoggedIn = sessionStorage.getItem('isLoggedIn');
        const username = sessionStorage.getItem('username');
        
        if (!isLoggedIn || !username) {
            window.location.href = 'https://senapelan.github.io/Home/login/login.html';
            return;
        }
        
        currentUser = username;
        document.getElementById('userName').textContent = username;
        document.getElementById('userAvatar').textContent = username.charAt(0).toUpperCase();
        
        // Coba load dari cache dulu
        loadFromCache();
        
        // Then load from server
        loadUserData();
    }

    // Load dari cache
    function loadFromCache() {
        try {
            const cached = localStorage.getItem(`profile_${currentUser}`);
            if (cached) {
                const data = JSON.parse(cached);
                kelurahanData = data.kelurahan || {};
                pegawaiData = data.pegawai || [];
                renderKelurahanData();
                renderPegawaiData();
                console.log('Loaded from cache');
            }
        } catch (e) {
            console.error('Cache error:', e);
        }
    }

    // Save ke cache
    function saveToCache() {
        try {
            const data = {
                kelurahan: kelurahanData,
                pegawai: pegawaiData,
                timestamp: Date.now()
            };
            localStorage.setItem(`profile_${currentUser}`, JSON.stringify(data));
        } catch (e) {
            console.error('Cache save error:', e);
        }
    }

    // Load data user dari spreadsheet
    async function loadUserData() {
        showLoading(true);
        
        try {
            // Gunakan JSONP untuk menghindari CORS
            const callbackName = 'jsonp_callback_' + Date.now();
            window[callbackName] = function(response) {
                try {
                    console.log('Data received:', response);
                    
                    if (response.success && response.data) {
                        kelurahanData = response.data.kelurahan || {};
                        pegawaiData = response.data.pegawai || [];
                        
                        // Inisialisasi data kosong untuk field yang tidak ada
                        kelurahanFields.forEach(field => {
                            if (!kelurahanData[field.id]) {
                                kelurahanData[field.id] = '';
                            }
                        });
                        if (!kelurahanData.link_foto_kelurahan) {
                            kelurahanData.link_foto_kelurahan = '';
                        }
                        
                        // Save to cache
                        saveToCache();
                        
                        renderKelurahanData();
                        renderPegawaiData();
                    } else {
                        showAlert('Gagal memuat data: ' + response.message, 'error');
                    }
                } catch (e) {
                    console.error('Error processing response:', e);
                } finally {
                    showLoading(false);
                    delete window[callbackName];
                    document.body.removeChild(script);
                }
            };
            
            // Buat script element untuk JSONP
            const script = document.createElement('script');
            const url = new URL(APPS_SCRIPT_URL);
            url.searchParams.set('action', 'loadData');
            url.searchParams.set('username', currentUser);
            url.searchParams.set('callback', callbackName);
            
            script.src = url.toString();
            document.body.appendChild(script);
            
            // Timeout setelah 10 detik
            setTimeout(() => {
                if (window[callbackName]) {
                    window[callbackName]({ success: false, message: 'Timeout' });
                }
            }, 10000);
            
        } catch (error) {
            console.error('Error loading data:', error);
            showAlert('Gagal memuat data', 'error');
            showLoading(false);
        }
    }

    // Render fields kelurahan
    function renderKelurahanFields() {
        const container = document.getElementById('kelurahanFields');
        container.innerHTML = '';
        
        kelurahanFields.forEach(field => {
            const div = document.createElement('div');
            div.className = 'field-group';
            
            const label = document.createElement('label');
            label.htmlFor = field.id;
            label.textContent = field.label;
            
            let input;
            if (field.type === 'textarea') {
                input = document.createElement('textarea');
                input.rows = 3;
            } else {
                input = document.createElement('input');
                input.type = field.type;
            }
            
            input.id = field.id;
            input.name = field.id;
            input.readOnly = !isEditModeKelurahan;
            input.value = kelurahanData[field.id] || '';
            
            if (field.type === 'tel') {
                input.pattern = '[0-9]*';
            }
            
            div.appendChild(label);
            div.appendChild(input);
            container.appendChild(div);
        });
    }

    // Render data kelurahan
    function renderKelurahanData() {
        kelurahanFields.forEach(field => {
            const input = document.getElementById(field.id);
            if (input) {
                input.value = kelurahanData[field.id] || '';
                input.readOnly = !isEditModeKelurahan;
            }
        });
        
        // Update foto preview
        if (kelurahanData.link_foto_kelurahan) {
            document.getElementById('kelurahanPhotoPreview').src = kelurahanData.link_foto_kelurahan;
        } else {
            document.getElementById('kelurahanPhotoPreview').src = 'https://via.placeholder.com/400x500?text=Upload+Foto';
        }
        
        // Update tombol edit
        document.getElementById('editKelurahanText').textContent = isEditModeKelurahan ? 'Batal' : 'Edit Data';
        document.getElementById('simpanKelurahanBtn').style.display = isEditModeKelurahan ? 'block' : 'none';
    }

    // Render data pegawai
    function renderPegawaiData() {
        const grid = document.getElementById('pegawaiGrid');
        grid.innerHTML = '';
        
        if (pegawaiData.length === 0) {
            grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Belum ada data pegawai. Klik "Tambah Pegawai" untuk menambah.</div>';
        } else {
            pegawaiData.forEach((pegawai, index) => {
                const card = document.createElement('div');
                card.className = 'pegawai-card';
                
                let fields = '';
                pegawaiFields.forEach(field => {
                    fields += `
                        <div class="field-group">
                            <label>${field.label}</label>
                            <input type="${field.type}" id="pegawai_${index}_${field.id}" 
                                   value="${pegawai[field.id] || ''}" 
                                   ${isEditModePegawai ? '' : 'readonly'}>
                        </div>
                    `;
                });
                
                card.innerHTML = `
                    <div class="pegawai-header">
                        <div class="pegawai-photo" onclick="${isEditModePegawai ? `document.getElementById('pegawaiPhoto${index}').click()` : ''}">
                            <img src="${pegawai.link_foto || 'https://via.placeholder.com/80x100?text=Upload'}" alt="Foto">
                            <div class="photo-upload-progress" id="pegawaiPhotoProgress${index}" style="display: none;">
                                <div class="photo-upload-progress-bar" id="pegawaiPhotoProgressBar${index}"></div>
                            </div>
                            <div class="photo-upload-status" id="pegawaiPhotoStatus${index}" style="display: none;">Mengupload...</div>
                            <input type="file" id="pegawaiPhoto${index}" class="photo-upload" accept="image/*" onchange="handlePhotoUpload(this, 'pegawai', ${index})" ${isEditModePegawai ? '' : 'disabled'}>
                        </div>
                        <div class="pegawai-info">
                            ${fields}
                        </div>
                    </div>
                    <button class="btn-simpan" onclick="simpanDataPegawai(${index})" style="display: ${isEditModePegawai ? 'block' : 'none'};">
                        <i class="fas fa-save"></i> Simpan Data Pegawai
                    </button>
                `;
                grid.appendChild(card);
            });
        }
        
        // Update tombol edit dan tambah
        document.getElementById('editPegawaiText').textContent = isEditModePegawai ? 'Batal' : 'Edit Data';
        document.getElementById('tambahPegawaiBtn').style.display = (pegawaiData.length < 10 && isEditModePegawai) ? 'block' : 'none';
    }

    // Toggle edit mode kelurahan
    function toggleEditKelurahan() {
        isEditModeKelurahan = !isEditModeKelurahan;
        renderKelurahanData();
    }

    // Toggle edit mode pegawai
    function toggleEditPegawai() {
        isEditModePegawai = !isEditModePegawai;
        renderPegawaiData();
    }

    // Tambah pegawai
    function tambahPegawai() {
        if (pegawaiData.length >= 10) {
            showAlert('Maksimal 10 pegawai', 'error');
            return;
        }
        
        const newPegawai = {
            nama: '',
            jabatan: '',
            nip: '',
            pangkat_gol: '',
            no_hp: '',
            link_foto: ''
        };
        
        pegawaiData.push(newPegawai);
        renderPegawaiData();
    }

    // Fungsi untuk menampilkan progress upload
    function showUploadProgress(type, index = null, show = true) {
        let progressId, statusId, progressBarId;
        
        if (type === 'kelurahan') {
            progressId = 'kelurahanPhotoProgress';
            statusId = 'kelurahanPhotoStatus';
            progressBarId = 'kelurahanPhotoProgressBar';
        } else {
            progressId = `pegawaiPhotoProgress${index}`;
            statusId = `pegawaiPhotoStatus${index}`;
            progressBarId = `pegawaiPhotoProgressBar${index}`;
        }
        
        const progressEl = document.getElementById(progressId);
        const statusEl = document.getElementById(statusId);
        
        if (progressEl && statusEl) {
            if (show) {
                progressEl.style.display = 'block';
                statusEl.style.display = 'block';
                // Reset progress bar
                const progressBar = document.getElementById(progressBarId);
                if (progressBar) {
                    progressBar.style.width = '0%';
                }
            } else {
                progressEl.style.display = 'none';
                statusEl.style.display = 'none';
            }
        }
    }

    // Fungsi untuk update progress
    function updateUploadProgress(type, index = null, percent) {
        let progressBarId;
        
        if (type === 'kelurahan') {
            progressBarId = 'kelurahanPhotoProgressBar';
        } else {
            progressBarId = `pegawaiPhotoProgressBar${index}`;
        }
        
        const progressBar = document.getElementById(progressBarId);
        if (progressBar) {
            progressBar.style.width = percent + '%';
        }
    }

    // Handle photo upload dengan kompresi lebih agresif
    async function handlePhotoUpload(input, type, index = null) {
        const file = input.files[0];
        if (!file) return;
        
        // Validasi ukuran (max 2MB - diperkecil dari 5MB)
        if (file.size > 2 * 1024 * 1024) {
            showAlert('Ukuran file maksimal 2MB', 'error');
            return;
        }
        
        // Validasi tipe file
        if (!file.type.startsWith('image/')) {
            showAlert('File harus berupa gambar', 'error');
            return;
        }
        
        // Tampilkan progress
        showUploadProgress(type, index, true);
        updateUploadProgress(type, index, 10);
        
        // Nonaktifkan input selama upload
        input.disabled = true;
        activeUploads++;
        
        try {
            // Kompres gambar dengan kualitas lebih rendah
            updateUploadProgress(type, index, 20);
            const compressedFile = await compressImage(file, 0.5); // Kualitas 50%
            updateUploadProgress(type, index, 40);
            
            // Konversi ke base64
            const base64Data = await fileToBase64(compressedFile);
            updateUploadProgress(type, index, 50);
            
            // Preview lokal
            if (type === 'kelurahan') {
                document.getElementById('kelurahanPhotoPreview').src = base64Data;
            } else if (index !== null) {
                const img = document.querySelector(`#pegawaiPhoto${index}`).previousElementSibling;
                if (img && img.tagName === 'IMG') {
                    img.src = base64Data;
                }
            }
            
            updateUploadProgress(type, index, 60);
            
            // Upload menggunakan fetch dengan timeout lebih panjang
            await uploadWithFetch(base64Data, file.name, type, index);
            
            updateUploadProgress(type, index, 100);
            
            // Sembunyikan progress setelah selesai
            setTimeout(() => {
                showUploadProgress(type, index, false);
            }, 1000);
            
        } catch (error) {
            console.error('Error processing photo:', error);
            showAlert('Gagal upload foto: ' + error.message, 'error');
            showUploadProgress(type, index, false);
        } finally {
            input.disabled = false;
            activeUploads--;
            if (activeUploads === 0) {
                showLoading(false);
            }
        }
    }

    // Fungsi kompresi gambar dengan kualitas yang bisa diatur
    function compressImage(file, quality = 0.5) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                
                img.onload = () => {
                    // Hitung dimensi baru (max width/height 600px - diperkecil)
                    let width = img.width;
                    let height = img.height;
                    const maxSize = 600; // Diperkecil dari 800
                    
                    if (width > height && width > maxSize) {
                        height = Math.round((height * maxSize) / width);
                        width = maxSize;
                    } else if (height > maxSize) {
                        width = Math.round((width * maxSize) / height);
                        height = maxSize;
                    }
                    
                    // Buat canvas untuk kompresi
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Konversi ke blob dengan kualitas lebih rendah
                    canvas.toBlob((blob) => {
                        console.log(`Compressed from ${(file.size/1024).toFixed(2)}KB to ${(blob.size/1024).toFixed(2)}KB`);
                        resolve(blob);
                    }, 'image/jpeg', quality);
                };
                
                img.onerror = reject;
            };
            
            reader.onerror = reject;
        });
    }

    // Fungsi konversi file ke base64
    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
        });
    }

    // Upload menggunakan fetch dengan retry mechanism
    async function uploadWithFetch(base64Data, filename, type, index, retryCount = 3) {
        // Hapus prefix data URL
        let cleanBase64 = base64Data;
        if (cleanBase64.includes(',')) {
            cleanBase64 = cleanBase64.split(',')[1];
        }
        
        // Buat form data
        const formData = new FormData();
        formData.append('action', 'uploadPhoto');
        formData.append('file', cleanBase64);
        formData.append('filename', filename);
        formData.append('type', type);
        formData.append('index', index || '');
        formData.append('username', currentUser);
        
        let lastError;
        
        // Coba upload dengan retry
        for (let attempt = 1; attempt <= retryCount; attempt++) {
            try {
                updateUploadProgress(type, index, 60 + (attempt * 10));
                
                // Gunakan proxy untuk menghindari CORS dan timeout
                const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                const response = await fetch(proxyUrl + APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'action': 'uploadPhoto',
                        'file': cleanBase64,
                        'filename': filename,
                        'type': type,
                        'index': index || '',
                        'username': currentUser
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    // Update link foto di data
                    if (type === 'kelurahan') {
                        kelurahanData.link_foto_kelurahan = result.data.link;
                    } else if (index !== null && pegawaiData[index]) {
                        pegawaiData[index].link_foto = result.data.link;
                    }
                    
                    saveToCache();
                    showAlert('Foto berhasil diupload', 'success');
                    return result;
                } else {
                    throw new Error(result.message || 'Upload failed');
                }
                
            } catch (error) {
                console.log(`Attempt ${attempt} failed:`, error);
                lastError = error;
                
                if (attempt < retryCount) {
                    // Tunggu sebentar sebelum retry
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }
        }
        
        throw lastError || new Error('Upload failed after retries');
    }

    // Simpan data kelurahan
    async function simpanDataKelurahan() {
        // Ambil data dari form
        kelurahanFields.forEach(field => {
            const input = document.getElementById(field.id);
            if (input) {
                kelurahanData[field.id] = input.value;
            }
        });
        
        showLoading(true);
        
        // Simpan menggunakan JSONP
        const callbackName = 'save_kelurahan_callback_' + Date.now();
        window[callbackName] = function(response) {
            try {
                if (response.success) {
                    saveToCache();
                    showAlert('Data kelurahan berhasil disimpan', 'success');
                    isEditModeKelurahan = false;
                    renderKelurahanData();
                } else {
                    showAlert('Gagal menyimpan: ' + response.message, 'error');
                }
            } catch (e) {
                console.error('Save callback error:', e);
            } finally {
                showLoading(false);
                delete window[callbackName];
                document.body.removeChild(script);
            }
        };
        
        const script = document.createElement('script');
        const url = new URL(APPS_SCRIPT_URL);
        url.searchParams.set('action', 'saveKelurahan');
        url.searchParams.set('username', currentUser);
        url.searchParams.set('kelurahanData', JSON.stringify(kelurahanData));
        url.searchParams.set('callback', callbackName);
        
        script.src = url.toString();
        document.body.appendChild(script);
    }

    // Simpan data pegawai
    async function simpanDataPegawai(index) {
        // Ambil data dari form
        pegawaiFields.forEach(field => {
            const input = document.getElementById(`pegawai_${index}_${field.id}`);
            if (input && pegawaiData[index]) {
                pegawaiData[index][field.id] = input.value;
            }
        });
        
        showLoading(true);
        
        // Simpan menggunakan JSONP
        const callbackName = 'save_pegawai_callback_' + Date.now();
        window[callbackName] = function(response) {
            try {
                if (response.success) {
                    saveToCache();
                    showAlert('Data pegawai berhasil disimpan', 'success');
                } else {
                    showAlert('Gagal menyimpan: ' + response.message, 'error');
                }
            } catch (e) {
                console.error('Save callback error:', e);
            } finally {
                showLoading(false);
                delete window[callbackName];
                document.body.removeChild(script);
            }
        };
        
        const script = document.createElement('script');
        const url = new URL(APPS_SCRIPT_URL);
        url.searchParams.set('action', 'savePegawai');
        url.searchParams.set('username', currentUser);
        url.searchParams.set('pegawaiData', JSON.stringify(pegawaiData));
        url.searchParams.set('callback', callbackName);
        
        script.src = url.toString();
        document.body.appendChild(script);
    }

    // Handle logout
    function handleLogout() {
        sessionStorage.removeItem('isLoggedIn');
        sessionStorage.removeItem('username');
        window.location.href = 'https://senapelan.github.io/Home/login/login.html';
    }

    // Utility functions
    function showLoading(show) {
        // Hanya tampilkan jika tidak ada upload aktif
        if (activeUploads === 0 || !show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }
    }

    function showAlert(message, type) {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}`;
        document.body.appendChild(alert);
        
        setTimeout(() => {
            alert.remove();
        }, 3000);
    }
</script>
