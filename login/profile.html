<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil Kelurahan & Pegawai Â· Premium</title>
    <!-- Font & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:opsz@14..32&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Cropper.js untuk crop foto 4:5 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: #f4f6fa;
            padding: 24px 20px;
            display: flex;
            justify-content: center;
        }

        .dashboard {
            max-width: 1100px;
            width: 100%;
        }

        /* Header premium */
        .header-premium {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.75);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 16px 28px;
            border-radius: 48px;
            box-shadow: 0 8px 30px rgba(0,10,30,0.06);
            border: 1px solid rgba(255,255,255,0.6);
            margin-bottom: 36px;
        }

        .user-greeting {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
            font-size: 1.1rem;
            color: #1b2b42;
        }

        .user-greeting i {
            font-size: 1.6rem;
            color: #2a4e77;
        }

        .logout-btn {
            background: white;
            border: none;
            padding: 10px 24px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 0.95rem;
            color: #1e3a5f;
            box-shadow: 0 4px 12px rgba(0,32,64,0.08);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid rgba(0,0,0,0.02);
        }

        .logout-btn:hover {
            background: #f0f3f8;
            box-shadow: 0 8px 18px rgba(0,42,84,0.12);
        }

        /* Card utama */
        .card {
            background: #ffffffdd;
            backdrop-filter: blur(4px);
            border-radius: 36px;
            padding: 28px 32px;
            box-shadow: 0 20px 40px -12px rgba(0,20,50,0.15);
            border: 1px solid rgba(255,255,255,0.7);
            margin-bottom: 32px;
            transition: box-shadow 0.2s;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
        }

        .card-header h2 {
            font-weight: 600;
            font-size: 1.6rem;
            color: #14283c;
            letter-spacing: -0.02em;
        }

        .btn-outline {
            background: transparent;
            border: 1.5px solid #2f5e8a;
            color: #2f5e8a;
            padding: 10px 28px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: 0.15s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-outline i {
            font-size: 1rem;
        }

        .btn-outline:hover {
            background: #e7eef8;
        }

        .btn-solid {
            background: #1e3a5f;
            border: none;
            color: white;
            padding: 12px 32px;
            border-radius: 44px;
            font-weight: 600;
            box-shadow: 0 8px 16px #1e3a5f30;
            cursor: pointer;
            transition: 0.15s;
            border: 1px solid #ffffff20;
        }

        .btn-solid:hover {
            background: #143049;
            transform: scale(0.98);
            box-shadow: 0 4px 12px #1e3a5f40;
        }

        .btn-upload {
            background: #eef2f6;
            border: 1px dashed #6b8cae;
            border-radius: 60px;
            padding: 10px 18px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #1b3b58;
            transition: 0.1s;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-upload:hover {
            background: #e2e9f2;
        }

        /* Grid dua kolom dalam card kelurahan: foto kiri + info */
        .kelurahan-grid {
            display: flex;
            gap: 28px;
            flex-wrap: wrap;
        }

        .foto-col {
            flex: 0 0 160px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .foto-preview {
            width: 160px;
            height: 200px; /* 4:5 */
            border-radius: 24px;
            background: #eef2f6;
            object-fit: cover;
            box-shadow: 0 8px 18px rgba(0,0,0,0.05);
            border: 3px solid white;
        }

        .info-col {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px 24px;
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .field label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: #4e6e8c;
            font-weight: 600;
        }

        .field input, .field span {
            background: #f4f8fd;
            border: none;
            border-radius: 20px;
            padding: 12px 18px;
            font-size: 0.95rem;
            color: #14283c;
            border: 1px solid transparent;
            transition: 0.1s;
            width: 100%;
        }

        .field input:focus {
            outline: none;
            border-color: #2f5e8a;
            background: #ffffff;
        }

        .field input[readonly] {
            background: #f4f8fd;
            color: #2b4f6e;
            opacity: 0.8;
            border-color: transparent;
            pointer-events: none;
        }

        /* card pegawai individu */
        .pegawai-cards {
            display: flex;
            flex-direction: column;
            gap: 24px;
            margin-top: 20px;
        }

        .pegawai-item {
            background: #f1f5f9d9;
            backdrop-filter: blur(2px);
            border-radius: 28px;
            padding: 22px 26px;
            border: 1px solid #ffffff;
            transition: all 0.15s;
        }

        .pegawai-header-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .pegawai-foto-section {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .foto-pegawai-preview {
            width: 120px;
            height: 150px; /* 4:5 */
            border-radius: 20px;
            background: #dbe1e9;
            object-fit: cover;
            border: 3px solid white;
            box-shadow: 0 6px 14px rgba(0,0,0,0.02);
        }

        .pegawai-fields {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 14px 18px;
        }

        .add-pegawai-card {
            background: #ffffffb0;
            border: 2px dashed #9fb8d0;
            border-radius: 40px;
            padding: 32px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: 0.2s;
            color: #1d3f60;
            font-weight: 600;
            gap: 8px;
            margin-top: 16px;
        }

        .add-pegawai-card:hover {
            background: #ffffff;
            border-color: #2f5e8a;
        }

        /* simpan per card */
        .action-footer {
            display: flex;
            justify-content: flex-end;
            margin-top: 24px;
        }

        .btn-simpan-card {
            background: white;
            border: 1px solid #cbd6e4;
            padding: 12px 32px;
            border-radius: 40px;
            font-weight: 600;
            color: #1a334b;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
            cursor: pointer;
            transition: 0.1s;
        }

        .btn-simpan-card i {
            margin-right: 6px;
            color: #2f5e8a;
        }

        .btn-simpan-card:hover {
            background: #e5ecf3;
            border-color: #8eacc9;
        }

        /* modal crop */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #00000080;
            backdrop-filter: blur(6px);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 40px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 40px 70px #00000030;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .crop-container {
            max-height: 400px;
        }

        img#crop-image {
            max-width: 100%;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
        }

        /* loading / small */
        .toast-notif {
            position: fixed; bottom: 24px; right: 24px;
            background: #1a334b; color: white; padding: 14px 28px; border-radius: 60px;
            box-shadow: 0 12px 30px #00000030; font-weight: 500;
            display: none; z-index: 2000;
        }
    </style>
</head>
<body>
<div class="dashboard">
    <!-- Header dinamis: username dan logout -->
    <div class="header-premium" id="header-section">
        <div class="user-greeting"><i class="fas fa-user-circle"></i> <span id="displayName">Memuat...</span></div>
        <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>

    <!-- CARD KELURAHAN -->
    <div class="card" id="cardKelurahan">
        <div class="card-header">
            <h2><i class="fas fa-city" style="margin-right: 12px; color:#2f5e8a;"></i> Profil Kelurahan</h2>
            <button class="btn-outline" id="editKelurahanBtn"><i class="fas fa-pen"></i> Edit data</button>
        </div>
        <div class="kelurahan-grid">
            <!-- Kolom foto -->
            <div class="foto-col">
                <img src="https://via.placeholder.com/160x200?text=Kantor" class="foto-preview" id="fotoKelurahanPreview" alt="foto kelurahan">
                <button class="btn-upload" id="uploadFotoKelurahan" disabled><i class="fas fa-cloud-upload-alt"></i> Upload 4:5</button>
                <input type="file" id="fileKelurahan" accept="image/*" style="display: none;">
            </div>
            <!-- kolom data -->
            <div class="info-col" id="kelurahanFields"></div>
        </div>
        <div class="action-footer">
            <button class="btn-simpan-card" id="simpanKelurahanBtn" disabled><i class="fas fa-save"></i> Simpan perubahan Kelurahan</button>
        </div>
    </div>

    <!-- CARD PEGAWAI (container dinamis) -->
    <div class="card" id="cardPegawai">
        <div class="card-header">
            <h2><i class="fas fa-users" style="margin-right: 12px; color:#2f5e8a;"></i> Data Pegawai</h2>
            <button class="btn-outline" id="editPegawaiBtn"><i class="fas fa-pen"></i> Edit semua</button>
        </div>
        <div id="pegawaiContainer" class="pegawai-cards"></div>
        <!-- tombol tambah card pegawai (max 10) -->
        <div class="add-pegawai-card" id="addPegawaiBtn" style="display: flex;">
            <i class="fas fa-plus-circle"></i> Tambah Pegawai (max 10)
        </div>
        <div class="action-footer" style="margin-top: 8px;">
            <button class="btn-simpan-card" id="simpanSemuaPegawaiBtn" disabled><i class="fas fa-save"></i> Simpan semua pegawai</button>
        </div>
    </div>
</div>

<!-- Modal Crop -->
<div class="modal" id="cropModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="font-weight:600;">Atur posisi foto (4:5)</h3>
            <button style="border:none; background:transparent; font-size:1.6rem;" id="closeModalBtn">&times;</button>
        </div>
        <div class="crop-container">
            <img id="crop-image" src="" alt="crop">
        </div>
        <div class="modal-footer">
            <button class="btn-outline" id="cancelCrop">Batal</button>
            <button class="btn-solid" id="applyCrop">Terapkan</button>
        </div>
    </div>
</div>

<div class="toast-notif" id="toast">Tersimpan</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script>
    (function() {
        // ---------- KONFIGURASI ----------
        const SPREADSHEET_ID = '1cgHQZoB_vm7R7EgnS4C_00h5buJooFX7fkz0FMjODgU';
        const DRIVE_FOLDER_ID = '1E1qH_IJCG9vL8HqYSKtuDbON8_AjWD3-';
        // user login (diambil dari localStorage, di-set oleh halaman login)
        let currentUser = localStorage.getItem('loggedInUser') || 'test_user'; 
        // Jika tidak ada, fallback ke 'guest' (supaya demo jalan)
        if (!localStorage.getItem('loggedInUser')) {
            currentUser = 'demo_user';
            localStorage.setItem('loggedInUser', 'demo_user');
        }

        // mode edit: view only default
        let isEditModeKelurahan = false;
        let isEditModePegawai = false;

        // Data utama (disimpan setelah load/simpan)
        let kelurahanData = {};
        let pegawaiList = []; // array hingga 10

        // Referensi element
        const displayNameSpan = document.getElementById('displayName');
        const logoutBtn = document.getElementById('logoutBtn');
        const editKelurahanBtn = document.getElementById('editKelurahanBtn');
        const editPegawaiBtn = document.getElementById('editPegawaiBtn');
        const simpanKelurahanBtn = document.getElementById('simpanKelurahanBtn');
        const simpanPegawaiBtn = document.getElementById('simpanSemuaPegawaiBtn');
        const addPegawaiDiv = document.getElementById('addPegawaiBtn');
        const kelurahanFieldsDiv = document.getElementById('kelurahanFields');
        const pegawaiContainer = document.getElementById('pegawaiContainer');
        const uploadKelurahanBtn = document.getElementById('uploadFotoKelurahan');
        const fileKelurahan = document.getElementById('fileKelurahan');
        const fotoKelurahanPreview = document.getElementById('fotoKelurahanPreview');

        // State crop
        let cropper;
        let activeCropResolve = null;
        let currentCropInputFile = null;
        let targetFieldKelurahan = false; // true jika kelurahan, false untuk pegawai index

        // Tampilkan nama user
        displayNameSpan.innerText = currentUser;

        // Logout
        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('loggedInUser');
            window.location.href = 'https://senapelan.github.io/Home/login/login.html';
        });

        // Load data dari spreadsheet via apps script web app (simulasi dengan fetch)
        // Untuk demo, kita buat fungsi loadFromSpreadsheet yang membaca sheet nama=currentUser
        async function loadUserData() {
            showToast('Memuat data...');
            try {
                // URL APPS SCRIPT WEBAPP (diganti dengan milik sendiri setelah deploy)
                // Di sini kita gunakan mock data dulu karena tidak bisa menyertakan Apps Script asli.
                // Implementasi asli: GET request ke apps script dengan parameter ?spreadsheetId=&sheetName=
                // Untuk contoh, kita set data kosong atau data dari localStorage sementara.
                const stored = localStorage.getItem(`profile_${currentUser}`);
                if (stored) {
                    const parsed = JSON.parse(stored);
                    kelurahanData = parsed.kelurahan || {};
                    pegawaiList = parsed.pegawai || [];
                } else {
                    // default kosong
                    kelurahanData = {};
                    pegawaiList = [];
                }
                // Pastikan panjang pegawai array sesuai (hingga 10)
                renderSemua();
            } catch (e) {
                console.warn('Gagal load, pakai default', e);
                kelurahanData = {};
                pegawaiList = [];
                renderSemua();
            }
            // Set mode view only
            setModeKelurahan(false);
            setModePegawai(false);
        }

        // Simpan ke spreadsheet (APPS script) dan localStorage lokal
        async function simpanKeSpreadsheet() {
            showToast('Menyimpan ke server...');
            // Di sini panggil Apps Script doPost dengan data kelurahanData & pegawaiList
            // Untuk demo cukup simpan di localStorage
            localStorage.setItem(`profile_${currentUser}`, JSON.stringify({
                kelurahan: kelurahanData,
                pegawai: pegawaiList
            }));
            // Tidak ada Apps Script live, tapi kita kirim bayangan
            // Seharusnya fetch ke endpoint dengan method POST, body JSON
            // Contoh:
            /*
            fetch('APPS_SCRIPT_URL', {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({spreadsheetId: SPREADSHEET_ID, sheetName: currentUser, data: {kelurahanData, pegawaiList}})
            });
            */
            showToast('Tersimpan (simulasi)');
        }

        // Render semua komponen
        function renderSemua() {
            renderKelurahanFields();
            renderPegawaiCards();
        }

        // Render fields kelurahan dari objek
        function renderKelurahanFields() {
            const fieldNames = [
                'nama_kelurahan','alamat_kelurahan','rt','rw','kelurahan','kecamatan',
                'kota','provinsi','kode_pos','telp_kantor'
            ];
            let html = '';
            fieldNames.forEach(f => {
                const label = f.replace(/_/g,' ').replace(/\b\w/g, l => l.toUpperCase());
                const value = kelurahanData[f] || '';
                html += `<div class="field"><label>${label}</label><input type="text" id="input_${f}" value="${escapeHtml(value)}" ${!isEditModeKelurahan ? 'readonly' : ''}></div>`;
            });
            kelurahanFieldsDiv.innerHTML = html;

            // foto preview
            if (kelurahanData.link_foto_kelurahan) {
                fotoKelurahanPreview.src = kelurahanData.link_foto_kelurahan;
            } else {
                fotoKelurahanPreview.src = 'https://via.placeholder.com/160x200?text=Kantor';
            }

            uploadKelurahanBtn.disabled = !isEditModeKelurahan;
            simpanKelurahanBtn.disabled = !isEditModeKelurahan;
        }

        function renderPegawaiCards() {
            if (!pegawaiList) pegawaiList = [];
            let containerHtml = '';
            pegawaiList.forEach((peg, idx) => {
                containerHtml += buatCardPegawai(idx, peg);
            });
            pegawaiContainer.innerHTML = containerHtml;

            // Attach listener untuk upload foto per pegawai, dan field input
            pegawaiList.forEach((_, idx) => {
                const uploadBtn = document.getElementById(`uploadPegawai_${idx}`);
                const fileInput = document.getElementById(`filePegawai_${idx}`);
                if (uploadBtn) {
                    uploadBtn.disabled = !isEditModePegawai;
                    uploadBtn.onclick = () => fileInput.click();
                }
                if (fileInput) {
                    fileInput.onchange = (e) => handlePegawaiFileSelect(e, idx);
                }
                // disable semua input jika readonly
                const fields = ['nama_pegawai','jabatan','nip','pangkat_gol','no_hp'];
                fields.forEach(f => {
                    const inp = document.getElementById(`peg_${idx}_${f}`);
                    if (inp) inp.readOnly = !isEditModePegawai;
                });
            });

            // tombol tambah pegawai hanya muncul jika <10 dan mode edit
            if (pegawaiList.length < 10 && isEditModePegawai) {
                addPegawaiDiv.style.display = 'flex';
            } else {
                addPegawaiDiv.style.display = 'none';
            }
            simpanPegawaiBtn.disabled = !isEditModePegawai;
        }

        function buatCardPegawai(idx, data) {
            const fotoLink = data.link_foto || `https://via.placeholder.com/120x150?text=Pegawai+${idx+1}`;
            return `
            <div class="pegawai-item" id="pegawaiCard_${idx}">
                <div class="pegawai-header-card">
                    <span style="font-weight:600; background:white; padding:4px 16px; border-radius:60px;">Pegawai ${idx+1}</span>
                </div>
                <div class="pegawai-foto-section">
                    <img src="${fotoLink}" class="foto-pegawai-preview" id="previewPegawai_${idx}">
                    <div style="display:flex; flex-direction:column; gap:8px;">
                        <button class="btn-upload" id="uploadPegawai_${idx}" ${!isEditModePegawai ? 'disabled' : ''}><i class="fas fa-camera"></i> Upload foto</button>
                        <input type="file" id="filePegawai_${idx}" accept="image/*" style="display:none;">
                    </div>
                    <div class="pegawai-fields">
                        <div class="field"><label>Nama</label><input type="text" id="peg_${idx}_nama_pegawai" value="${escapeHtml(data.nama_pegawai||'')}" ${!isEditModePegawai?'readonly':''}></div>
                        <div class="field"><label>Jabatan</label><input type="text" id="peg_${idx}_jabatan" value="${escapeHtml(data.jabatan||'')}" ${!isEditModePegawai?'readonly':''}></div>
                        <div class="field"><label>NIP</label><input type="text" id="peg_${idx}_nip" value="${escapeHtml(data.nip||'')}" ${!isEditModePegawai?'readonly':''}></div>
                        <div class="field"><label>Pangkat/Gol</label><input type="text" id="peg_${idx}_pangkat_gol" value="${escapeHtml(data.pangkat_gol||'')}" ${!isEditModePegawai?'readonly':''}></div>
                        <div class="field"><label>No HP</label><input type="text" id="peg_${idx}_no_hp" value="${escapeHtml(data.no_hp||'')}" ${!isEditModePegawai?'readonly':''}></div>
                    </div>
                </div>
            </div>`;
        }

        // helper escape
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe.replace(/[&<>"]/g, function(m) {
                if(m === '&') return '&amp;'; if(m === '<') return '&lt;'; if(m === '>') return '&gt;'; if(m === '"') return '&quot;';
                return m;
            });
        }

        // Mode Edit
        function setModeKelurahan(edit) {
            isEditModeKelurahan = edit;
            renderKelurahanFields();
            editKelurahanBtn.innerHTML = edit ? '<i class="fas fa-eye"></i> Selesai melihat' : '<i class="fas fa-pen"></i> Edit data';
        }

        function setModePegawai(edit) {
            isEditModePegawai = edit;
            renderPegawaiCards();
            editPegawaiBtn.innerHTML = edit ? '<i class="fas fa-eye"></i> Selesai melihat' : '<i class="fas fa-pen"></i> Edit semua';
        }

        // Event edit toggles
        editKelurahanBtn.addEventListener('click', () => {
            setModeKelurahan(!isEditModeKelurahan);
        });

        editPegawaiBtn.addEventListener('click', () => {
            setModePegawai(!isEditModePegawai);
        });

        // Simpan kelurahan
        simpanKelurahanBtn.addEventListener('click', async () => {
            // ambil data dari field
            const fieldNames = ['nama_kelurahan','alamat_kelurahan','rt','rw','kelurahan','kecamatan','kota','provinsi','kode_pos','telp_kantor'];
            fieldNames.forEach(f => {
                const el = document.getElementById(`input_${f}`);
                if (el) kelurahanData[f] = el.value;
            });
            // foto sudah diset via link_foto_kelurahan saat upload
            await simpanKeSpreadsheet();
            setModeKelurahan(false);
        });

        // Simpan semua pegawai
        simpanPegawaiBtn.addEventListener('click', async () => {
            for (let i = 0; i < pegawaiList.length; i++) {
                const base = pegawaiList[i] || {};
                pegawaiList[i] = {
                    nama_pegawai: document.getElementById(`peg_${i}_nama_pegawai`)?.value || '',
                    jabatan: document.getElementById(`peg_${i}_jabatan`)?.value || '',
                    nip: document.getElementById(`peg_${i}_nip`)?.value || '',
                    pangkat_gol: document.getElementById(`peg_${i}_pangkat_gol`)?.value || '',
                    no_hp: document.getElementById(`peg_${i}_no_hp`)?.value || '',
                    link_foto: base.link_foto // pertahankan
                };
            }
            await simpanKeSpreadsheet();
            setModePegawai(false);
        });

        // Tambah pegawai
        addPegawaiDiv.addEventListener('click', () => {
            if (pegawaiList.length < 10 && isEditModePegawai) {
                pegawaiList.push({});
                renderPegawaiCards();
            }
        });

        // Upload foto kelurahan
        uploadKelurahanBtn.addEventListener('click', () => {
            if (!isEditModeKelurahan) return;
            fileKelurahan.click();
        });

        fileKelurahan.addEventListener('change', (e) => {
            if (e.target.files.length) {
                openCropModal(URL.createObjectURL(e.target.files[0]), (croppedBlob) => {
                    // upload ke drive & dapatkan thumbnail link
                    uploadToDrive(croppedBlob).then(link => {
                        kelurahanData.link_foto_kelurahan = link;
                        fotoKelurahanPreview.src = link;
                        showToast('Foto kelurahan diperbarui');
                    }).catch(() => alert('Gagal upload'));
                });
            }
        });

        function handlePegawaiFileSelect(e, idx) {
            if (e.target.files.length) {
                openCropModal(URL.createObjectURL(e.target.files[0]), (croppedBlob) => {
                    uploadToDrive(croppedBlob).then(link => {
                        if (!pegawaiList[idx]) pegawaiList[idx] = {};
                        pegawaiList[idx].link_foto = link;
                        document.getElementById(`previewPegawai_${idx}`).src = link;
                        showToast('Foto pegawai diperbarui');
                    }).catch(() => alert('Gagal upload'));
                });
            }
        }

        // Modal crop logic
        function openCropModal(imageSrc, resolveCallback) {
            const modal = document.getElementById('cropModal');
            const img = document.getElementById('crop-image');
            img.src = imageSrc;
            modal.style.display = 'flex';
            if (cropper) cropper.destroy();
            cropper = new Cropper(img, {
                aspectRatio: 4/5,
                viewMode: 1,
                autoCropArea: 1,
                background: false,
            });
            activeCropResolve = resolveCallback;
        }

        document.getElementById('applyCrop').addEventListener('click', () => {
            if (cropper && activeCropResolve) {
                cropper.getCroppedCanvas().toBlob(blob => {
                    activeCropResolve(blob);
                    document.getElementById('cropModal').style.display = 'none';
                    cropper.destroy();
                });
            }
        });

        document.getElementById('cancelCrop').addEventListener('click', () => {
            document.getElementById('cropModal').style.display = 'none';
            if (cropper) cropper.destroy();
        });
        document.getElementById('closeModalBtn').addEventListener('click', () => {
            document.getElementById('cropModal').style.display = 'none';
            if (cropper) cropper.destroy();
        });

        // Simulasi upload ke drive (return dummy thumbnail)
        async function uploadToDrive(blob) {
            // Di sini seharusnya kirim ke Apps Script yang upload ke folder ID dan balikin link thumbnail.
            // Untuk simulasi, kembalikan object URL sementara
            return new Promise((res) => {
                const url = URL.createObjectURL(blob);
                // nanti di production ganti dengan link thumbnail dari drive
                setTimeout(() => res(url), 500);
            });
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 2000);
        }

        // init
        loadUserData();
    })();
</script>
</body>
</html>
